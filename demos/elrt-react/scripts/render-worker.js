!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?factory(exports):"function"==typeof define&&define.amd?define(["exports"],factory):factory(global.app=global.app||{})}(this,function(exports){"use strict";function zero(n){return Math.abs(n)<=EPSILON}function _equal(x,y){return Math.abs(x-y)<=EPSILON}function clamp(v,min,max){return min<max?Math.max(min,Math.min(v,max)):Math.max(max,Math.min(v,min))}function lerp(a,b,p){return a+p*(b-a)}function deg2rad(deg){return deg*Math.PI/180}function hexChannel(c){var ci=Math.round(255*clamp(c,0,1)),cs=ci.toString(16);return 1===cs.length?"0"+cs:cs}function blend(c1,c2,p){return new RGBA(lerp(c1.r,c2.r,p),lerp(c1.g,c2.g,p),lerp(c1.b,c2.b,p),lerp(c1.alpha(),c2.alpha(),p))}function compose(c1,c2){var alpha=c2.alpha();return new RGBA(lerp(c1.r,c2.r,alpha),lerp(c1.g,c2.g,alpha),lerp(c1.b,c2.b,alpha),clamp(c1.alpha()+alpha,0,1))}function multiply(c1,c2){return new RGBA(c1.r*c2.r,c1.g*c2.g,c1.b*c2.b,c1.alpha()*c2.alpha())}function translate2D(){var tx=void 0,ty=void 0;return 1===arguments.length?(tx=arguments[0][0],ty=arguments[0][1]):(tx=arguments[0],ty=arguments[1]),new Matrix_([1,0,tx],[0,1,ty],[0,0,1])}function scale2D(){var sx=void 0,sy=void 0;return 2===arguments.length?(sx=arguments[0],sy=arguments[1]):"number"==typeof arguments[0]?(sx=arguments[0],sy=arguments[0]):(sx=arguments[0][0],sy=arguments[0][1]),new Matrix_([sx,0,0],[0,sy,0],[0,0,1])}function rotate2D(theta){var s=Math.sin(theta),c=Math.cos(theta);return new Matrix_([c,-s,0],[s,c,0],[0,0,1])}function translate3D(){var tx=void 0,ty=void 0,tz=void 0;return 1===arguments.length?(tx=arguments[0][0],ty=arguments[0][1],tz=arguments[0][2]):(tx=arguments[0],ty=arguments[1],tz=arguments[2]),new Matrix_([1,0,0,tx],[0,1,0,ty],[0,0,1,tz],[0,0,0,1])}function scale3D(){var sx=void 0,sy=void 0,sz=void 0;return 3===arguments.length?(sx=arguments[0],sy=arguments[1],sz=arguments[2]):"number"==typeof arguments[0]?(sx=arguments[0],sy=arguments[0],sz=arguments[0]):(sx=arguments[0][0],sy=arguments[0][1],sz=arguments[0][2]),new Matrix_([sx,0,0,0],[0,sy,0,0],[0,0,sz,0],[0,0,0,1])}function rotate3DX(theta){var s=Math.sin(theta),c=Math.cos(theta);return new Matrix_([1,0,0,0],[0,c,s,0],[0,-s,c,0],[0,0,0,1])}function rotate3DY(theta){var s=Math.sin(theta),c=Math.cos(theta);return new Matrix_([c,0,-s,0],[0,1,0,0],[s,0,c,0],[0,0,0,1])}function rotate3DZ(theta){var s=Math.sin(theta),c=Math.cos(theta);return new Matrix_([c,s,0,0],[-s,c,0,0],[0,0,1,0],[0,0,0,1])}function rotate3DAxis(axis,theta){var a=axis.unit(),s=Math.sin(theta),c=Math.cos(theta),cc=1-c;return new Matrix_([a[0]*a[0]*cc+c,a[0]*a[1]*cc-a[2]*s,a[0]*a[2]*cc+a[1]*s,0],[a[0]*a[1]*cc+a[2]*s,a[1]*a[1]*cc+c,a[1]*a[2]*cc-a[0]*s,0],[a[0]*a[2]*cc-a[1]*s,a[1]*a[2]*cc+a[0]*s,a[2]*a[2]*cc+c,0],[0,0,0,1])}function VisibleObjectMixin(Base){return function(_Base){function _class(){_classCallCheck(this,_class);var _this2=_possibleConstructorReturn(this,Object.getPrototypeOf(_class).call(this));return _this2.material=null,_this2.t3d_anchor=null,_this2.casts_shadows=!0,_this2}return _inherits(_class,_Base),_createClass(_class,[{key:"closestIntersection",value:function(ray_world){var ints=this.intersections(ray_world);return ints.length>0?ints[0]:null}},{key:"intersections",value:function(ray_world){throw new AbstractMethodError}},{key:"intersects",value:function(ray_world){var max_distance=arguments.length<=1||void 0===arguments[1]?1/0:arguments[1],intersection=this.closestIntersection(ray_world);return null!==intersection&&intersection.getDistanceWorld()<=max_distance}},{key:"containsObject",value:function(pos_object){throw new AbstractMethodError}},{key:"containsWorld",value:function(pos_world){return this.containsObject(pos_world.transformPos(this.world_to_object))}},{key:"getMaterial",value:function(){return this.material?this.material:this.parent&&"function"==typeof this.parent.getMaterial?this.parent.getMaterial():null}},{key:"setMaterial",value:function(material){return this.material=material,this}},{key:"setT3DAnchorObject",value:function(object){return this.t3d_anchor=object,this}},{key:"getT3DAnchorObject",value:function(){if(this.t3d_anchor){for(var anchor=this.t3d_anchor;anchor&&anchor.t3d_anchor&&anchor!==anchor.t3d_anchor;)anchor=anchor.t3d_anchor;return anchor}for(var _anchor=this;!_anchor.material&&_anchor.parent.getMaterial;)_anchor=_anchor.parent;return _anchor}},{key:"objectToT3DAnchor",value:function(point){var anchor=this.getT3DAnchorObject();return anchor===this?point:point.transformPos(this.object_to_world).transformPos(anchor.world_to_object)}},{key:"uvAtPoint",value:function(point){throw new AbstractMethodError}},{key:"normalAtPoint",value:function(point){throw new AbstractMethodError}}]),_class}(Base)}function isVisibleObject(object){return object&&"function"==typeof object.closestIntersection}function all(predicate,iterable){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=iterable[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var item=_step.value;if(!predicate(item))return!1}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return!0}function isLight(object){return object&&"function"==typeof object.lightVectorLight}function regular(colours,blend,midpoint){return new Gradient(colours.map(function(colour,i){return[i/(colours.length-1),colour,blend,midpoint]}))}function sawtooth(t){return t-Math.floor(t)}function fade(t){return t*t*t*(t*(6*t-15)+10)}function grad(hash,x,y,z){var h=15&hash,u=h<8?x:y,v=h<4?y:12===h||14===h?x:z;return(0===(1&h)?u:-u)+(0===(2&h)?v:-v)}function getSceneById(id){var scene=scenesById[id];if(scene)return scene;throw new Error("Scene '"+id+"' not found in registry")}function isBigEndian(){if(void 0===_isBigEndian){var buffer=new ArrayBuffer(4),array8=new Uint8Array(buffer),array32=new Uint32Array(buffer);return array8[0]=18,array8[1]=52,array8[2]=86,array8[3]=120,_isBigEndian=305419896===array32[0]}return _isBigEndian}function pixel32LE(r,g,b,a){return r|g<<8|b<<16|a<<24}function pixel32BE(r,g,b,a){return r<<24|g<<16|b<<8|a}var _toConsumableArray=function(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)},_get=function get(object,property,receiver){null===object&&(object=Function.prototype);var desc=Object.getOwnPropertyDescriptor(object,property);if(void 0===desc){var parent=Object.getPrototypeOf(object);return null===parent?void 0:get(parent,property,receiver)}if("value"in desc)return desc.value;var getter=desc.get;if(void 0!==getter)return getter.call(receiver)},_classCallCheck=function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")},_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_possibleConstructorReturn=function(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call},_inherits=function(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)},_slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i.return&&_i.return()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),EPSILON=1e-10,RGB=function(){function RGB(r,g,b){_classCallCheck(this,RGB),this.r=r,this.g=g,this.b=b}return _createClass(RGB,[{key:"toString",value:function(){return"{RGB "+this.r.toPrecision(3)+", "+this.g.toPrecision(3)+", "+this.b.toPrecision(3)+"}"}},{key:"alpha",value:function(){return 1}},{key:"clamp",value:function(){return new RGB(clamp(this.r,0,1),clamp(this.g,0,1),clamp(this.b,0,1))}},{key:"transparent",value:function(alpha){return new RGBA(this.r,this.g,this.b,this.alpha()*alpha)}},{key:"htmlString",value:function(){return"#"+hexChannel(this.r)+hexChannel(this.g)+hexChannel(this.b)}}],[{key:"fromHtmlString",value:function(s){if("string"==typeof s){var match=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i.exec(s);if(match){var r=parseInt(match[1],16)/255,g=parseInt(match[2],16)/255,b=parseInt(match[3],16)/255;return new RGB(r,g,b)}throw new TypeError("RGB.fromHtmlString(): argument is not a valid HTML simple colour string")}throw new TypeError("RGB.fromHtmlString(): argument is not a string")}}]),RGB}(),RGBA=function(_RGB){function RGBA(r,g,b,a){_classCallCheck(this,RGBA);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(RGBA).call(this,r,g,b));return _this.a=a,_this}return _inherits(RGBA,_RGB),_createClass(RGBA,[{key:"toString",value:function(){return"{RGB "+this.r.toPrecision(3)+", "+this.g.toPrecision(3)+", "+this.b.toPrecision(3)+", "+this.a.toPrecision(3)+"}"}},{key:"alpha",value:function(){return this.a}},{key:"clamp",value:function(){return new RGBA(clamp(this.r,0,1),clamp(this.g,0,1),clamp(this.b,0,1),clamp(this.a,0,1))}}]),RGBA}(RGB),Black=new RGBA(0,0,0,1),White=new RGBA(1,1,1,1),AbstractMethodError=(new RGBA(1,0,0,1),new RGBA(0,1,0,1),new RGBA(0,0,1,1),new RGBA(0,1,1,1),new RGBA(1,0,1,1),new RGBA(1,1,0,1),new RGBA(0,0,0,0),new RGBA(1,1,1,0),function(_Error){function AbstractMethodError(message){_classCallCheck(this,AbstractMethodError);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(AbstractMethodError).call(this,message));return _this.message=message,_this.name="AbstractMethodError",_this}return _inherits(AbstractMethodError,_Error),AbstractMethodError}(Error)),Matrix_=function(){function Matrix(){if(_classCallCheck(this,Matrix),1===arguments.length&&"number"==typeof arguments[0]){this.rows=arguments[0],this.cols=arguments[0];for(var i=0;i<this.rows;i++)this[i]=new Array(this.cols)}else if(2===arguments.length&&"number"==typeof arguments[0]&&"number"==typeof arguments[1]){this.rows=arguments[0],this.cols=arguments[1];for(var _i=0;_i<this.rows;_i++)this[_i]=new Array(this.cols)}else if(1===arguments.length){this.rows=arguments[0].length,this.cols=arguments[0][0].length;for(var _i2=0;_i2<this.rows;_i2++){this[_i2]=new Array(this.cols);for(var j=0;j<this.cols;j++)this[_i2][j]=arguments[0][_i2][j]}}else{this.rows=arguments.length,this.cols=arguments[0].length;for(var _i3=0;_i3<this.rows;_i3++){this[_i3]=new Array(this.cols);for(var _j=0;_j<this.cols;_j++)this[_i3][_j]=arguments[_i3][_j]}}}return _createClass(Matrix,[{key:"toString",value:function(){for(var r="[",i=0;i<this.rows;i++){i>0&&(r+=" || ");for(var j=0;j<this.rows;j++)j>0&&(r+=", "),r+=this[i][j].toPrecision(3)}return r+="]"}},{key:"add",value:function(m2){return Matrix.add(this,m2)}},{key:"subtract",value:function(m2){return Matrix.subtract(this,m2)}},{key:"multiply",value:function(m2){return Matrix.multiply(this,m2)}},{key:"premultiply",value:function(m2){return Matrix.multiply(m2,this)}},{key:"scalarMul",value:function(s){return Matrix.scalarMul(s,this)}},{key:"transpose",value:function(){for(var r=new Matrix(this.cols,this.rows),i=0;i<this.rows;i++)for(var j=0;j<this.cols;j++)r[j][i]=this[i][j];return r}},{key:"isSquare",value:function(){return this.rows===this.cols}},{key:"determinant",value:function(){if(this.rows!==this.cols)throw new TypeError("Matrix.determinant: matrix is not square");if(2===this.rows)return this[0][0]*this[1][1]-this[0][1]*this[1][0];if(3===this.rows)return this[0][0]*this[1][1]*this[2][2]-this[0][0]*this[1][2]*this[2][1]-this[0][1]*this[1][0]*this[2][2]+this[0][1]*this[1][2]*this[2][0]+this[0][2]*this[1][0]*this[2][1]-this[0][2]*this[1][1]*this[2][0];if(4===this.rows)return this[0][0]*(this[1][1]*this[2][2]*this[3][3]+this[1][2]*this[2][3]*this[3][1]+this[1][3]*this[2][1]*this[3][2]-this[1][1]*this[2][3]*this[3][2]-this[1][2]*this[2][1]*this[3][3]-this[1][3]*this[2][2]*this[3][1])+this[0][1]*(this[1][0]*this[2][3]*this[3][2]+this[1][2]*this[2][0]*this[3][3]+this[1][3]*this[2][2]*this[3][0]-this[1][0]*this[2][2]*this[3][3]-this[1][2]*this[2][3]*this[3][0]-this[1][3]*this[2][0]*this[3][2])+this[0][2]*(this[1][0]*this[2][1]*this[3][3]+this[1][1]*this[2][3]*this[3][0]+this[1][3]*this[2][2]*this[3][0]-this[1][0]*this[2][3]*this[3][1]-this[1][1]*this[2][0]*this[3][3]-this[1][3]*this[2][1]*this[3][0])+this[0][3]*(this[1][0]*this[2][2]*this[3][1]+this[1][1]*this[2][0]*this[3][2]+this[1][2]*this[2][1]*this[3][0]-this[1][0]*this[2][1]*this[3][2]-this[1][1]*this[2][2]*this[3][0]-this[1][2]*this[2][0]*this[3][1]);throw new TypeError("Matrix.determinant: matrices larger than 4x4 not supported")}},{key:"isSingular",value:function(){return zero(this.determinant())}},{key:"inverse",value:function(){if(this.rows!==this.cols)throw new TypeError("Matrix.inverse: matrix is not square");var determinant=this.determinant();if(zero(determinant))throw new TypeError("Matrix.inverse: matrix is singular");var r=new Matrix(this.rows,this.cols);if(2===this.rows)r[0][0]=this[1][1],r[0][1]=-this[0][1],r[1][0]=-this[1][0],r[1][1]=this[0][0];else if(3===this.rows)r[0][0]=this[1][1]*this[2][2]-this[1][2]*this[2][1],r[0][1]=this[0][2]*this[2][1]-this[0][1]*this[2][2],r[0][2]=this[0][1]*this[1][2]-this[0][2]*this[1][1],r[1][0]=this[1][2]*this[2][0]-this[1][0]*this[2][2],r[1][1]=this[0][0]*this[2][2]-this[0][2]*this[2][0],r[1][2]=this[0][2]*this[1][0]-this[0][0]*this[1][2],r[2][0]=this[1][0]*this[2][1]-this[1][1]*this[2][0],r[2][1]=this[0][1]*this[2][0]-this[0][0]*this[2][1],r[2][2]=this[0][0]*this[1][1]-this[0][1]*this[1][0];else{if(4!==this.rows)throw new TypeError("Matrix.inverse: matrices larger than 4x4 not supported");r[0][0]=this[1][1]*(this[2][2]*this[3][3]-this[2][3]*this[3][2])+this[1][2]*(this[2][3]*this[3][1]-this[2][1]*this[3][3])+this[1][3]*(this[2][1]*this[3][2]-this[2][2]*this[3][1]),r[0][1]=this[0][1]*(this[2][3]*this[3][2]-this[2][2]*this[3][3])+this[0][2]*(this[2][1]*this[3][3]-this[2][3]*this[3][1])+this[0][3]*(this[2][2]*this[3][1]-this[2][1]*this[3][2]),r[0][2]=this[0][1]*(this[1][2]*this[3][3]-this[1][3]*this[3][2])+this[0][2]*(this[1][3]*this[3][1]-this[1][1]*this[3][3])+this[0][3]*(this[1][1]*this[3][2]-this[1][2]*this[3][1]),r[0][3]=this[0][1]*(this[1][3]*this[2][2]-this[1][2]*this[2][3])+this[0][2]*(this[1][1]*this[2][3]-this[1][3]*this[2][1])+this[0][3]*(this[1][2]*this[2][1]-this[1][1]*this[2][2]),r[1][0]=this[1][0]*(this[2][3]*this[3][2]-this[2][2]*this[3][3])+this[1][2]*(this[2][0]*this[3][3]-this[2][3]*this[3][0])+this[1][3]*(this[2][2]*this[3][0]-this[2][0]*this[3][2]),r[1][1]=this[0][0]*(this[2][2]*this[3][3]-this[2][3]*this[3][2])+this[0][2]*(this[2][3]*this[3][0]-this[2][0]*this[3][3])+this[0][3]*(this[2][0]*this[3][2]-this[2][2]*this[3][0]),r[1][2]=this[0][0]*(this[1][3]*this[3][2]-this[1][2]*this[3][3])+this[0][2]*(this[1][0]*this[3][3]-this[1][3]*this[3][0])+this[0][3]*(this[1][2]*this[3][0]-this[1][0]*this[3][2]),r[1][3]=this[0][0]*(this[1][2]*this[2][3]-this[1][3]*this[2][2])+this[0][2]*(this[1][3]*this[2][0]-this[1][0]*this[2][3])+this[0][3]*(this[1][0]*this[2][2]-this[1][2]*this[2][0]),r[2][0]=this[1][0]*(this[2][1]*this[3][3]-this[2][3]*this[3][1])+this[1][1]*(this[2][3]*this[3][0]-this[2][0]*this[3][3])+this[1][3]*(this[2][0]*this[3][1]-this[2][1]*this[3][0]),r[2][1]=this[0][0]*(this[2][3]*this[3][1]-this[2][1]*this[3][3])+this[0][1]*(this[2][0]*this[3][3]-this[2][3]*this[3][0])+this[0][3]*(this[2][1]*this[3][0]-this[2][0]*this[3][1]),r[2][2]=this[0][0]*(this[1][1]*this[3][3]-this[1][3]*this[3][1])+this[0][1]*(this[1][3]*this[3][0]-this[1][0]*this[3][3])+this[0][3]*(this[1][0]*this[3][1]-this[1][1]*this[3][0]),r[2][3]=this[0][0]*(this[1][3]*this[2][1]-this[1][1]*this[2][3])+this[0][1]*(this[1][0]*this[2][3]-this[1][3]*this[2][0])+this[0][3]*(this[1][1]*this[2][0]-this[1][0]*this[2][1]),r[3][0]=this[1][0]*(this[2][2]*this[3][1]-this[2][1]*this[3][2])+this[1][1]*(this[2][0]*this[3][2]-this[2][2]*this[3][0])+this[1][2]*(this[2][1]*this[3][0]-this[2][0]*this[3][1]),r[3][1]=this[0][0]*(this[2][1]*this[3][2]-this[2][2]*this[3][1])+this[0][1]*(this[2][2]*this[3][0]-this[2][0]*this[3][2])+this[0][2]*(this[2][0]*this[3][1]-this[2][1]*this[3][0]),r[3][2]=this[0][0]*(this[1][2]*this[3][1]-this[1][1]*this[3][2])+this[0][1]*(this[1][0]*this[3][2]-this[1][2]*this[3][0])+this[0][2]*(this[1][1]*this[3][0]-this[1][0]*this[3][1]),r[3][3]=this[0][0]*(this[1][1]*this[2][2]-this[1][2]*this[2][1])+this[0][1]*(this[1][2]*this[2][0]-this[1][0]*this[2][2])+this[0][2]*(this[1][0]*this[2][1]-this[1][1]*this[2][0])}for(var i=0;i<r.rows;i++)for(var j=0;j<r.cols;j++)r[i][j]/=determinant;return r}},{key:"serialise",value:function(){return Array.from(Object.assign({length:this.rows},this))}}],[{key:"add",value:function(m1,m2){if(m1.rows!==m2.rows||m1.cols!==m2.cols)throw new TypeError("Matrix.add: matrix size mismatch");for(var r=new Matrix(m1.rows,m1.cols),i=0;i<r.rows;i++)for(var j=0;j<r.cols;j++)r[i][j]=m1[i][j]+m2[i][j];return r}},{key:"subtract",value:function(m1,m2){if(m1.rows!==m2.rows||m1.cols!==m2.cols)throw new TypeError("Matrix.subtract: matrix size mismatch");for(var r=new Matrix(m1.rows,m1.cols),i=0;i<r.rows;i++)for(var j=0;j<r.cols;j++)r[i][j]=m1[i][j]-m2[i][j];return r}},{key:"multiply",value:function(m1,m2){if(m1.cols!==m2.rows)throw new TypeError("Matrix.multiply: matrix size mismatch");for(var r=new Matrix(m1.rows,m2.cols),i=0;i<m1.rows;i++)for(var j=0;j<m2.cols;j++){r[i][j]=0;for(var k=0;k<m1.cols;k++)r[i][j]+=m1[i][k]*m2[k][j]}return r}},{key:"scalarMul",value:function(s,m){for(var r=new Matrix(m.rows,m.cols),i=0;i<r.rows;i++)for(var j=0;j<r.cols;j++)r[i][j]=s*m[i][j];return r}},{key:"identity",value:function(size){for(var r=new Matrix(size),i=0;i<size;i++)for(var j=0;j<size;j++)r[i][j]=i===j?1:0;return r}},{key:"unserialise",value:function(serialised){if(Array.isArray(serialised))return new Matrix(serialised);throw new TypeError("Matrix.unserialise: serialised form must be an array")}}]),Matrix}(),Identity3=(Matrix_.identity(2),Matrix_.identity(3)),Identity4=Matrix_.identity(4),SceneObject=function(){function SceneObject(){_classCallCheck(this,SceneObject),this.parent=null,this.parent_to_object=Identity4,this.object_to_parent=Identity4,this.world_to_object=Identity4,this.object_to_world=Identity4,this.normal_object_to_parent=Identity4,this.normal_object_to_world=Identity4,this.name=null}return _createClass(SceneObject,[{key:"toString",value:function(){return this.name?"{{"+this.constructor.name+": "+this.name+"}}":"{{"+this.constructor.name+"}}"}},{key:"setName",value:function(name){return this.name=name,this}},{key:"setParent",value:function(parent){return this.parent=parent,this.updateWorldTransform(),this}},{key:"updateWorldTransform",value:function(){this.parent&&(this.world_to_object=this.parent_to_object.multiply(this.parent.world_to_object),this.object_to_world=this.world_to_object.inverse(),this.normal_object_to_parent=this.parent_to_object.transpose(),this.normal_object_to_world=this.world_to_object.transpose())}},{key:"resetTransform",value:function(){return this.parent_to_object=Identity4,this.object_to_parent=Identity4,this.updateWorldTransform(),this}},{key:"setTransform",value:function(matrix){return this.object_to_parent=matrix,this.parent_to_object=this.object_to_parent.inverse(),this.updateWorldTransform(),this}},{key:"transform",value:function(matrix){return this.object_to_parent=matrix.multiply(this.object_to_parent),this.parent_to_object=this.object_to_parent.inverse(),this.updateWorldTransform(),this}},{key:"translate",value:function(){return this.transform(translate3D.apply(void 0,arguments))}},{key:"scale",value:function(){return this.transform(scale3D.apply(void 0,arguments))}},{key:"rotateX",value:function(){return this.transform(rotate3DX.apply(void 0,arguments))}},{key:"rotateY",value:function(){return this.transform(rotate3DY.apply(void 0,arguments))}},{key:"rotateZ",value:function(){return this.transform(rotate3DZ.apply(void 0,arguments))}},{key:"rotateAxis",value:function(){return this.transform(rotate3DAxis.apply(void 0,arguments))}},{key:"rotateXDeg",value:function(angle){return this.rotateX(deg2rad(angle))}},{key:"rotateYDeg",value:function(angle){return this.rotateY(deg2rad(angle))}},{key:"rotateZDeg",value:function(angle){return this.rotateZ(deg2rad(angle))}},{key:"rotateAxisDeg",value:function(axis,angle){return this.rotateAxis(axis,deg2rad(angle))}}]),SceneObject}(),Group=function(_SceneObject){function Group(){_classCallCheck(this,Group);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(Group).call(this));return _this.children=[],_this}return _inherits(Group,_SceneObject),_createClass(Group,[{key:"add",value:function(obj){return this.children.push(obj),obj.setParent(this),this}},{key:"clear",value:function(){return this.children=[],this}},{key:"remove",value:function(obj){return this.children=this.children.filter(function(child){return child!==obj}),this}},{key:"find",value:function(predicate){var result=[];predicate(this)&&result.push(this);var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=this.children[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var child=_step.value;"function"==typeof child.find?result=result.concat(child.find(predicate)):predicate(child)&&result.push(child)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return result}},{key:"updateWorldTransform",value:function(){_get(Object.getPrototypeOf(Group.prototype),"updateWorldTransform",this).call(this);var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=this.children[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var child=_step2.value;child.updateWorldTransform()}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return this}}]),Group}(SceneObject),VisibleObject=function(_VisibleObjectMixin){function VisibleObject(){return _classCallCheck(this,VisibleObject),_possibleConstructorReturn(this,Object.getPrototypeOf(VisibleObject).apply(this,arguments))}return _inherits(VisibleObject,_VisibleObjectMixin),VisibleObject}(VisibleObjectMixin(SceneObject)),_regeneratorRuntime=function(module){return!function(global){function wrap(innerFn,outerFn,self,tryLocsList){var generator=Object.create((outerFn||Generator).prototype),context=new Context(tryLocsList||[]);return generator._invoke=makeInvokeMethod(innerFn,self,context),generator}function tryCatch(fn,obj,arg){try{return{type:"normal",arg:fn.call(obj,arg)}}catch(err){return{type:"throw",arg:err}}}function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}function defineIteratorMethods(prototype){["next","throw","return"].forEach(function(method){prototype[method]=function(arg){return this._invoke(method,arg)}})}function AwaitArgument(arg){this.arg=arg}function AsyncIterator(generator){function invoke(method,arg,resolve,reject){var record=tryCatch(generator[method],generator,arg);if("throw"!==record.type){var result=record.arg,value=result.value;return value instanceof AwaitArgument?Promise.resolve(value.arg).then(function(value){invoke("next",value,resolve,reject)},function(err){invoke("throw",err,resolve,reject)}):Promise.resolve(value).then(function(unwrapped){result.value=unwrapped,resolve(result)},reject)}reject(record.arg)}function enqueue(method,arg){function callInvokeWithMethodAndArg(){return new Promise(function(resolve,reject){invoke(method,arg,resolve,reject)})}return previousPromise=previousPromise?previousPromise.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}"object"==typeof process&&process.domain&&(invoke=process.domain.bind(invoke));var previousPromise;this._invoke=enqueue}function makeInvokeMethod(innerFn,self,context){var state=GenStateSuspendedStart;return function(method,arg){if(state===GenStateExecuting)throw new Error("Generator is already running");if(state===GenStateCompleted){if("throw"===method)throw arg;return doneResult()}for(;;){var delegate=context.delegate;if(delegate){if("return"===method||"throw"===method&&delegate.iterator[method]===undefined){context.delegate=null;var returnMethod=delegate.iterator.return;if(returnMethod){var record=tryCatch(returnMethod,delegate.iterator,arg);if("throw"===record.type){method="throw",arg=record.arg;continue}}if("return"===method)continue}var record=tryCatch(delegate.iterator[method],delegate.iterator,arg);if("throw"===record.type){context.delegate=null,method="throw",arg=record.arg;continue}method="next",arg=undefined;var info=record.arg;if(!info.done)return state=GenStateSuspendedYield,info;context[delegate.resultName]=info.value,context.next=delegate.nextLoc,context.delegate=null}if("next"===method)context.sent=context._sent=arg;else if("throw"===method){if(state===GenStateSuspendedStart)throw state=GenStateCompleted,arg;context.dispatchException(arg)&&(method="next",arg=undefined)}else"return"===method&&context.abrupt("return",arg);state=GenStateExecuting;var record=tryCatch(innerFn,self,context);if("normal"===record.type){state=context.done?GenStateCompleted:GenStateSuspendedYield;var info={value:record.arg,done:context.done};if(record.arg!==ContinueSentinel)return info;context.delegate&&"next"===method&&(arg=undefined)}else"throw"===record.type&&(state=GenStateCompleted,method="throw",arg=record.arg)}}}function pushTryEntry(locs){var entry={tryLoc:locs[0]};1 in locs&&(entry.catchLoc=locs[1]),2 in locs&&(entry.finallyLoc=locs[2],entry.afterLoc=locs[3]),this.tryEntries.push(entry)}function resetTryEntry(entry){var record=entry.completion||{};record.type="normal",delete record.arg,entry.completion=record}function Context(tryLocsList){this.tryEntries=[{tryLoc:"root"}],tryLocsList.forEach(pushTryEntry,this),this.reset(!0)}function values(iterable){if(iterable){var iteratorMethod=iterable[iteratorSymbol];if(iteratorMethod)return iteratorMethod.call(iterable);if("function"==typeof iterable.next)return iterable;if(!isNaN(iterable.length)){var i=-1,next=function next(){for(;++i<iterable.length;)if(hasOwn.call(iterable,i))return next.value=iterable[i],next.done=!1,next;return next.value=undefined,next.done=!0,next};return next.next=next}}return{next:doneResult}}function doneResult(){return{value:undefined,done:!0}}var undefined,hasOwn=Object.prototype.hasOwnProperty,$Symbol="function"==typeof Symbol?Symbol:{},iteratorSymbol=$Symbol.iterator||"@@iterator",toStringTagSymbol=$Symbol.toStringTag||"@@toStringTag",inModule="object"==typeof module,runtime=global.regeneratorRuntime;if(runtime)return void(inModule&&(module.exports=runtime));runtime=global.regeneratorRuntime=inModule?module.exports:{},runtime.wrap=wrap;var GenStateSuspendedStart="suspendedStart",GenStateSuspendedYield="suspendedYield",GenStateExecuting="executing",GenStateCompleted="completed",ContinueSentinel={},Gp=GeneratorFunctionPrototype.prototype=Generator.prototype;GeneratorFunction.prototype=Gp.constructor=GeneratorFunctionPrototype,GeneratorFunctionPrototype.constructor=GeneratorFunction,GeneratorFunctionPrototype[toStringTagSymbol]=GeneratorFunction.displayName="GeneratorFunction",runtime.isGeneratorFunction=function(genFun){var ctor="function"==typeof genFun&&genFun.constructor;return!!ctor&&(ctor===GeneratorFunction||"GeneratorFunction"===(ctor.displayName||ctor.name))},runtime.mark=function(genFun){return Object.setPrototypeOf?Object.setPrototypeOf(genFun,GeneratorFunctionPrototype):(genFun.__proto__=GeneratorFunctionPrototype,toStringTagSymbol in genFun||(genFun[toStringTagSymbol]="GeneratorFunction")),genFun.prototype=Object.create(Gp),genFun},runtime.awrap=function(arg){return new AwaitArgument(arg)},defineIteratorMethods(AsyncIterator.prototype),runtime.async=function(innerFn,outerFn,self,tryLocsList){var iter=new AsyncIterator(wrap(innerFn,outerFn,self,tryLocsList));return runtime.isGeneratorFunction(outerFn)?iter:iter.next().then(function(result){return result.done?result.value:iter.next()})},defineIteratorMethods(Gp),Gp[iteratorSymbol]=function(){return this},Gp[toStringTagSymbol]="Generator",Gp.toString=function(){return"[object Generator]"},runtime.keys=function(object){var keys=[];for(var key in object)keys.push(key);return keys.reverse(),function next(){for(;keys.length;){var key=keys.pop();if(key in object)return next.value=key,next.done=!1,next}return next.done=!0,next}},runtime.values=values,Context.prototype={constructor:Context,reset:function(skipTempReset){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.tryEntries.forEach(resetTryEntry),!skipTempReset)for(var name in this)"t"===name.charAt(0)&&hasOwn.call(this,name)&&!isNaN(+name.slice(1))&&(this[name]=undefined)},stop:function(){this.done=!0;var rootEntry=this.tryEntries[0],rootRecord=rootEntry.completion;if("throw"===rootRecord.type)throw rootRecord.arg;return this.rval},dispatchException:function(exception){function handle(loc,caught){return record.type="throw",record.arg=exception,context.next=loc,!!caught}if(this.done)throw exception;for(var context=this,i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i],record=entry.completion;if("root"===entry.tryLoc)return handle("end");if(entry.tryLoc<=this.prev){var hasCatch=hasOwn.call(entry,"catchLoc"),hasFinally=hasOwn.call(entry,"finallyLoc");if(hasCatch&&hasFinally){if(this.prev<entry.catchLoc)return handle(entry.catchLoc,!0);if(this.prev<entry.finallyLoc)return handle(entry.finallyLoc)}else if(hasCatch){if(this.prev<entry.catchLoc)return handle(entry.catchLoc,!0)}else{if(!hasFinally)throw new Error("try statement without catch or finally");if(this.prev<entry.finallyLoc)return handle(entry.finallyLoc)}}}},abrupt:function(type,arg){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc<=this.prev&&hasOwn.call(entry,"finallyLoc")&&this.prev<entry.finallyLoc){var finallyEntry=entry;break}}finallyEntry&&("break"===type||"continue"===type)&&finallyEntry.tryLoc<=arg&&arg<=finallyEntry.finallyLoc&&(finallyEntry=null);var record=finallyEntry?finallyEntry.completion:{};return record.type=type,record.arg=arg,finallyEntry?this.next=finallyEntry.finallyLoc:this.complete(record),ContinueSentinel},complete:function(record,afterLoc){if("throw"===record.type)throw record.arg;"break"===record.type||"continue"===record.type?this.next=record.arg:"return"===record.type?(this.rval=record.arg,this.next="end"):"normal"===record.type&&afterLoc&&(this.next=afterLoc)},finish:function(finallyLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.finallyLoc===finallyLoc)return this.complete(entry.completion,entry.afterLoc),
resetTryEntry(entry),ContinueSentinel}},catch:function(tryLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc===tryLoc){var record=entry.completion;if("throw"===record.type){var thrown=record.arg;resetTryEntry(entry)}return thrown}}throw new Error("illegal catch attempt")},delegateYield:function(iterable,resultName,nextLoc){return this.delegate={iterator:values(iterable),resultName:resultName,nextLoc:nextLoc},ContinueSentinel}}}("object"==typeof global?global:"object"==typeof window?window:"object"==typeof self?self:this),module.exports}({exports:{}}),fconst=function(x){return function(){return x}},Vector_=function(){function Vector(init){if(_classCallCheck(this,Vector),"number"==typeof init)this.length=init;else{if(!Array.isArray(init))throw new TypeError("Vector: constructor argument must be a number or array");this.length=init.length;for(var i=0;i<this.length;i++)this[i]=init[i]}}return _createClass(Vector,[{key:"toString",value:function(){for(var r="[",i=0;i<this.length;i++)i>0&&(r+=", "),r+=this[i].toPrecision(3);return r+="]"}},{key:Symbol.iterator,value:_regeneratorRuntime.mark(function value(){var i;return _regeneratorRuntime.wrap(function(_context){for(;;)switch(_context.prev=_context.next){case 0:i=0;case 1:if(!(i<this.length)){_context.next=7;break}return _context.next=4,this[i];case 4:i++,_context.next=1;break;case 7:case"end":return _context.stop()}},value,this)})},{key:"zero",value:function(){return all(zero,this)}},{key:"equal",value:function(u){return Vector.equal(this,u)}},{key:"norm",value:function(){return Math.sqrt(this.normSquared())}},{key:"normSquared",value:function(){for(var r=0,i=0;i<this.length;i++)r+=this[i]*this[i];return r}},{key:"unit",value:function(){for(var r=new Vector(this.length),norm=this.norm(),i=0;i<r.length;i++)r[i]=this[i]/norm;return r}},{key:"add",value:function(u){return Vector.add(this,u)}},{key:"subtract",value:function(u){return Vector.subtract(this,u)}},{key:"scalarMul",value:function(s){return Vector.scalarMul(s,this)}},{key:"reverse",value:function(){return Vector.scalarMul(-1,this)}},{key:"dot",value:function(u){return Vector.dot(this,u)}},{key:"scalarProjection",value:function(u){return Vector.scalarProjection(this,u)}},{key:"vectorProjection",value:function(u){return Vector.vectorProjection(this,u)}},{key:"distance",value:function(u){return Vector.distance(this,u)}},{key:"parallel",value:function(u){return Vector.parallel(this,u)}},{key:"reflect",value:function(n){return this.subtract(n.scalarMul(2*this.dot(n)))}},{key:"matrixMul",value:function(m){if(this.length!==m.cols)throw new TypeError("Vector.matrixMul: size mismatch");for(var r=new Vector(m.rows),i=0;i<r.length;i++){r[i]=0;for(var j=0;j<this.length;j++)r[i]+=this[j]*m[i][j]}return r}},{key:"matrixMulExt",value:function(e,m){if(this.length+1!==m.cols)throw new TypeError("Vector.matrixMulExt: size mismatch");for(var r=new Vector(this.length),i=0;i<r.length;i++){r[i]=e*m[i][this.length];for(var j=0;j<this.length;j++)r[i]+=this[j]*m[i][j]}return r}},{key:"transformPos",value:function(m){return this.matrixMulExt(1,m)}},{key:"transformDir",value:function(m){return this.matrixMulExt(0,m)}},{key:"serialise",value:function(){return Array.from(this)}}],[{key:"equal",value:function(v1,v2){if(v1.length===v2.length){for(var i=0;i<v1.length;i++)if(!_equal(v1[i],v2[i]))return!1;return!0}return!1}},{key:"add",value:function(v1,v2){if(v1.length!==v2.length)throw new TypeError("Vector.add: vector length mismatch");for(var r=new Vector(v1.length),i=0;i<r.length;i++)r[i]=v1[i]+v2[i];return r}},{key:"subtract",value:function(v1,v2){if(v1.length!==v2.length)throw new TypeError("Vector.subtract: vector length mismatch");for(var r=new Vector(v1.length),i=0;i<r.length;i++)r[i]=v1[i]-v2[i];return r}},{key:"scalarMul",value:function(s,v){for(var r=new Vector(v.length),i=0;i<r.length;i++)r[i]=s*v[i];return r}},{key:"dot",value:function(v1,v2){if(v1.length!==v2.length)throw new TypeError("Vector.dot: vector length mismatch");for(var r=0,i=0;i<v1.length;i++)r+=v1[i]*v2[i];return r}},{key:"scalarProjection",value:function(u,v){return u.dot(v.unit())}},{key:"vectorProjection",value:function(u,v){var vUnit=v.unit();return vUnit.scalarMul(u.dot(vUnit))}},{key:"distance",value:function(v1,v2){if(v1.length!==v2.length)throw new TypeError("Vector.distance: vector length mismatch");for(var d2=0,i=0;i<v1.length;i++){var di=v2[i]-v1[i];d2+=di*di}return Math.sqrt(d2)}},{key:"parallel",value:function(u,v){var dot=u.unit().dot(v.unit());return _equal(dot,1)||_equal(dot,-1)}},{key:"unserialise",value:function(serialised){if(Array.isArray(serialised))return 2===serialised.length?new(Function.prototype.bind.apply(Vector2,[null].concat(_toConsumableArray(serialised)))):3===serialised.length?new(Function.prototype.bind.apply(Vector3,[null].concat(_toConsumableArray(serialised)))):new Vector(serialised);throw new TypeError("Vector.unserialise: serialised form must be an array")}}]),Vector}(),Vector2=function(_Vector){function Vector2(x,y){_classCallCheck(this,Vector2);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(Vector2).call(this,2));return _this[0]=x,_this[1]=y,_this}return _inherits(Vector2,_Vector),_createClass(Vector2,[{key:Symbol.iterator,value:_regeneratorRuntime.mark(function value(){return _regeneratorRuntime.wrap(function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return _context2.next=2,this[0];case 2:return _context2.next=4,this[1];case 4:case"end":return _context2.stop()}},value,this)})},{key:"zero",value:function(){return zero(this[0])&&zero(this[1])}},{key:"equal",value:function(u){return 2===u.length&&_equal(this[0],u[0])&&_equal(this[1],u[1])}},{key:"norm",value:function(){return Math.sqrt(this[0]*this[0]+this[1]*this[1])}},{key:"normSquared",value:function(){return this[0]*this[0]+this[1]*this[1]}},{key:"unit",value:function(){var norm=Math.sqrt(this[0]*this[0]+this[1]*this[1]);return new Vector2(this[0]/norm,this[1]/norm)}},{key:"add",value:function(u){return new Vector2(this[0]+u[0],this[1]+u[1])}},{key:"subtract",value:function(u){return new Vector2(this[0]-u[0],this[1]-u[1])}},{key:"scalarMul",value:function(s){return new Vector2(s*this[0],s*this[1])}},{key:"reverse",value:function(){return new Vector2((-this[0]),(-this[1]))}},{key:"dot",value:function(u){return this[0]*u[0]+this[1]*u[1]}},{key:"scalarProjection",value:function(u){var norm=Math.sqrt(u[0]*u[0]+u[1]*u[1]);return(this[0]*u[0]+this[1]*u[1])/norm}},{key:"vectorProjection",value:function(u){var s=(this[0]*u[0]+this[1]*u[1])/(u[0]*u[0]+u[1]*u[1]);return new Vector2(s*u[0],s*u[1])}},{key:"distance",value:function(u){var dx=this[0]-u[0],dy=this[1]-u[1];return Math.sqrt(dx*dx+dy*dy)}},{key:"reflect",value:function(n){var s=2*(this[0]*n[0]+this[1]*n[1]);return new Vector2(this[0]-s*n[0],this[1]-s*n[1])}},{key:"matrixMul",value:function(m){return new Vector2(this[0]*m[0][0]+this[1]*m[0][1],this[0]*m[1][0]+this[1]*m[1][1])}},{key:"transformPos",value:function(m){return new Vector2(this[0]*m[0][0]+this[1]*m[0][1]+m[0][2],this[0]*m[1][0]+this[1]*m[1][1]+m[1][2])}},{key:"transformDir",value:function(m){return new Vector2(this[0]*m[0][0]+this[1]*m[0][1],this[0]*m[1][0]+this[1]*m[1][1])}}]),Vector2}(Vector_),Vector3=function(_Vector2){function Vector3(x,y,z){_classCallCheck(this,Vector3);var _this2=_possibleConstructorReturn(this,Object.getPrototypeOf(Vector3).call(this,3));return _this2[0]=x,_this2[1]=y,_this2[2]=z,_this2}return _inherits(Vector3,_Vector2),_createClass(Vector3,[{key:Symbol.iterator,value:_regeneratorRuntime.mark(function value(){return _regeneratorRuntime.wrap(function(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:return _context3.next=2,this[0];case 2:return _context3.next=4,this[1];case 4:return _context3.next=6,this[2];case 6:case"end":return _context3.stop()}},value,this)})},{key:"zero",value:function(){return zero(this[0])&&zero(this[1])&&zero(this[2])}},{key:"equal",value:function(u){return 3===u.length&&_equal(this[0],u[0])&&_equal(this[1],u[1])&&_equal(this[2],u[2])}},{key:"norm",value:function(){return Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2])}},{key:"normSquared",value:function(){return this[0]*this[0]+this[1]*this[1]+this[2]*this[2]}},{key:"unit",value:function(){var norm=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]);return new Vector3(this[0]/norm,this[1]/norm,this[2]/norm)}},{key:"add",value:function(u){return new Vector3(this[0]+u[0],this[1]+u[1],this[2]+u[2])}},{key:"subtract",value:function(u){return new Vector3(this[0]-u[0],this[1]-u[1],this[2]-u[2])}},{key:"scalarMul",value:function(s){return new Vector3(s*this[0],s*this[1],s*this[2])}},{key:"reverse",value:function(){return new Vector3((-this[0]),(-this[1]),(-this[2]))}},{key:"dot",value:function(u){return this[0]*u[0]+this[1]*u[1]+this[2]*u[2]}},{key:"scalarProjection",value:function(u){var norm=Math.sqrt(u[0]*u[0]+u[1]*u[1]+u[2]*u[2]);return(this[0]*u[0]+this[1]*u[1]+this[2]*u[2])/norm}},{key:"vectorProjection",value:function(u){var s=(this[0]*u[0]+this[1]*u[1]+this[2]*u[2])/(u[0]*u[0]+u[1]*u[1]+u[2]*u[2]);return new Vector3(s*u[0],s*u[1],s*u[2])}},{key:"distance",value:function(u){var dx=this[0]-u[0],dy=this[1]-u[1],dz=this[2]-u[2];return Math.sqrt(dx*dx+dy*dy+dz*dz)}},{key:"reflect",value:function(n){var s=2*(this[0]*n[0]+this[1]*n[1]+this[2]*n[2]);return new Vector3(this[0]-s*n[0],this[1]-s*n[1],this[2]-s*n[2])}},{key:"matrixMul",value:function(m){return new Vector3(this[0]*m[0][0]+this[1]*m[0][1]+this[2]*m[0][2],this[0]*m[1][0]+this[1]*m[1][1]+this[2]*m[1][2],this[0]*m[2][0]+this[1]*m[2][1]+this[2]*m[2][2])}},{key:"transformPos",value:function(m){return new Vector3(this[0]*m[0][0]+this[1]*m[0][1]+this[2]*m[0][2]+m[0][3],this[0]*m[1][0]+this[1]*m[1][1]+this[2]*m[1][2]+m[1][3],this[0]*m[2][0]+this[1]*m[2][1]+this[2]*m[2][2]+m[2][3])}},{key:"transformDir",value:function(m){return new Vector3(this[0]*m[0][0]+this[1]*m[0][1]+this[2]*m[0][2],this[0]*m[1][0]+this[1]*m[1][1]+this[2]*m[1][2],this[0]*m[2][0]+this[1]*m[2][1]+this[2]*m[2][2])}},{key:"cross",value:function(u){return new Vector3(this[1]*u[2]-this[2]*u[1],this[2]*u[0]-this[0]*u[2],this[0]*u[1]-this[1]*u[0])}}],[{key:"cross",value:function(u,v){return new Vector3(u[1]*v[2]-u[2]*v[1],u[2]*v[0]-u[0]*v[2],u[0]*v[1]-u[1]*v[0])}}]),Vector3}(Vector_),Origin3D=new Vector3(0,0,0),XAxis3D=new Vector3(1,0,0),YAxis3D=new Vector3(0,1,0),Ray=(new Vector3(0,0,1),new Vector3((-1),0,0),new Vector3(0,(-1),0),new Vector3(0,0,(-1)),function(){function Ray(origin,direction){var gen=arguments.length<=2||void 0===arguments[2]?0:arguments[2];_classCallCheck(this,Ray),this.origin=origin,this.dir=direction,this.gen=gen}return _createClass(Ray,[{key:"toString",value:function(){return"{Ray "+this.origin+" → "+this.dir+"}"}},{key:"relative",value:function(v){return v.subtract(this.origin)}},{key:"normalise",value:function(){return new Ray(this.origin,this.dir.unit(),this.gen)}},{key:"transform",value:function(m){var o=this.origin,d=this.dir,to=new Vector3(o[0]*m[0][0]+o[1]*m[0][1]+o[2]*m[0][2]+m[0][3],o[0]*m[1][0]+o[1]*m[1][1]+o[2]*m[1][2]+m[1][3],o[0]*m[2][0]+o[1]*m[2][1]+o[2]*m[2][2]+m[2][3]),td=new Vector3(d[0]*m[0][0]+d[1]*m[0][1]+d[2]*m[0][2],d[0]*m[1][0]+d[1]*m[1][1]+d[2]*m[1][2],d[0]*m[2][0]+d[1]*m[2][1]+d[2]*m[2][2]);return new Ray(to,td,this.gen)}},{key:"point",value:function(t){var o=this.origin,d=this.dir;return new Vector3(o[0]+t*d[0],o[1]+t*d[1],o[2]+t*d[2])}},{key:"back",value:function(normal){return normal.dot(this.dir)>0}}]),Ray}());Ray.NEAR=.001,Ray.MAX_GENERATION=10;var Intersection=function(){function Intersection(ray_object,object,t){var pos_object=arguments.length<=3||void 0===arguments[3]?null:arguments[3],material=arguments.length<=4||void 0===arguments[4]?null:arguments[4],uv_object=arguments.length<=5||void 0===arguments[5]?null:arguments[5],normal_object=arguments.length<=6||void 0===arguments[6]?null:arguments[6];_classCallCheck(this,Intersection),this.ray_object=ray_object,this.object=object,this.t=t,this.pos_object=pos_object,this.material=material,this.uv_object=uv_object,this.normal_object=normal_object,this.distance_object=null,this.ray_world=null,this.distance_world=null,this.pos_world=null,this.normal_world=null,this.t3d_anchor=null,this.reflected_world=null,null!==this.normal_object&&this.ray_object.back(this.normal_object)&&(this.normal_object=this.normal_object.reverse())}return _createClass(Intersection,[{key:"toString",value:function(){return"{"+this.constructor.name+"}"}},{key:"getDistanceObject",value:function(){return null===this.distance_object&&(this.distance_object=this.t*this.ray_object.dir.norm()),this.distance_object}},{key:"getPosObject",value:function(){return null===this.pos_object&&(this.pos_object=this.ray_object.point(this.t)),this.pos_object}},{key:"getPosWorld",value:function(){return null===this.pos_world&&(this.pos_world=this.getPosObject().transformPos(this.object.object_to_world)),this.pos_world}},{key:"getRayWorld",value:function(){return null===this.ray_world&&(this.ray_world=this.ray_object.transform(this.object.object_to_world)),this.ray_world}},{key:"getDistanceWorld",value:function(){return null===this.distance_world&&(this.distance_world=this.t*this.getRayWorld().dir.norm()),this.distance_world}},{key:"getMaterial",value:function(){return null===this.material&&(this.material=this.object.getMaterial()),this.material}},{key:"getUVObject",value:function(){return null===this.uv_object&&(this.uv_object=this.object.uvAtPoint(this.getPosObject())),this.uv_object}},{key:"getT3DAnchor",value:function(){return null===this.t3d_anchor&&(this.t3d_anchor=this.object.objectToT3DAnchor(this.getPosObject())),this.t3d_anchor}},{key:"getNormalObject",value:function(){if(null===this.normal_object){var n=this.object.normalAtPoint(this.getPosObject());this.ray_object.back(n)&&(n=n.reverse()),this.normal_object=n}return this.normal_object}},{key:"getNormalWorld",value:function(){return null===this.normal_world&&(this.normal_world=this.getNormalObject().transformDir(this.object.normal_object_to_world).unit()),this.normal_world}},{key:"getReflectedWorld",value:function(){return null===this.reflected_world&&(this.reflected_world=this.getRayWorld().dir.unit().reflect(this.getNormalWorld())),this.reflected_world}},{key:"generation",value:function(){return this.ray_object.gen}}],[{key:"listInsert",value:function(intersection,list){for(var dist=intersection.getDistanceWorld(),res=[],inserted=!1,i=0;i<list.length;i++)!inserted&&dist<list[i].getDistanceWorld()&&(res.push(intersection),inserted=!0),res.push(list[i]);return inserted||res.push(intersection),res}},{key:"listMerge",value:function(list1,list2){for(var res=[],i=0,j=0;i<list1.length&&j<list2.length;)list1[i].getDistanceWorld()<=list2[j].getDistanceWorld()?res.push(list1[i++]):res.push(list2[j++]);for(;i<list1.length;)res.push(list1[i++]);for(;j<list2.length;)res.push(list2[j++]);return res}}]),Intersection}(),Light=function(_SceneObject){function Light(){return _classCallCheck(this,Light),_possibleConstructorReturn(this,Object.getPrototypeOf(Light).apply(this,arguments))}return _inherits(Light,_SceneObject),_createClass(Light,[{key:"lightVectorLight",value:function(point){throw new AbstractMethodError}},{key:"lightVectorWorld",value:function(point){return this.lightVectorLight(point).transformDir(this.object_to_world).unit()}},{key:"lightStrengthColourLight",value:function(point){throw new AbstractMethodError}},{key:"lightStrengthColourWorld",value:function(point){return this.lightStrengthColourLight(point.transformPos(this.world_to_object))}},{key:"shadowStrengthWorld",value:function(point,world){throw new AbstractMethodError}}]),Light}(SceneObject),UniformLight=function(_Light){function UniformLight(){var strength=arguments.length<=0||void 0===arguments[0]?1:arguments[0],colour=arguments.length<=1||void 0===arguments[1]?White:arguments[1];_classCallCheck(this,UniformLight);var _this2=_possibleConstructorReturn(this,Object.getPrototypeOf(UniformLight).call(this));return _this2.strength=strength,_this2.colour=colour,_this2}return _inherits(UniformLight,_Light),_createClass(UniformLight,[{key:"lightStrengthColourLight",value:function(point){return[this.strength,this.colour]}},{key:"lightStrengthColourWorld",value:function(point){return[this.strength,this.colour]}}]),UniformLight}(Light),DirectionalLight=(function(_UniformLight){function PointLight(position){var strength=arguments.length<=1||void 0===arguments[1]?1:arguments[1],colour=arguments.length<=2||void 0===arguments[2]?White:arguments[2];_classCallCheck(this,PointLight);var _this3=_possibleConstructorReturn(this,Object.getPrototypeOf(PointLight).call(this,strength,colour));return _this3.setPosition(position),_this3}return _inherits(PointLight,_UniformLight),_createClass(PointLight,[{key:"setPosition",value:function(pos){this.pos=pos,this.pos_world=pos?pos.transformPos(this.object_to_world):null}},{key:"updateWorldTransform",value:function(){_get(Object.getPrototypeOf(PointLight.prototype),"updateWorldTransform",this).call(this),this.pos_world=this.pos.transformPos(this.object_to_world)}},{key:"shadowStrengthWorld",value:function(point,world){var lvec=this.lightVectorWorld(point),lray=new Ray(point,lvec),distance=point.distance(this.pos_world),_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=world.visible[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var object=_step.value;if(object.casts_shadows&&object.intersects(lray,distance))return 1}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return 0}},{key:"lightVectorLight",value:function(point){return this.pos.subtract(point).unit()}}]),PointLight}(UniformLight),function(_UniformLight2){function DirectionalLight(direction){var strength=arguments.length<=1||void 0===arguments[1]?1:arguments[1],colour=arguments.length<=2||void 0===arguments[2]?White:arguments[2];_classCallCheck(this,DirectionalLight);var _this4=_possibleConstructorReturn(this,Object.getPrototypeOf(DirectionalLight).call(this,strength,colour));return _this4.setDirection(direction),_this4}return _inherits(DirectionalLight,_UniformLight2),_createClass(DirectionalLight,[{key:"setDirection",value:function(direction){this.direction=direction,this.light_vector=direction?direction.reverse().unit():null}},{key:"lightVectorLight",value:function(point){return this.light_vector}},{key:"shadowStrengthWorld",value:function(point,world){var lvec=this.lightVectorWorld(point),lray=new Ray(point,lvec),_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=world.visible[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var object=_step2.value;if(object.casts_shadows&&object.intersects(lray))return 1}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return 0}}]),DirectionalLight}(UniformLight)),Background=function(){function Background(){_classCallCheck(this,Background)}return _createClass(Background,[{key:"getColour",value:function(ray_world){throw new AbstractMethodError}}]),Background}(),SolidBackground=function(_Background){function SolidBackground(colour){_classCallCheck(this,SolidBackground);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(SolidBackground).call(this));return _this.background_colour=colour,_this}return _inherits(SolidBackground,_Background),_createClass(SolidBackground,[{key:"getColour",value:function(ray_world){return this.background_colour}}]),SolidBackground}(Background),ElevationGradientBackground=function(_Background2){function ElevationGradientBackground(gradient){_classCallCheck(this,ElevationGradientBackground);var _this2=_possibleConstructorReturn(this,Object.getPrototypeOf(ElevationGradientBackground).call(this));return _this2.gradient=gradient,_this2}return _inherits(ElevationGradientBackground,_Background2),_createClass(ElevationGradientBackground,[{key:"getColour",value:function(ray_world){var r=ray_world.dir.norm(),inclination=zero(r)?0:Math.acos(ray_world.dir[2]/r);return this.gradient.colour(inclination/Math.PI)}}]),ElevationGradientBackground}(Background),Atmosphere=(function(_Background3){function AngleBackground(colour){_classCallCheck(this,AngleBackground);var _this3=_possibleConstructorReturn(this,Object.getPrototypeOf(AngleBackground).call(this));return _this3.base_colour=colour,_this3}return _inherits(AngleBackground,_Background3),_createClass(AngleBackground,[{key:"getColour",value:function(ray_world){var dot=ray_world.dir[0]*ray_world.dir[0]+ray_world.dir[1]*ray_world.dir[1],ang=dot/ray_world.dir.normSquared();return new RGB(ang*this.base_colour.r,ang*this.base_colour.g,ang*this.base_colour.b)}}]),AngleBackground}(Background),function(){function Atmosphere(){_classCallCheck(this,Atmosphere)}return _createClass(Atmosphere,[{key:"toString",value:function(){return"{"+this.constructor.name+"}"}},{key:"adjustColour",value:function(colour,ray,t){throw new AbstractMethodError}}]),Atmosphere}()),TransformableAtmosphere=function(_Atmosphere){function TransformableAtmosphere(){_classCallCheck(this,TransformableAtmosphere);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(TransformableAtmosphere).call(this));return _this.atmosphere_to_world=Identity4,_this.world_to_atmosphere=Identity4,_this}return _inherits(TransformableAtmosphere,_Atmosphere),_createClass(TransformableAtmosphere,[{key:"adjustColour",value:function(colour,ray,t){var wdist=t*ray.dir.norm(),aray=ray.transform(this.world_to_atmosphere),adist=t*aray.dir.norm();return this.adjustColourAtmosphere(colour,aray,t,adist,wdist)}},{key:"adjustColourAtmosphere",value:function(colour,ray_atmosphere,t,distance_atmosphere,distance_world){throw new AbstractMethodError}},{key:"resetTransform",value:function(){return this.atmosphere_to_world=Identity4,this.world_to_atmosphere=Identity4,this}},{key:"setTransform",value:function(atmosphere_to_world){return this.atmosphere_to_world=atmosphere_to_world,this.world_to_atmosphere=this.atmosphere_to_world.inverse(),this}},{key:"transform",value:function(matrix){return this.atmosphere_to_world=matrix.multiply(this.atmosphere_to_world),this.world_to_atmosphere=this.atmosphere_to_world.inverse(),this}},{key:"translate",value:function(){return this.transform(translate3D.apply(void 0,arguments))}},{key:"scale",value:function(){return this.transform(scale3D.apply(void 0,arguments))}},{key:"rotateX",value:function(){return this.transform(rotate3DX.apply(void 0,arguments))}},{key:"rotateY",value:function(){return this.transform(rotate3DY.apply(void 0,arguments))}},{key:"rotateZ",value:function(){return this.transform(rotate3DZ.apply(void 0,arguments))}},{key:"rotateAxis",value:function(){return this.transform(rotate3DAxis.apply(void 0,arguments))}},{key:"rotateXDeg",value:function(angle){return this.rotateX(deg2rad(angle))}},{key:"rotateYDeg",value:function(angle){return this.rotateY(deg2rad(angle))}},{key:"rotateZDeg",value:function(angle){return this.rotateZ(deg2rad(angle))}},{key:"rotateAxisDeg",value:function(axis,angle){return this.rotateAxis(axis,deg2rad(angle))}}]),TransformableAtmosphere}(Atmosphere),EmptyAtmosphere=function(_Atmosphere2){function EmptyAtmosphere(){return _classCallCheck(this,EmptyAtmosphere),_possibleConstructorReturn(this,Object.getPrototypeOf(EmptyAtmosphere).apply(this,arguments))}return _inherits(EmptyAtmosphere,_Atmosphere2),_createClass(EmptyAtmosphere,[{key:"adjustColour",value:function(colour,ray,t){return colour}}]),EmptyAtmosphere}(Atmosphere),FoggyAtmosphere=function(_Atmosphere3){function FoggyAtmosphere(){return _classCallCheck(this,FoggyAtmosphere),_possibleConstructorReturn(this,Object.getPrototypeOf(FoggyAtmosphere).apply(this,arguments))}return _inherits(FoggyAtmosphere,_Atmosphere3),_createClass(FoggyAtmosphere,[{key:"adjustColour",value:function(colour,ray,t){return compose(colour,this.fogColour(ray,t))}},{key:"fogColour",value:function(ray,t){throw new AbstractMethodError}}]),FoggyAtmosphere}(Atmosphere),FoggyTransformableAtmosphere=function(_TransformableAtmosph){function FoggyTransformableAtmosphere(){return _classCallCheck(this,FoggyTransformableAtmosphere),_possibleConstructorReturn(this,Object.getPrototypeOf(FoggyTransformableAtmosphere).apply(this,arguments))}return _inherits(FoggyTransformableAtmosphere,_TransformableAtmosph),_createClass(FoggyTransformableAtmosphere,[{key:"adjustColourAtmosphere",value:function(colour,ray_atmosphere,t,distance_atmosphere,distance_world){return compose(colour,this.fogColour(ray_atmosphere,t,distance_atmosphere,distance_world))}},{key:"fogColour",value:function(ray_atmosphere,t,distance_atmosphere,distance_world){throw new AbstractMethodError}}]),FoggyTransformableAtmosphere}(TransformableAtmosphere),World=(function(_FoggyAtmosphere){function ConstantFog(solid_distance){var colour=arguments.length<=1||void 0===arguments[1]?White:arguments[1];_classCallCheck(this,ConstantFog);var _this5=_possibleConstructorReturn(this,Object.getPrototypeOf(ConstantFog).call(this));return _this5.solid_distance=solid_distance,_this5.colour=colour,_this5}return _inherits(ConstantFog,_FoggyAtmosphere),_createClass(ConstantFog,[{key:"fogColour",value:function(ray,t){var strength=clamp(t/this.solid_distance,0,1);return this.colour.transparent(strength)}}]),ConstantFog}(FoggyAtmosphere),function(_FoggyTransformableAt){function LinearGradientFog(){var s0=arguments.length<=0||void 0===arguments[0]?1:arguments[0],s1=arguments.length<=1||void 0===arguments[1]?0:arguments[1],colour=arguments.length<=2||void 0===arguments[2]?White:arguments[2];_classCallCheck(this,LinearGradientFog);var _this6=_possibleConstructorReturn(this,Object.getPrototypeOf(LinearGradientFog).call(this));return _this6.s0=s0,_this6.s1=s1,_this6.colour=colour,_this6}return _inherits(LinearGradientFog,_FoggyTransformableAt),_createClass(LinearGradientFog,[{key:"fogColour",value:function(ray_atmosphere,t,distance_atmosphere,distance_world){var z_start=ray_atmosphere.origin[2],z_end=z_start+t*ray_atmosphere.dir[2],z1=Math.min(z_start,z_end),z2=Math.max(z_start,z_end),zd=z2-z1,t1z=Math.min(z2,0)-Math.min(z1,0),t1=this.s0*distance_world*(t1z/zd),t2z1=clamp(z1,0,1),t2z2=clamp(z2,0,1),t2z=t2z2-t2z1,t2=void 0;if(zero(t2z))t2=0;else{var t2s1=this.s0+t2z1*(this.s1-this.s0),t2s2=this.s0+t2z2*(this.s1-this.s0);t2=.5*(t2s1+t2s2)*distance_world*(t2z/zd)}var t3z=Math.max(z2,1)-Math.max(z1,1),t3=this.s1*distance_world*(t3z/zd),strength=t1+t2+t3;return this.colour.transparent(clamp(strength,0,1))}}]),LinearGradientFog}(FoggyTransformableAtmosphere),function(_Group){function World(){_classCallCheck(this,World);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(World).call(this));return _this.ambient_light_strength=.2,_this.ambient_light_colour=White,_this.background=new SolidBackground(Black),_this.atmosphere=new EmptyAtmosphere,_this.visible=[],_this.lights=[],_this}return _inherits(World,_Group),_createClass(World,[{key:"preRender",value:function(){this.visible=this.find(isVisibleObject),this.lights=this.find(isLight)}},{key:"render",value:function(drawable,camera){var _this2=this;this.preRender(),drawable.fill(function(px,py){var _drawable$cameraScree=drawable.cameraScreenCoords(px,py),_drawable$cameraScree2=_slicedToArray(_drawable$cameraScree,2),csx=_drawable$cameraScree2[0],csy=_drawable$cameraScree2[1];return _this2.rayColour(camera.worldRay(csx,csy))})}},{key:"getClosestIntersection",value:function(ray_world){var closest_int=null,closest_dist=1/0,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=this.visible[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var object=_step.value,intersection=object.closestIntersection(ray_world);if(intersection){var int_dist=intersection.getDistanceWorld();int_dist<closest_dist&&(closest_int=intersection,closest_dist=int_dist)}}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return closest_int}},{key:"getAllIntersections",value:function(ray_world){var intersections=[],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=this.visible[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var object=_step2.value;intersections=Intersection.listMerge(intersections,object.intersections(ray_world))}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return intersections}},{key:"rayColour",value:function(ray_world){var closest_int=this.getClosestIntersection(ray_world);if(closest_int){var colour=closest_int.getMaterial().getColour(closest_int,this);return this.atmosphere.adjustColour(colour,ray_world,closest_int.t)}var _colour=this.background.getColour(ray_world);return this.atmosphere.adjustColour(_colour,ray_world,1/0)}},{key:"lightsAtPoint",value:function(pos_world){var res=[],_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=this.lights[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var light=_step3.value,lvec=light.lightVectorWorld(pos_world),_light$lightStrengthC=light.lightStrengthColourWorld(pos_world),_light$lightStrengthC2=_slicedToArray(_light$lightStrengthC,2),strength=_light$lightStrengthC2[0],colour=_light$lightStrengthC2[1];zero(strength)||(strength*=1-light.shadowStrengthWorld(pos_world,this),zero(strength)||res.push([light,lvec,strength,colour]))}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}return res}}]),World}(Group)),ParametricScene=(function(){function Scene(){_classCallCheck(this,Scene),this.world=new World,this.name=null,this.anim_frame=0,this.anim_time=0,this.anim_default_time_step=1}return _createClass(Scene,[{key:"toString",value:function(){return this.name?"{"+this.constructor.name+": "+this.name+"}":"{"+this.constructor.name+"}"}},{key:"render",value:function(drawable,camera){this.world.render(drawable,camera)}},{key:"animate",value:function(frame,time,time_step){}},{key:"animInit",value:function(){var default_time_step=arguments.length<=0||void 0===arguments[0]?1:arguments[0];this.anim_frame=0,this.anim_time=0,this.anim_default_time_step=default_time_step,this.animate(0,0,this.anim_default_time_step)}},{key:"animateFrame",value:function(){var time_step=arguments.length<=0||void 0===arguments[0]?this.anim_default_time_step:arguments[0];this.anim_time+=time_step,this.animate(++this.anim_frame,this.anim_time,time_step)}}]),Scene}(),function(){function ParametricScene(){var params=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];_classCallCheck(this,ParametricScene),this.params=this.interpretParams(params),this.world=new World,this.cameras={},this.build(this.params)}return _createClass(ParametricScene,[{key:"build",value:function(params){}},{key:"interpretParams",value:function(paramsObject){return this.constructor.params().reduce(function(result,param){return result[param.id]=param.interpret(paramsObject[param.id]),result},{})}},{key:"render",value:function(drawable,cameraId){this.world.render(drawable,this.cameras[cameraId])}}],[{key:"label",value:function(){return this.name}},{key:"params",value:function(){return[];
}},{key:"cameras",value:function(){return[]}}]),ParametricScene}()),Param=function(){function Param(){var _ref=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],id=_ref.id,_ref$label=_ref.label,label=void 0===_ref$label?id:_ref$label,_ref$defaultValue=_ref.defaultValue,defaultValue=void 0===_ref$defaultValue?void 0:_ref$defaultValue;if(_classCallCheck(this,Param),void 0===id)throw new TypeError("Param: id must be provided");this.id=id,this.label=label,this.defaultValue=defaultValue}return _createClass(Param,[{key:"interpret",value:function(serialised){return void 0!==serialised?this.interpretValue(serialised):this.defaultValue}},{key:"interpretValue",value:function(serialised){return serialised}},{key:"defaultValueSerialised",value:function(){return this.defaultValue}}]),Param}(),ParamGroup=function(_Param){function ParamGroup(){var _ref2=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],id=_ref2.id,label=_ref2.label,_ref2$params=_ref2.params,params=void 0===_ref2$params?[]:_ref2$params;_classCallCheck(this,ParamGroup);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(ParamGroup).call(this,{id:id,label:label}));return _this.params=params,_this}return _inherits(ParamGroup,_Param),_createClass(ParamGroup,[{key:"interpret",value:function(){var serialised=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];if("object"==typeof serialised)return this.params.reduce(function(result,param){return result[param.id]=param.interpret(serialised[param.id]),result},{});throw new TypeError("ParamGroup: serialised value must be an object")}},{key:"defaultValueSerialised",value:function(){return this.params.reduce(function(result,param){return result[param.id]=param.defaultValueSerialised(),result},{})}}]),ParamGroup}(Param),Boolean=function(_Param){function Boolean(){var _ref=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],id=_ref.id,label=_ref.label,_ref$defaultValue=_ref.defaultValue,defaultValue=void 0!==_ref$defaultValue&&_ref$defaultValue;return _classCallCheck(this,Boolean),_possibleConstructorReturn(this,Object.getPrototypeOf(Boolean).call(this,{id:id,label:label,defaultValue:defaultValue}))}return _inherits(Boolean,_Param),_createClass(Boolean,[{key:"interpretValue",value:function(serialised){if("boolean"==typeof serialised)return serialised;throw new TypeError("$(this.constructor.name} parameter: value must be a boolean")}}]),Boolean}(Param),Choice=function(_Param2){function Choice(){var _ref2=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],id=_ref2.id,label=_ref2.label,_ref2$defaultValue=_ref2.defaultValue,defaultValue=void 0===_ref2$defaultValue?options[0].value:_ref2$defaultValue,_ref2$options=_ref2.options,options=void 0===_ref2$options?[]:_ref2$options;_classCallCheck(this,Choice);var _this2=_possibleConstructorReturn(this,Object.getPrototypeOf(Choice).call(this,{id:id,label:label,defaultValue:defaultValue}));return Object.assign(_this2,{options:options}),_this2}return _inherits(Choice,_Param2),Choice}(Param),Number=function(_Param3){function Number(){var _ref3=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],id=_ref3.id,label=_ref3.label,defaultValue=_ref3.defaultValue,_ref3$min=_ref3.min,min=void 0===_ref3$min?-(1/0):_ref3$min,_ref3$max=_ref3.max,max=void 0===_ref3$max?1/0:_ref3$max,_ref3$uiStep=_ref3.uiStep,uiStep=void 0===_ref3$uiStep?.01:_ref3$uiStep;_classCallCheck(this,Number);var _this3=_possibleConstructorReturn(this,Object.getPrototypeOf(Number).call(this,{id:id,label:label,defaultValue:defaultValue}));return Object.assign(_this3,{min:min,max:max,uiStep:uiStep}),_this3}return _inherits(Number,_Param3),_createClass(Number,[{key:"interpretValue",value:function(serialised){if("number"==typeof serialised)return clamp(serialised,this.min,this.max);throw new TypeError(this.constructor.name+" parameter: value must be a number")}}]),Number}(Param),Integer=function(_Number){function Integer(){var _ref4=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],id=_ref4.id,label=_ref4.label,defaultValue=_ref4.defaultValue,_ref4$min=_ref4.min,min=void 0===_ref4$min?-(1/0):_ref4$min,_ref4$max=_ref4.max,max=void 0===_ref4$max?1/0:_ref4$max,_ref4$uiStep=_ref4.uiStep,uiStep=void 0===_ref4$uiStep?1:_ref4$uiStep;return _classCallCheck(this,Integer),_possibleConstructorReturn(this,Object.getPrototypeOf(Integer).call(this,{id:id,label:label,defaultValue:defaultValue,min:min,max:max,uiStep:uiStep}))}return _inherits(Integer,_Number),_createClass(Integer,[{key:"interpretValue",value:function(serialised){if("number"==typeof serialised)return clamp(Math.round(serialised),this.min,this.max);throw new TypeError(this.constructor.name+" parameter: value must be a number")}}]),Integer}(Number),Angle=function(_Number2){function Angle(){var _ref5=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],id=_ref5.id,label=_ref5.label,defaultValue=_ref5.defaultValue,_ref5$min=_ref5.min,min=void 0===_ref5$min?-(1/0):_ref5$min,_ref5$max=_ref5.max,max=void 0===_ref5$max?1/0:_ref5$max,_ref5$uiStep=_ref5.uiStep,uiStep=void 0===_ref5$uiStep?deg2rad(uiStepDeg):_ref5$uiStep,_ref5$uiStepDeg=_ref5.uiStepDeg,uiStepDeg=void 0===_ref5$uiStepDeg?5:_ref5$uiStepDeg;_classCallCheck(this,Angle);var _this5=_possibleConstructorReturn(this,Object.getPrototypeOf(Angle).call(this,{id:id,label:label,defaultValue:defaultValue,min:min,max:max,uiStep:uiStep}));return Object.assign(_this5,{uiStepDeg:uiStepDeg}),_this5}return _inherits(Angle,_Number2),Angle}(Number),RGB$1=function(_Param4){function RGB$$(){return _classCallCheck(this,RGB$$),_possibleConstructorReturn(this,Object.getPrototypeOf(RGB$$).apply(this,arguments))}return _inherits(RGB$$,_Param4),_createClass(RGB$$,[{key:"interpretValue",value:function(serialised){return RGB.fromHtmlString(serialised)}},{key:"defaultValueSerialised",value:function(){return this.defaultValue.htmlString()}}]),RGB$$}(Param),Vector=function(_Param5){function Vector(){var _ref6=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],id=_ref6.id,label=_ref6.label,defaultValue=_ref6.defaultValue,_ref6$length=_ref6.length,length=void 0===_ref6$length?3:_ref6$length,_ref6$uiStep=_ref6.uiStep,uiStep=void 0===_ref6$uiStep?.01:_ref6$uiStep,uiElementLabels=_ref6.uiElementLabels;_classCallCheck(this,Vector);var _this7=_possibleConstructorReturn(this,Object.getPrototypeOf(Vector).call(this,{id:id,label:label,defaultValue:defaultValue}));return Object.assign(_this7,{length:length,uiStep:uiStep,uiElementLabels:uiElementLabels}),_this7}return _inherits(Vector,_Param5),_createClass(Vector,[{key:"interpretValue",value:function(serialised){if(Array.isArray(serialised)&&serialised.length===this.length)return Vector_.unserialise(serialised);throw new TypeError(this.constructor.name+" parameter: value must be an array of length "+this.length)}},{key:"defaultValueSerialised",value:function(){return this.defaultValue.serialise()}}]),Vector}(Param),Matrix=function(_Param6){function Matrix(){var _ref7=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],id=_ref7.id,label=_ref7.label,defaultValue=_ref7.defaultValue,_ref7$rows=_ref7.rows,rows=void 0===_ref7$rows?4:_ref7$rows,_ref7$cols=_ref7.cols,cols=void 0===_ref7$cols?4:_ref7$cols;_classCallCheck(this,Matrix);var _this8=_possibleConstructorReturn(this,Object.getPrototypeOf(Matrix).call(this,{id:id,label:label,defaultValue:defaultValue}));return Object.assign(_this8,{rows:rows,cols:cols}),_this8}return _inherits(Matrix,_Param6),_createClass(Matrix,[{key:"interpretValue",value:function(serialised){var _this9=this;if(Array.isArray(serialised)&&serialised.length===this.rows&&all(function(r){return Array.isArray(r)&&r.length===_this9.cols},serialised))return Matrix_.unserialise(serialised);throw new TypeError(this.constructor.name+" parameter: value must be a "+this.rows+"×"+this.cols+" 2D array")}},{key:"defaultValueSerialised",value:function(){return this.defaultValue.serialise()}}]),Matrix}(Param),Transform2D=function(_Matrix){function Transform2D(){var _ref8=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],id=_ref8.id,label=_ref8.label,_ref8$defaultValue=_ref8.defaultValue,defaultValue=void 0===_ref8$defaultValue?Identity3:_ref8$defaultValue,_ref8$uiRotate=_ref8.uiRotate,uiRotate=void 0===_ref8$uiRotate||_ref8$uiRotate,_ref8$uiTranslate=_ref8.uiTranslate,uiTranslate=void 0===_ref8$uiTranslate||_ref8$uiTranslate,_ref8$uiScaleUniform=_ref8.uiScaleUniform,uiScaleUniform=void 0===_ref8$uiScaleUniform||_ref8$uiScaleUniform,_ref8$uiScaleNonUnifo=_ref8.uiScaleNonUniform,uiScaleNonUniform=void 0===_ref8$uiScaleNonUnifo||_ref8$uiScaleNonUnifo,_ref8$uiInvertRotate=_ref8.uiInvertRotate,uiInvertRotate=void 0!==_ref8$uiInvertRotate&&_ref8$uiInvertRotate,_ref8$uiInvertTransla=_ref8.uiInvertTranslate,uiInvertTranslate=void 0!==_ref8$uiInvertTransla&&_ref8$uiInvertTransla,_ref8$uiInvertScale=_ref8.uiInvertScale,uiInvertScale=void 0!==_ref8$uiInvertScale&&_ref8$uiInvertScale;_classCallCheck(this,Transform2D);var _this10=_possibleConstructorReturn(this,Object.getPrototypeOf(Transform2D).call(this,{id:id,label:label,defaultValue:defaultValue,rows:3,cols:3}));return Object.assign(_this10,{uiRotate:uiRotate,uiTranslate:uiTranslate,uiScaleUniform:uiScaleUniform,uiScaleNonUniform:uiScaleNonUniform,uiInvertRotate:uiInvertRotate,uiInvertTranslate:uiInvertTranslate,uiInvertScale:uiInvertScale}),_this10}return _inherits(Transform2D,_Matrix),Transform2D}(Matrix),Transform3D=function(_Matrix2){function Transform3D(){var _ref9=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],id=_ref9.id,label=_ref9.label,_ref9$defaultValue=_ref9.defaultValue,defaultValue=void 0===_ref9$defaultValue?Identity4:_ref9$defaultValue,_ref9$uiRotate=_ref9.uiRotate,uiRotate=void 0===_ref9$uiRotate||_ref9$uiRotate,_ref9$uiTranslate=_ref9.uiTranslate,uiTranslate=void 0===_ref9$uiTranslate||_ref9$uiTranslate,_ref9$uiScaleUniform=_ref9.uiScaleUniform,uiScaleUniform=void 0===_ref9$uiScaleUniform||_ref9$uiScaleUniform,_ref9$uiScaleNonUnifo=_ref9.uiScaleNonUniform,uiScaleNonUniform=void 0===_ref9$uiScaleNonUnifo||_ref9$uiScaleNonUnifo,_ref9$uiInvertRotate=_ref9.uiInvertRotate,uiInvertRotate=void 0!==_ref9$uiInvertRotate&&_ref9$uiInvertRotate,_ref9$uiInvertTransla=_ref9.uiInvertTranslate,uiInvertTranslate=void 0!==_ref9$uiInvertTransla&&_ref9$uiInvertTransla,_ref9$uiInvertScale=_ref9.uiInvertScale,uiInvertScale=void 0!==_ref9$uiInvertScale&&_ref9$uiInvertScale;_classCallCheck(this,Transform3D);var _this11=_possibleConstructorReturn(this,Object.getPrototypeOf(Transform3D).call(this,{id:id,label:label,defaultValue:defaultValue,rows:4,cols:4}));return Object.assign(_this11,{uiRotate:uiRotate,uiTranslate:uiTranslate,uiScaleUniform:uiScaleUniform,uiScaleNonUniform:uiScaleNonUniform,uiInvertRotate:uiInvertRotate,uiInvertTranslate:uiInvertTranslate,uiInvertScale:uiInvertScale}),_this11}return _inherits(Transform3D,_Matrix2),Transform3D}(Matrix),RandomSeed=function(_Param7){function RandomSeed(){var _ref10=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],id=_ref10.id,label=_ref10.label,_ref10$defaultValue=_ref10.defaultValue,defaultValue=void 0===_ref10$defaultValue?null:_ref10$defaultValue;return _classCallCheck(this,RandomSeed),_possibleConstructorReturn(this,Object.getPrototypeOf(RandomSeed).call(this,{id:id,label:label,defaultValue:defaultValue}))}return _inherits(RandomSeed,_Param7),_createClass(RandomSeed,[{key:"interpretValue",value:function(serialised){if("number"==typeof serialised)return Math.round(serialised);if(null===serialised)return null;throw new TypeError("$(this.constructor.name} parameter: value must be a number or null")}}]),RandomSeed}(Param),Camera=function(_SceneObject){function Camera(){return _classCallCheck(this,Camera),_possibleConstructorReturn(this,Object.getPrototypeOf(Camera).apply(this,arguments))}return _inherits(Camera,_SceneObject),_createClass(Camera,[{key:"cameraRay",value:function(x,y){throw new AbstractMethodError}},{key:"worldRay",value:function(x,y){return this.cameraRay(x,y).transform(this.object_to_world).normalise()}}]),Camera}(SceneObject),PerspectiveCamera=function(_Camera){function PerspectiveCamera(view_angle){_classCallCheck(this,PerspectiveCamera);var _this2=_possibleConstructorReturn(this,Object.getPrototypeOf(PerspectiveCamera).call(this));return _this2.setViewAngle(view_angle),_this2}return _inherits(PerspectiveCamera,_Camera),_createClass(PerspectiveCamera,[{key:"setViewAngle",value:function(view_angle){this.view_angle=view_angle,this.view_plane_distance=1/Math.tan(view_angle/2)}},{key:"cameraRay",value:function(x,y){return new Ray(Origin3D,new Vector3(x,this.view_plane_distance,y))}}]),PerspectiveCamera}(Camera),OrthographicCamera=(function(_Group){function StereoCamera(separation,focus_distance,view_angle){_classCallCheck(this,StereoCamera);var _this3=_possibleConstructorReturn(this,Object.getPrototypeOf(StereoCamera).call(this));return _this3.separation=separation,_this3.focus_distance=focus_distance,_this3.left=new PerspectiveCamera(view_angle),_this3.right=new PerspectiveCamera(view_angle),_this3.updateCameras(),_this3.add(_this3.left),_this3.add(_this3.right),_this3}return _inherits(StereoCamera,_Group),_createClass(StereoCamera,[{key:"setSeparation",value:function(separation){this.separation=separation,this.updateCameras()}},{key:"setFocusDistance",value:function(focus_distance){this.focus_distance=focus_distance,this.updateCameras()}},{key:"updateCameras",value:function(){this.left.resetTransform(),this.left.rotateZ(Math.atan2(this.separation/2,this.focus_distance)),this.left.translate(-this.separation/2,0,0),this.right.resetTransform(),this.right.rotateZ(-Math.atan2(this.separation/2,this.focus_distance)),this.right.translate(this.separation/2,0,0)}}]),StereoCamera}(Group),function(_Camera2){function OrthographicCamera(view_size){_classCallCheck(this,OrthographicCamera);var _this4=_possibleConstructorReturn(this,Object.getPrototypeOf(OrthographicCamera).call(this));return _this4.view_size=view_size,_this4}return _inherits(OrthographicCamera,_Camera2),_createClass(OrthographicCamera,[{key:"cameraRay",value:function(x,y){return new Ray(new Vector3(x*this.view_size/2,0,y*this.view_size/2),this.constructor.RAY_DIR)}}]),OrthographicCamera}(Camera));OrthographicCamera.RAY_DIR=new Vector3(0,1,0);var SingleCameraParametricScene=function(_ParametricScene){function SingleCameraParametricScene(params){_classCallCheck(this,SingleCameraParametricScene);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(SingleCameraParametricScene).call(this,params));return _this.cameras.main=new PerspectiveCamera(_this.params.camera.view_angle).transform(_this.params.camera.transform),_this.initCamera(_this.cameras.main),_this}return _inherits(SingleCameraParametricScene,_ParametricScene),_createClass(SingleCameraParametricScene,[{key:"initCamera",value:function(camera){this.world.add(camera)}},{key:"render",value:function(drawable){_get(Object.getPrototypeOf(SingleCameraParametricScene.prototype),"render",this).call(this,drawable,"main")}}],[{key:"cameras",value:function(){return[{id:"main",label:"Main camera"}]}},{key:"params",value:function(){return[new ParamGroup({id:"camera",label:"Camera",params:[new Transform3D({id:"transform",label:"Transformation",uiRotate:!0,uiTranslate:!0,uiScaleUniform:!1,uiScaleNonUniform:!1,uiInvertRotate:!0}),new Angle({id:"view_angle",label:"Field of view",defaultValue:Math.PI/4,min:EPSILON,max:Math.PI/2})]})].concat(_toConsumableArray(_get(Object.getPrototypeOf(SingleCameraParametricScene),"params",this).call(this)))}}]),SingleCameraParametricScene}(ParametricScene),Spherical=function(){function Spherical(r,inclination,azimuth){_classCallCheck(this,Spherical),this.r=r,this.inclination=inclination,this.azimuth=azimuth}return _createClass(Spherical,[{key:"toString",value:function(){return"{Spherical "+this.r.toPrecision(3)+", "+this.inclination.toPrecision(3)+", "+this.azimuth.toPrecision(3)+"}"}},{key:"toCartesian",value:function(){var s=Math.sin(this.inclination);return new Vector3(this.r*Math.cos(this.azimuth)*s,this.r*Math.sin(this.azimuth)*s,this.r*Math.cos(this.inclination))}},{key:"toGeographic",value:function(){return Geographic.fromSpherical(this)}}],[{key:"fromCartesian",value:function(v){var r=v.norm(),inclination=zero(r)?0:Math.acos(v[2]/r),azimuth=Math.atan2(v[1],v[0]);return new Spherical(r,inclination,azimuth)}},{key:"fromGeographic",value:function(g){return g.toSpherical()}}]),Spherical}(),Geographic=function(){function Geographic(r,longitude,latitude){_classCallCheck(this,Geographic),this.r=r,this.longitude=longitude,this.latitude=latitude}return _createClass(Geographic,[{key:"toString",value:function(){return"{Geographic "+this.r.toPrecision(3)+", "+this.longitude.toPrecision(3)+", "+this.latitude.toPrecision(3)+"}"}},{key:"toSpherical",value:function(){return new Spherical(this.r,Math.PI/2-this.latitude,this.longitude)}},{key:"toCartesian",value:function(){return this.toSpherical().toCartesian()}}],[{key:"fromSpherical",value:function(s){return new Geographic(s.r,s.azimuth,Math.PI/2-s.inclination)}},{key:"fromCartesian",value:function(v){return Geographic.fromSpherical(Spherical.fromCartesian(v))}}]),Geographic}(),Cylindrical=function(){function Cylindrical(radial,azimuth,axial){_classCallCheck(this,Cylindrical),this.radial=radial,this.azimuth=azimuth,this.axial=axial}return _createClass(Cylindrical,[{key:"toString",value:function(){return"{Cylindrical "+this.radial.toPrecision(3)+", "+this.azimuth.toPrecision(3)+", "+this.axial.toPrecision(3)+"}"}},{key:"toCartesian",value:function(){return new Vector3(this.radial*Math.cos(this.azimuth),this.radial*Math.cos(this.azmiuth),this.axial)}}],[{key:"fromCartesian",value:function(v){return new Cylindrical(Math.sqrt(v[0]*v[0]+v[1]*v[1]),Math.atan2(v[0],v[1]),v[2])}}]),Cylindrical}(),Polar=function(){function Polar(r,theta){_classCallCheck(this,Polar),this.r=r,this.theta=theta}return _createClass(Polar,[{key:"toString",value:function(){return"{Polar "+this.r.toPrecision(3)+", "+this.theta.toPrecision(3)+"}"}},{key:"toCartesian",value:function(){return new Vector2(this.r*Math.cos(this.theta),this.r*Math.sin(this.theta))}}],[{key:"fromCartesian",value:function(v){return new Polar(v.norm(),Math.atan2(v[1],v[0]))}},{key:"fromCartesianXY",value:function(x,y){return new Polar(Math.sqrt(x*x+y*y),Math.atan2(y,x))}}]),Polar}(),Sphere=function(_VisibleObject){function Sphere(){return _classCallCheck(this,Sphere),_possibleConstructorReturn(this,Object.getPrototypeOf(Sphere).apply(this,arguments))}return _inherits(Sphere,_VisibleObject),_createClass(Sphere,[{key:"closestIntersection",value:function(ray){var oray=ray.transform(this.world_to_object).normalise(),b=2*oray.origin.dot(oray.dir),c=oray.origin.normSquared()-1,det=b*b-4*c;if(det>=0){var sdet=Math.sqrt(det),t1=(-b-sdet)/2,t2=(-b+sdet)/2;if(t2>Ray.NEAR){var t=t1>Ray.NEAR?t1:t2;return new Intersection(oray,this,t,null,this.material)}return null}return null}},{key:"intersections",value:function(ray){var oray=ray.transform(this.world_to_object).normalise(),b=2*oray.origin.dot(oray.dir),c=oray.origin.normSquared()-1,det=b*b-4*c,res=[];if(det>=0){var sdet=Math.sqrt(det),t1=(-b-sdet)/2,t2=(-b+sdet)/2;t1>Ray.NEAR&&res.push(new Intersection(oray,this,t1,null,this.material)),t2>Ray.NEAR&&res.push(new Intersection(oray,this,t2,null,this.material))}return res}},{key:"containsObject",value:function(pos_object){return pos_object.normSquared()<=1}},{key:"uvAtPoint",value:function(point){var geo=Geographic.fromCartesian(point);return new Vector2(2*geo.longitude/Math.PI,2*geo.latitude/Math.PI)}},{key:"normalAtPoint",value:function(point){return point}},{key:"place",value:function(pos,radius){this.resetTransform(),this.scale(radius),this.translate(pos)}}]),Sphere}(VisibleObject),Plane=function(_VisibleObject2){function Plane(point,normal){var t2dRef=arguments.length<=2||void 0===arguments[2]?null:arguments[2];_classCallCheck(this,Plane);var _this2=_possibleConstructorReturn(this,Object.getPrototypeOf(Plane).call(this));return _this2.point=point,_this2.normal=normal.unit(),_this2.t2dRef=t2dRef,_this2.np=normal.dot(point),_this2.t2dBasis=null,_this2}return _inherits(Plane,_VisibleObject2),_createClass(Plane,[{key:"closestIntersection",value:function(ray){var oray=ray.transform(this.world_to_object).normalise(),nd=this.normal.dot(oray.dir);if(zero(nd))return null;var t=(this.np-this.normal.dot(oray.origin))/nd;return t>Ray.NEAR?new Intersection(oray,this,t,null,this.material,null,this.normal):null}},{key:"intersections",value:function(ray){var ci=this.closestIntersection(ray);return null!==ci?[ci]:[]}},{key:"containsObject",value:function(pos_object){return this.normal.dot(pos_object)<=this.np}},{key:"uvAtPoint",value:function(point){if(null===this.t2dBasis){var u=this.t2dRef?this.projectVector(this.t2dRef).unit():this.normal.parallel(XAxis3D)?YAxis3D:XAxis3D,v=Vector3.cross(this.normal,u).reverse();this.t2dBasis={u:u,v:v}}return new Vector2(this.t2dBasis.u.dot(point),this.t2dBasis.v.dot(point))}},{key:"normalAtPoint",value:function(point){return this.normal}},{key:"projectVector",value:function(v){return v.subtract(v.vectorProjection(this.normal))}}]),Plane}(VisibleObject),LevelPlane=function(_VisibleObject3){function LevelPlane(){return _classCallCheck(this,LevelPlane),_possibleConstructorReturn(this,Object.getPrototypeOf(LevelPlane).apply(this,arguments))}return _inherits(LevelPlane,_VisibleObject3),_createClass(LevelPlane,[{key:"closestIntersection",value:function(ray){var oray=ray.transform(this.world_to_object).normalise(),t=-oray.origin[2]/oray.dir[2];return t>Ray.NEAR?new Intersection(oray,this,t,null,this.material,null,LevelPlane.NORMAL):null}},{key:"intersections",value:function(ray){var ci=this.closestIntersection(ray);return null!==ci?[ci]:[]}},{key:"containsObject",value:function(pos_object){return pos_object[2]<=0}},{key:"uvAtPoint",value:function(point){return new Vector2(point[0],point[1])}},{key:"normalAtPoint",value:function(point){return LevelPlane.NORMAL}}]),LevelPlane}(VisibleObject);LevelPlane.NORMAL=new Vector3(0,0,1);var InfiniteCylinder=function(_VisibleObject4){function InfiniteCylinder(){return _classCallCheck(this,InfiniteCylinder),_possibleConstructorReturn(this,Object.getPrototypeOf(InfiniteCylinder).apply(this,arguments))}return _inherits(InfiniteCylinder,_VisibleObject4),_createClass(InfiniteCylinder,[{key:"closestIntersection",value:function(ray){var oray=ray.transform(this.world_to_object).normalise(),o=oray.origin,d=oray.dir,a=d[0]*d[0]+d[1]*d[1],b=2*(o[0]*d[0]+o[1]*d[1]),c=o[0]*o[0]+o[1]*o[1]-1,det=b*b-4*a*c;if(det>=0){var sdet=Math.sqrt(det),a2=2*a,t1=(-b-sdet)/a2,t2=(-b+sdet)/a2;if(t2>Ray.NEAR){var t=t1>Ray.NEAR?t1:t2;return new Intersection(oray,this,t,null,this.material)}return null}return null}},{key:"intersections",value:function(ray){var oray=ray.transform(this.world_to_object).normalise(),o=oray.origin,d=oray.dir,a=d[0]*d[0]+d[1]*d[1],b=2*(o[0]*d[0]+o[1]*d[1]),c=o[0]*o[0]+o[1]*o[1]-1,det=b*b-4*a*c,res=[];if(det>=0){var sdet=Math.sqrt(det),a2=2*a,t1=(-b-sdet)/a2,t2=(-b+sdet)/a2;t1>Ray.NEAR&&res.push(new Intersection(oray,this,t1,null,this.material)),t2>Ray.NEAR&&res.push(new Intersection(oray,this,t2,null,this.material))}return res}},{key:"containsObject",value:function(pos_object){return pos_object[0]*pos_object[0]+pos_object[1]*pos_object[1]<=1}},{key:"uvAtPoint",value:function(point){var cyl=Cylindrical.fromCartesian(point);return new Vector2(2*cyl.azimuth/Math.PI,cyl.axial)}},{key:"normalAtPoint",value:function(point){return new Vector3(point[0],point[1],0)}}]),InfiniteCylinder}(VisibleObject),Cylinder=function(_InfiniteCylinder){function Cylinder(){return _classCallCheck(this,Cylinder),_possibleConstructorReturn(this,Object.getPrototypeOf(Cylinder).apply(this,arguments))}return _inherits(Cylinder,_InfiniteCylinder),_createClass(Cylinder,[{key:"intersections",value:function(ray){var oray=ray.transform(this.world_to_object).normalise(),o=oray.origin,d=oray.dir,a=d[0]*d[0]+d[1]*d[1],b=2*(o[0]*d[0]+o[1]*d[1]),c=o[0]*o[0]+o[1]*o[1]-1,det=b*b-4*a*c,res=[];if(det>=0)for(var sdet=Math.sqrt(det),a2=2*a,ts=[(-b-sdet)/a2,(-b+sdet)/a2],i=0;i<2;i++){var t=ts[i];if(t>Ray.NEAR){var z=o[2]+t*d[2];z>=-1&&z<=1&&res.push(new Intersection(oray,this,t,null,this.material))}}return res}},{key:"containsObject",value:function(pos_object){return pos_object[2]>=-1&&pos_object[2]<=1&&pos_object[0]*pos_object[0]+pos_object[1]*pos_object[1]<=1}}]),Cylinder}(InfiniteCylinder);Cylinder.prototype.closestIntersection=VisibleObject.prototype.closestIntersection;var Cone=function(_VisibleObject5){function Cone(){var z1=arguments.length<=0||void 0===arguments[0]?-(1/0):arguments[0],z2=arguments.length<=1||void 0===arguments[1]?1/0:arguments[1];_classCallCheck(this,Cone);var _this6=_possibleConstructorReturn(this,Object.getPrototypeOf(Cone).call(this));return _this6.z1=Math.min(z1,z2),_this6.z2=Math.max(z1,z2),_this6}return _inherits(Cone,_VisibleObject5),_createClass(Cone,[{key:"intersections",value:function(ray){var oray=ray.transform(this.world_to_object).normalise(),o=oray.origin,d=oray.dir,a=d[0]*d[0]+d[1]*d[1]-d[2]*d[2],b=2*(o[0]*d[0]+o[1]*d[1]-o[2]*d[2]),c=o[0]*o[0]+o[1]*o[1]-o[2]*o[2],det=b*b-4*a*c,res=[];if(det>=0)for(var sdet=Math.sqrt(det),a2=2*a,ts=[(-b-sdet)/a2,(-b+sdet)/a2],i=0;i<2;i++){var t=ts[i];if(t>Ray.NEAR){var z=o[2]+t*d[2];z>=this.z1&&z<=this.z2&&res.push(new Intersection(oray,this,t,null,this.material))}}return res}},{key:"containsObject",value:function(pos_object){return pos_object[2]>=this.z1&&pos_object[2]<=this.z2&&pos_object[0]*pos_object[0]+pos_object[1]*pos_object[1]<=pos_object[2]*pos_object[2]}},{key:"uvAtPoint",value:function(point){var cyl=Cylindrical.fromCartesian(point);return new Vector2(2*cyl.azimuth/Math.PI,cyl.axial*Math.SQRT2)}},{key:"normalAtPoint",value:function(point){var m=Math.sqrt(point[0]*point[0]+point[1]*point[1]),z=point[2]>0?-m:point[2]<0?m:0;return new Vector3(point[0],point[1],z).unit()}}]),Cone}(VisibleObject),Material=function(){function Material(){_classCallCheck(this,Material),this.parent=null,this.t3d_texture_to_parent=Identity4,this.t3d_texture_to_anchor=Identity4,this.t3d_anchor_to_texture=Identity4,this.t2d_texture_to_parent=Identity3,this.t2d_texture_to_object=Identity3,this.t2d_object_to_texture=Identity3}return _createClass(Material,[{key:"toString",value:function(){return"{"+this.constructor.name+"}"}},{key:"getColour",value:function(intersection,world){throw new AbstractMethodError}},{key:"setParent",value:function(parent){return this.parent=parent,this.t3dUpdate(),this.t2dUpdate(),this}},{key:"t3dUpdate",value:function(){return null===this.parent?this.t3d_texture_to_anchor=this.t3d_texture_to_parent:this.t3d_texture_to_anchor=this.t3d_texture_to_parent.multiply(this.parent.t3d_texture_to_anchor),this.t3d_anchor_to_texture=this.t3d_texture_to_anchor.inverse(),this}},{key:"t3dAnchorToTexture",value:function(point){return point.transformPos(this.t3d_anchor_to_texture)}},{key:"t3dReset",value:function(){return this.t3d_texture_to_parent=Identity4,this.t3dUpdate(),this}},{key:"t3dTransform",value:function(matrix){return this.t3d_texture_to_parent=matrix.multiply(this.t3d_texture_to_parent),this.t3dUpdate(),this}},{key:"t3dTranslate",value:function(){return this.t3dTransform(translate3D.apply(void 0,arguments))}},{key:"t3dScale",value:function(){return this.t3dTransform(scale3D.apply(void 0,arguments))}},{key:"t3dRotateX",value:function(){return this.t3dTransform(rotate3DX.apply(void 0,arguments))}},{key:"t3dRotateY",value:function(){return this.t3dTransform(rotate3DY.apply(void 0,arguments))}},{key:"t3dRotateZ",value:function(){return this.t3dTransform(rotate3DZ.apply(void 0,arguments))}},{key:"t3dRotateAxis",value:function(){return this.t3dTransform(rotate3DAxis.apply(void 0,arguments))}},{key:"t3dRotateXDeg",value:function(angle){return this.t3dRotateX(deg2rad(angle))}},{key:"t3dRotateYDeg",value:function(angle){return this.t3dRotateY(deg2rad(angle))}},{key:"t3dRotateZDeg",value:function(angle){return this.t3dRotateZ(deg2rad(angle))}},{key:"t3dRotateAxisDeg",value:function(axis,angle){return this.t3dRotateAxis(axis,deg2rad(angle))}},{key:"t2dUpdate",value:function(){return null===this.parent?this.t2d_texture_to_object=this.t2d_texture_to_parent:this.t2d_texture_to_object=this.t2d_texture_to_parent.multiply(this.parent.t2d_texture_to_object),this.t2d_object_to_texture=this.t2d_texture_to_object.inverse(),this}},{key:"t2dObjectToTexture",value:function(point){return point.transformPos(this.t2d_object_to_texture)}},{key:"t2dReset",value:function(){return this.t2d_texture_to_parent=Identity3,this.t2dUpdate(),this}},{key:"t2dTransform",value:function(matrix){return this.t2d_texture_to_parent=matrix.multiply(this.t2d_texture_to_parent),this.t2dUpdate(),this}},{key:"t2dTranslate",value:function(){return this.t2dTransform(translate2D.apply(void 0,arguments))}},{key:"t2dScale",value:function(){return this.t2dTransform(scale2D.apply(void 0,arguments))}},{key:"t2dRotate",value:function(){return this.t2dTransform(rotate2D.apply(void 0,arguments))}},{key:"t2dRotateDeg",value:function(angle){return this.t2dRotate(deg2rad(angle))}}]),Material}(),CompositeMaterial=function(_Material){function CompositeMaterial(){_classCallCheck(this,CompositeMaterial);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(CompositeMaterial).call(this));return _this.children=[],_this}return _inherits(CompositeMaterial,_Material),_createClass(CompositeMaterial,[{key:"add",value:function(material){return this.children.push(material),material.setParent(this),this}},{key:"t3dUpdate",value:function(){return _get(Object.getPrototypeOf(CompositeMaterial.prototype),"t3dUpdate",this).call(this),this.children.forEach(function(c){c.t3dUpdate()}),this}},{key:"t2dUpdate",value:function(){return _get(Object.getPrototypeOf(CompositeMaterial.prototype),"t2dUpdate",this).call(this),this.children.forEach(function(c){c.t2dUpdate()}),this}}]),CompositeMaterial}(Material),BlendedCompositeMaterial=function(_CompositeMaterial){function BlendedCompositeMaterial(){_classCallCheck(this,BlendedCompositeMaterial);var _this2=_possibleConstructorReturn(this,Object.getPrototypeOf(BlendedCompositeMaterial).call(this));_this2.material_strengths=[];for(var _len=arguments.length,children=Array(_len),_key=0;_key<_len;_key++)children[_key]=arguments[_key];return children.forEach(function(_ref){var _ref2=_slicedToArray(_ref,2),s=_ref2[0],m=_ref2[1];_this2.add(s,m)}),_this2}return _inherits(BlendedCompositeMaterial,_CompositeMaterial),_createClass(BlendedCompositeMaterial,[{key:"add",value:function(strength,material){_get(Object.getPrototypeOf(BlendedCompositeMaterial.prototype),"add",this).call(this,material),this.material_strengths.push(strength)}},{key:"getColour",value:function(intersection,world){var _this3=this;return this.children.reduce(function(colour,child,i){return blend(colour,child.getColour(intersection,world),_this3.material_strengths[i])},new RGBA(0,0,0,1))}}]),BlendedCompositeMaterial}(CompositeMaterial),Selective3DCompositeMaterial=(function(_CompositeMaterial2){function AdditiveCompositeMaterial(){_classCallCheck(this,AdditiveCompositeMaterial);var _this4=_possibleConstructorReturn(this,Object.getPrototypeOf(AdditiveCompositeMaterial).call(this));_this4.material_strengths=[];for(var _len2=arguments.length,children=Array(_len2),_key2=0;_key2<_len2;_key2++)children[_key2]=arguments[_key2];return children.forEach(function(_ref3){var _ref4=_slicedToArray(_ref3,2),s=_ref4[0],m=_ref4[1];_this4.add(s,m)}),_this4}return _inherits(AdditiveCompositeMaterial,_CompositeMaterial2),_createClass(AdditiveCompositeMaterial,[{key:"add",value:function(strength,material){_get(Object.getPrototypeOf(AdditiveCompositeMaterial.prototype),"add",this).call(this,material),this.material_strengths.push(strength)}},{key:"getColour",value:function(intersection,world){var _this5=this;return this.children.reduce(function(colour,child,i){var mcol=child.getColour(intersection,world),mstrength=_this5.material_strengths[i]*mcol.alpha();
return colour.r+=mcol.r*mstrength,colour.g+=mcol.g*mstrength,colour.b+=mcol.b*mstrength,colour.a+=mstrength,colour},new RGBA(0,0,0,1))}}]),AdditiveCompositeMaterial}(CompositeMaterial),function(_CompositeMaterial3){function Selective3DCompositeMaterial(){return _classCallCheck(this,Selective3DCompositeMaterial),_possibleConstructorReturn(this,Object.getPrototypeOf(Selective3DCompositeMaterial).apply(this,arguments))}return _inherits(Selective3DCompositeMaterial,_CompositeMaterial3),_createClass(Selective3DCompositeMaterial,[{key:"getMaterialT3D",value:function(t3d){throw new AbstractMethodError}},{key:"getColour",value:function(intersection,world){var t3d=this.t3dAnchorToTexture(intersection.getT3DAnchor()),material=this.getMaterialT3D(t3d);return material.getColour(intersection,world)}}]),Selective3DCompositeMaterial}(CompositeMaterial)),Selective2DCompositeMaterial=function(_CompositeMaterial4){function Selective2DCompositeMaterial(){return _classCallCheck(this,Selective2DCompositeMaterial),_possibleConstructorReturn(this,Object.getPrototypeOf(Selective2DCompositeMaterial).apply(this,arguments))}return _inherits(Selective2DCompositeMaterial,_CompositeMaterial4),_createClass(Selective2DCompositeMaterial,[{key:"getMaterialT2D",value:function(t2d){throw new AbstractMethodError}},{key:"getColour",value:function(intersection,world){var t2d=this.t2dObjectToTexture(intersection.getUVObject()),material=this.getMaterialT2D(t2d);return material.getColour(intersection,world)}}]),Selective2DCompositeMaterial}(CompositeMaterial),Checks2D=function(_Selective2DComposite){function Checks2D(mat1,mat2){_classCallCheck(this,Checks2D);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(Checks2D).call(this));return _this.add(mat1),_this.add(mat2),_this}return _inherits(Checks2D,_Selective2DComposite),_createClass(Checks2D,[{key:"getMaterialT2D",value:function(t2d){var det=Math.floor(t2d[0])+Math.floor(t2d[1]);return this.children[Math.abs(det%2)]}}]),Checks2D}(Selective2DCompositeMaterial),PhongMaterial=(function(_Selective2DComposite2){function Stripes2D(){_classCallCheck(this,Stripes2D);for(var _this2=_possibleConstructorReturn(this,Object.getPrototypeOf(Stripes2D).call(this)),_len=arguments.length,children=Array(_len),_key=0;_key<_len;_key++)children[_key]=arguments[_key];return children.forEach(function(c){_this2.add(c)}),_this2}return _inherits(Stripes2D,_Selective2DComposite2),_createClass(Stripes2D,[{key:"getMaterialT2D",value:function(t2d){var det=Math.floor(t2d[1]);return this.children[Math.abs(det%this.children.length)]}}]),Stripes2D}(Selective2DCompositeMaterial),function(_Selective3DComposite){function Checks3D(mat1,mat2){_classCallCheck(this,Checks3D);var _this3=_possibleConstructorReturn(this,Object.getPrototypeOf(Checks3D).call(this));return _this3.add(mat1),_this3.add(mat2),_this3}return _inherits(Checks3D,_Selective3DComposite),_createClass(Checks3D,[{key:"getMaterialT3D",value:function(t3d){var det=Math.floor(t3d[0])+Math.floor(t3d[1])+Math.floor(t3d[2]);return this.children[Math.abs(det%2)]}}]),Checks3D}(Selective3DCompositeMaterial),function(_Selective3DComposite2){function Stripes3D(){_classCallCheck(this,Stripes3D);for(var _this4=_possibleConstructorReturn(this,Object.getPrototypeOf(Stripes3D).call(this)),_len2=arguments.length,children=Array(_len2),_key2=0;_key2<_len2;_key2++)children[_key2]=arguments[_key2];return children.forEach(function(c){_this4.add(c)}),_this4}return _inherits(Stripes3D,_Selective3DComposite2),_createClass(Stripes3D,[{key:"getMaterialT3D",value:function(t3d){var det=Math.floor(t3d[2]);return this.children[Math.abs(det%this.children.length)]}}]),Stripes3D}(Selective3DCompositeMaterial),function(_Material){function PhongMaterial(){return _classCallCheck(this,PhongMaterial),_possibleConstructorReturn(this,Object.getPrototypeOf(PhongMaterial).apply(this,arguments))}return _inherits(PhongMaterial,_Material),_createClass(PhongMaterial,[{key:"getColour",value:function(intersection,world){var pos_world=intersection.getPosWorld(),t3d=this.t3dAnchorToTexture(intersection.getT3DAnchor()),t2d=this.t2dObjectToTexture(intersection.getUVObject()),pp=this.phongParamsAtPoint(t3d,t2d),ambient=world.ambient_light_strength*pp.aa,alc=world.ambient_light_colour,col=new RGB(ambient*alc.r*pp.ac.r,ambient*alc.g*pp.ac.g,ambient*alc.b*pp.ac.b);if(zero(pp.da)&&zero(pp.sa))return col;var _ret=function(){var normal=intersection.getNormalWorld();return world.lightsAtPoint(pos_world).forEach(function(_ref){var _ref2=_slicedToArray(_ref,4),lvec=(_ref2[0],_ref2[1]),ls=_ref2[2],lc=_ref2[3];if(!zero(pp.da)){var diffuse=clamp(ls*pp.da*lvec.dot(normal),0,1);zero(diffuse)||(col.r+=diffuse*pp.dc.r*lc.r,col.g+=diffuse*pp.dc.g*lc.g,col.b+=diffuse*pp.dc.b*lc.b)}if(!zero(pp.sa)){var rvvec=intersection.getReflectedWorld(),dot=clamp(rvvec.dot(lvec),0,1),specular=ls*pp.sa*Math.pow(dot,pp.shininess);zero(specular)||(col.r+=specular*pp.sc.r*lc.r,col.g+=specular*pp.sc.g*lc.g,col.b+=specular*pp.sc.b*lc.b)}}),{v:col}}();return"object"==typeof _ret?_ret.v:void 0}},{key:"phongParamsAtPoint",value:function(t3d,t2d){throw new AbstractMethodError}}]),PhongMaterial}(Material)),PhongParams=function(){function PhongParams(ambient_amount,ambient_colour,diffuse_amount,diffuse_colour,specular_amount,specular_colour,shininess){_classCallCheck(this,PhongParams),this.aa=ambient_amount,this.ac=ambient_colour,this.da=diffuse_amount,this.dc=diffuse_colour,this.sa=specular_amount,this.sc=specular_colour,this.shininess=shininess}return _createClass(PhongParams,[{key:"toString",value:function(){return"{PhongParams: ambient "+this.aa.toPrecision(3)+" "+this.ac+", diffuse "+this.da.toPrecision(3)+" "+this.dc+", specular "+this.sa.toPrecision(3)+" "+this.sc+", shininess "+this.shininess.toPrecision(3)+"}"}}]),PhongParams}(),Mirror=function(_Material){function Mirror(){var colour=arguments.length<=0||void 0===arguments[0]?White:arguments[0];_classCallCheck(this,Mirror);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(Mirror).call(this));return _this.colour=colour,_this}return _inherits(Mirror,_Material),_createClass(Mirror,[{key:"toString",value:function(){return"{"+this.constructor.name+": "+this.colour+"}"}},{key:"getColour",value:function(intersection,world){var gen=intersection.generation();if(gen<Ray.MAX_GENERATION){var pos_world=intersection.getPosWorld(),rvec=intersection.getReflectedWorld(),rray=new Ray(pos_world,rvec,gen+1),rcolour=world.rayColour(rray);return multiply(rcolour,this.colour)}return this.colour}}]),Mirror}(Material),SolidShadedMaterial=function(_Material){function SolidShadedMaterial(colour){_classCallCheck(this,SolidShadedMaterial);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(SolidShadedMaterial).call(this));return _this.colour=colour,_this}return _inherits(SolidShadedMaterial,_Material),_createClass(SolidShadedMaterial,[{key:"toString",value:function(){return"{"+this.constructor.name+": "+this.colour+"}"}},{key:"getColour",value:function(intersection,world){return this.colour}}]),SolidShadedMaterial}(Material),SolidPhongMaterial=function(_PhongMaterial){function SolidPhongMaterial(phong_params){_classCallCheck(this,SolidPhongMaterial);var _this2=_possibleConstructorReturn(this,Object.getPrototypeOf(SolidPhongMaterial).call(this));return _this2.phong_params=phong_params,_this2}return _inherits(SolidPhongMaterial,_PhongMaterial),_createClass(SolidPhongMaterial,[{key:"toString",value:function(){return"{"+this.constructor.name+": "+this.phong_params+"}"}},{key:"phongParamsAtPoint",value:function(t3d,t2d){return this.phong_params}}]),SolidPhongMaterial}(PhongMaterial),SolidMattMaterial=function(_SolidPhongMaterial){function SolidMattMaterial(colour){return _classCallCheck(this,SolidMattMaterial),_possibleConstructorReturn(this,Object.getPrototypeOf(SolidMattMaterial).call(this,new PhongParams(1,colour,1,colour,0,White,1)))}return _inherits(SolidMattMaterial,_SolidPhongMaterial),_createClass(SolidMattMaterial,[{key:"toString",value:function(){return"{"+this.constructor.name+": "+this.phong_params.dc+"}"}}]),SolidMattMaterial}(SolidPhongMaterial),SolidShinyMaterial=function(_SolidPhongMaterial2){function SolidShinyMaterial(colour){var shininess=arguments.length<=1||void 0===arguments[1]?10:arguments[1];return _classCallCheck(this,SolidShinyMaterial),_possibleConstructorReturn(this,Object.getPrototypeOf(SolidShinyMaterial).call(this,new PhongParams(1,colour,1,colour,1,White,shininess)))}return _inherits(SolidShinyMaterial,_SolidPhongMaterial2),_createClass(SolidShinyMaterial,[{key:"toString",value:function(){return"{"+this.constructor.name+": "+this.phong_params.dc+", shininess "+this.phong_params.shininess.toPrecision(3)+"}"}}]),SolidShinyMaterial}(SolidPhongMaterial),PhongMirror=function(_BlendedCompositeMate){function PhongMirror(phong_strength,phong_params){var mirror_strength=arguments.length<=2||void 0===arguments[2]?0:arguments[2],mirror_colour=arguments.length<=3||void 0===arguments[3]?White:arguments[3];_classCallCheck(this,PhongMirror);var _this5=_possibleConstructorReturn(this,Object.getPrototypeOf(PhongMirror).call(this));return _this5.add(phong_strength,new SolidPhongMaterial(phong_params)),_this5.add(mirror_strength,new Mirror(mirror_colour)),_this5}return _inherits(PhongMirror,_BlendedCompositeMate),PhongMirror}(BlendedCompositeMaterial),SolidMetallicMaterial=function(_PhongMirror){function SolidMetallicMaterial(colour){var mirror_strength=arguments.length<=1||void 0===arguments[1]?.2:arguments[1],mirror_colour=arguments.length<=2||void 0===arguments[2]?colour:arguments[2],shininess=arguments.length<=3||void 0===arguments[3]?10:arguments[3];return _classCallCheck(this,SolidMetallicMaterial),_possibleConstructorReturn(this,Object.getPrototypeOf(SolidMetallicMaterial).call(this,1,new PhongParams(1,colour,1,colour,1,White,shininess),mirror_strength,mirror_colour))}return _inherits(SolidMetallicMaterial,_PhongMirror),SolidMetallicMaterial}(PhongMirror),Blue$1=(new RGB(240/255,248/255,1),new RGB(250/255,235/255,215/255),new RGB(1,239/255,219/255),new RGB(238/255,223/255,.8),new RGB(205/255,192/255,176/255),new RGB(139/255,131/255,120/255),new RGB(127/255,1,212/255),new RGB(127/255,1,212/255),new RGB(118/255,238/255,198/255),new RGB(.4,205/255,170/255),new RGB(69/255,139/255,116/255),new RGB(240/255,1,1),new RGB(240/255,1,1),new RGB(224/255,238/255,238/255),new RGB(193/255,205/255,205/255),new RGB(131/255,139/255,139/255),new RGB(245/255,245/255,220/255),new RGB(1,228/255,196/255),new RGB(1,228/255,196/255),new RGB(238/255,213/255,183/255),new RGB(205/255,183/255,158/255),new RGB(139/255,125/255,107/255),new RGB(0,0,0),new RGB(1,235/255,205/255),new RGB(0,0,1)),Cyan$1=(new RGB(0,0,1),new RGB(0,0,238/255),new RGB(0,0,205/255),new RGB(0,0,139/255),new RGB(138/255,43/255,226/255),new RGB(165/255,42/255,42/255),new RGB(1,64/255,64/255),new RGB(238/255,59/255,59/255),new RGB(205/255,.2,.2),new RGB(139/255,35/255,35/255),new RGB(222/255,184/255,135/255),new RGB(1,211/255,155/255),new RGB(238/255,197/255,145/255),new RGB(205/255,170/255,125/255),new RGB(139/255,115/255,85/255),new RGB(95/255,158/255,160/255),new RGB(152/255,245/255,1),new RGB(142/255,229/255,238/255),new RGB(122/255,197/255,205/255),new RGB(83/255,134/255,139/255),new RGB(127/255,1,0),new RGB(127/255,1,0),new RGB(118/255,238/255,0),new RGB(.4,205/255,0),new RGB(69/255,139/255,0),new RGB(210/255,105/255,30/255),new RGB(1,127/255,36/255),new RGB(238/255,118/255,33/255),new RGB(205/255,.4,29/255),new RGB(139/255,69/255,19/255),new RGB(1,127/255,80/255),new RGB(1,114/255,86/255),new RGB(238/255,106/255,80/255),new RGB(205/255,91/255,69/255),new RGB(139/255,62/255,47/255),new RGB(100/255,149/255,237/255),new RGB(1,248/255,220/255),new RGB(1,248/255,220/255),new RGB(238/255,232/255,205/255),new RGB(205/255,200/255,177/255),new RGB(139/255,136/255,120/255),new RGB(0,1,1)),DeepSkyBlue=(new RGB(0,1,1),new RGB(0,238/255,238/255),new RGB(0,205/255,205/255),new RGB(0,139/255,139/255),new RGB(0,0,139/255),new RGB(0,139/255,139/255),new RGB(184/255,134/255,11/255),new RGB(1,185/255,15/255),new RGB(238/255,173/255,14/255),new RGB(205/255,149/255,12/255),new RGB(139/255,101/255,8/255),new RGB(0,100/255,0),new RGB(169/255,169/255,169/255),new RGB(189/255,183/255,107/255),new RGB(139/255,0,139/255),new RGB(85/255,107/255,47/255),new RGB(202/255,1,112/255),new RGB(188/255,238/255,104/255),new RGB(162/255,205/255,90/255),new RGB(110/255,139/255,61/255),new RGB(1,140/255,0),new RGB(1,127/255,0),new RGB(238/255,118/255,0),new RGB(205/255,.4,0),new RGB(139/255,69/255,0),new RGB(.6,50/255,.8),new RGB(191/255,62/255,1),new RGB(178/255,58/255,238/255),new RGB(154/255,50/255,205/255),new RGB(104/255,34/255,139/255),new RGB(139/255,0,0),new RGB(233/255,150/255,122/255),new RGB(143/255,188/255,143/255),new RGB(193/255,1,193/255),new RGB(180/255,238/255,180/255),new RGB(155/255,205/255,155/255),new RGB(105/255,139/255,105/255),new RGB(72/255,61/255,139/255),new RGB(47/255,79/255,79/255),new RGB(151/255,1,1),new RGB(141/255,238/255,238/255),new RGB(121/255,205/255,205/255),new RGB(82/255,139/255,139/255),new RGB(0,206/255,209/255),new RGB(148/255,0,211/255),new RGB(215/255,7/255,81/255),new RGB(1,20/255,147/255),new RGB(1,20/255,147/255),new RGB(238/255,18/255,137/255),new RGB(205/255,16/255,118/255),new RGB(139/255,10/255,80/255),new RGB(0,191/255,1)),Green$1=(new RGB(0,191/255,1),new RGB(0,178/255,238/255),new RGB(0,154/255,205/255),new RGB(0,104/255,139/255),new RGB(105/255,105/255,105/255),new RGB(30/255,144/255,1),new RGB(30/255,144/255,1),new RGB(28/255,134/255,238/255),new RGB(24/255,116/255,205/255),new RGB(16/255,78/255,139/255),new RGB(178/255,34/255,34/255),new RGB(1,48/255,48/255),new RGB(238/255,44/255,44/255),new RGB(205/255,38/255,38/255),new RGB(139/255,26/255,26/255),new RGB(1,250/255,240/255),new RGB(34/255,139/255,34/255),new RGB(220/255,220/255,220/255),new RGB(248/255,248/255,1),new RGB(1,215/255,0),new RGB(1,215/255,0),new RGB(238/255,201/255,0),new RGB(205/255,173/255,0),new RGB(139/255,117/255,0),new RGB(218/255,165/255,32/255),new RGB(1,193/255,37/255),new RGB(238/255,180/255,34/255),new RGB(205/255,155/255,29/255),new RGB(139/255,105/255,20/255),new RGB(0,1,0)),Grey20=(new RGB(0,1,0),new RGB(0,238/255,0),new RGB(0,205/255,0),new RGB(0,139/255,0),new RGB(173/255,1,47/255),new RGB(190/255,190/255,190/255),new RGB(0,0,0),new RGB(3/255,3/255,3/255),new RGB(26/255,26/255,26/255),new RGB(1,1,1),new RGB(28/255,28/255,28/255),new RGB(31/255,31/255,31/255),new RGB(33/255,33/255,33/255),new RGB(36/255,36/255,36/255),new RGB(38/255,38/255,38/255),new RGB(41/255,41/255,41/255),new RGB(43/255,43/255,43/255),new RGB(46/255,46/255,46/255),new RGB(48/255,48/255,48/255),new RGB(5/255,5/255,5/255),new RGB(.2,.2,.2)),Grey80=(new RGB(54/255,54/255,54/255),new RGB(56/255,56/255,56/255),new RGB(59/255,59/255,59/255),new RGB(61/255,61/255,61/255),new RGB(64/255,64/255,64/255),new RGB(66/255,66/255,66/255),new RGB(69/255,69/255,69/255),new RGB(71/255,71/255,71/255),new RGB(74/255,74/255,74/255),new RGB(8/255,8/255,8/255),new RGB(77/255,77/255,77/255),new RGB(79/255,79/255,79/255),new RGB(82/255,82/255,82/255),new RGB(84/255,84/255,84/255),new RGB(87/255,87/255,87/255),new RGB(89/255,89/255,89/255),new RGB(92/255,92/255,92/255),new RGB(94/255,94/255,94/255),new RGB(97/255,97/255,97/255),new RGB(99/255,99/255,99/255),new RGB(10/255,10/255,10/255),new RGB(.4,.4,.4),new RGB(105/255,105/255,105/255),new RGB(107/255,107/255,107/255),new RGB(110/255,110/255,110/255),new RGB(112/255,112/255,112/255),new RGB(115/255,115/255,115/255),new RGB(117/255,117/255,117/255),new RGB(120/255,120/255,120/255),new RGB(122/255,122/255,122/255),new RGB(125/255,125/255,125/255),new RGB(13/255,13/255,13/255),new RGB(127/255,127/255,127/255),new RGB(130/255,130/255,130/255),new RGB(133/255,133/255,133/255),new RGB(135/255,135/255,135/255),new RGB(138/255,138/255,138/255),new RGB(140/255,140/255,140/255),new RGB(143/255,143/255,143/255),new RGB(145/255,145/255,145/255),new RGB(148/255,148/255,148/255),new RGB(150/255,150/255,150/255),new RGB(15/255,15/255,15/255),new RGB(.6,.6,.6),new RGB(156/255,156/255,156/255),new RGB(158/255,158/255,158/255),new RGB(161/255,161/255,161/255),new RGB(163/255,163/255,163/255),new RGB(166/255,166/255,166/255),new RGB(168/255,168/255,168/255),new RGB(171/255,171/255,171/255),new RGB(173/255,173/255,173/255),new RGB(176/255,176/255,176/255),new RGB(18/255,18/255,18/255),new RGB(179/255,179/255,179/255),new RGB(181/255,181/255,181/255),new RGB(184/255,184/255,184/255),new RGB(186/255,186/255,186/255),new RGB(189/255,189/255,189/255),new RGB(191/255,191/255,191/255),new RGB(194/255,194/255,194/255),new RGB(196/255,196/255,196/255),new RGB(199/255,199/255,199/255),new RGB(201/255,201/255,201/255),new RGB(20/255,20/255,20/255),new RGB(.8,.8,.8)),Magenta$1=(new RGB(207/255,207/255,207/255),new RGB(209/255,209/255,209/255),new RGB(212/255,212/255,212/255),new RGB(214/255,214/255,214/255),new RGB(217/255,217/255,217/255),new RGB(219/255,219/255,219/255),new RGB(222/255,222/255,222/255),new RGB(224/255,224/255,224/255),new RGB(227/255,227/255,227/255),new RGB(23/255,23/255,23/255),new RGB(229/255,229/255,229/255),new RGB(232/255,232/255,232/255),new RGB(235/255,235/255,235/255),new RGB(237/255,237/255,237/255),new RGB(240/255,240/255,240/255),new RGB(242/255,242/255,242/255),new RGB(245/255,245/255,245/255),new RGB(247/255,247/255,247/255),new RGB(250/255,250/255,250/255),new RGB(252/255,252/255,252/255),new RGB(240/255,1,240/255),new RGB(240/255,1,240/255),new RGB(224/255,238/255,224/255),new RGB(193/255,205/255,193/255),new RGB(131/255,139/255,131/255),new RGB(1,105/255,180/255),new RGB(1,110/255,180/255),new RGB(238/255,106/255,167/255),new RGB(205/255,96/255,144/255),new RGB(139/255,58/255,98/255),new RGB(205/255,92/255,92/255),new RGB(1,106/255,106/255),new RGB(238/255,99/255,99/255),new RGB(205/255,85/255,85/255),new RGB(139/255,58/255,58/255),new RGB(1,1,240/255),new RGB(1,1,240/255),new RGB(238/255,238/255,224/255),new RGB(205/255,205/255,193/255),new RGB(139/255,139/255,131/255),new RGB(240/255,230/255,140/255),new RGB(1,246/255,143/255),new RGB(238/255,230/255,133/255),new RGB(205/255,198/255,115/255),new RGB(139/255,134/255,78/255),new RGB(230/255,230/255,250/255),new RGB(1,240/255,245/255),new RGB(1,240/255,245/255),new RGB(238/255,224/255,229/255),new RGB(205/255,193/255,197/255),new RGB(139/255,131/255,134/255),new RGB(124/255,252/255,0),new RGB(1,250/255,205/255),new RGB(1,250/255,205/255),new RGB(238/255,233/255,191/255),new RGB(205/255,201/255,165/255),new RGB(139/255,137/255,112/255),new RGB(173/255,216/255,230/255),new RGB(191/255,239/255,1),new RGB(178/255,223/255,238/255),new RGB(154/255,192/255,205/255),new RGB(104/255,131/255,139/255),new RGB(240/255,128/255,128/255),new RGB(224/255,1,1),new RGB(224/255,1,1),new RGB(209/255,238/255,238/255),new RGB(180/255,205/255,205/255),new RGB(122/255,139/255,139/255),new RGB(238/255,221/255,130/255),new RGB(1,236/255,139/255),new RGB(238/255,220/255,130/255),new RGB(205/255,190/255,112/255),new RGB(139/255,129/255,76/255),new RGB(250/255,250/255,210/255),new RGB(144/255,238/255,144/255),new RGB(211/255,211/255,211/255),new RGB(1,182/255,193/255),new RGB(1,174/255,185/255),new RGB(238/255,162/255,173/255),new RGB(205/255,140/255,149/255),new RGB(139/255,95/255,101/255),new RGB(1,160/255,122/255),new RGB(1,160/255,122/255),new RGB(238/255,149/255,114/255),new RGB(205/255,129/255,98/255),new RGB(139/255,87/255,66/255),new RGB(32/255,178/255,170/255),new RGB(135/255,206/255,250/255),new RGB(176/255,226/255,1),new RGB(164/255,211/255,238/255),new RGB(141/255,182/255,205/255),new RGB(96/255,123/255,139/255),new RGB(132/255,112/255,1),new RGB(119/255,136/255,.6),new RGB(176/255,196/255,222/255),new RGB(202/255,225/255,1),new RGB(188/255,210/255,238/255),new RGB(162/255,181/255,205/255),new RGB(110/255,123/255,139/255),new RGB(1,1,224/255),new RGB(1,1,224/255),new RGB(238/255,238/255,209/255),new RGB(205/255,205/255,180/255),new RGB(139/255,139/255,122/255),new RGB(50/255,205/255,50/255),new RGB(250/255,240/255,230/255),new RGB(1,0,1)),MidnightBlue=(new RGB(1,0,1),new RGB(238/255,0,238/255),new RGB(205/255,0,205/255),new RGB(139/255,0,139/255),new RGB(176/255,48/255,96/255),new RGB(1,52/255,179/255),new RGB(238/255,48/255,167/255),new RGB(205/255,41/255,144/255),new RGB(139/255,28/255,98/255),new RGB(.4,205/255,170/255),new RGB(0,0,205/255),new RGB(186/255,85/255,211/255),new RGB(224/255,.4,1),new RGB(209/255,95/255,238/255),new RGB(180/255,82/255,205/255),new RGB(122/255,55/255,139/255),new RGB(147/255,112/255,219/255),new RGB(171/255,130/255,1),new RGB(159/255,121/255,238/255),new RGB(137/255,104/255,205/255),new RGB(93/255,71/255,139/255),new RGB(60/255,179/255,113/255),new RGB(123/255,104/255,238/255),new RGB(0,250/255,154/255),new RGB(72/255,209/255,.8),new RGB(199/255,21/255,133/255),new RGB(25/255,25/255,112/255)),Red$1=(new RGB(245/255,1,250/255),new RGB(1,228/255,225/255),new RGB(1,228/255,225/255),new RGB(238/255,213/255,210/255),new RGB(205/255,183/255,181/255),new RGB(139/255,125/255,123/255),new RGB(1,228/255,181/255),new RGB(1,222/255,173/255),new RGB(1,222/255,173/255),new RGB(238/255,207/255,161/255),new RGB(205/255,179/255,139/255),new RGB(139/255,121/255,94/255),new RGB(0,0,128/255),new RGB(0,0,128/255),new RGB(253/255,245/255,230/255),new RGB(107/255,142/255,35/255),new RGB(192/255,1,62/255),new RGB(179/255,238/255,58/255),new RGB(154/255,205/255,50/255),new RGB(105/255,139/255,34/255),new RGB(1,165/255,0),new RGB(1,165/255,0),new RGB(238/255,154/255,0),new RGB(205/255,133/255,0),new RGB(139/255,90/255,0),new RGB(1,69/255,0),new RGB(1,69/255,0),new RGB(238/255,64/255,0),new RGB(205/255,55/255,0),new RGB(139/255,37/255,0),new RGB(218/255,112/255,214/255),new RGB(1,131/255,250/255),new RGB(238/255,122/255,233/255),new RGB(205/255,105/255,201/255),new RGB(139/255,71/255,137/255),new RGB(238/255,232/255,170/255),new RGB(152/255,251/255,152/255),new RGB(154/255,1,154/255),new RGB(144/255,238/255,144/255),new RGB(124/255,205/255,124/255),new RGB(84/255,139/255,84/255),new RGB(175/255,238/255,238/255),new RGB(187/255,1,1),new RGB(174/255,238/255,238/255),new RGB(150/255,205/255,205/255),new RGB(.4,139/255,139/255),new RGB(219/255,112/255,147/255),new RGB(1,130/255,171/255),new RGB(238/255,121/255,159/255),new RGB(205/255,104/255,137/255),new RGB(139/255,71/255,93/255),new RGB(1,239/255,213/255),new RGB(1,218/255,185/255),new RGB(1,218/255,185/255),new RGB(238/255,203/255,173/255),new RGB(205/255,175/255,149/255),new RGB(139/255,119/255,101/255),new RGB(205/255,133/255,63/255),new RGB(1,192/255,203/255),new RGB(1,181/255,197/255),new RGB(238/255,169/255,184/255),new RGB(205/255,145/255,158/255),new RGB(139/255,99/255,108/255),new RGB(221/255,160/255,221/255),new RGB(1,187/255,1),new RGB(238/255,174/255,238/255),new RGB(205/255,150/255,205/255),new RGB(139/255,.4,139/255),new RGB(176/255,224/255,230/255),new RGB(160/255,32/255,240/255),new RGB(155/255,48/255,1),new RGB(145/255,44/255,238/255),new RGB(125/255,38/255,205/255),new RGB(85/255,26/255,139/255),new RGB(1,0,0)),White$1=(new RGB(1,0,0),new RGB(238/255,0,0),new RGB(205/255,0,0),new RGB(139/255,0,0),new RGB(188/255,143/255,143/255),new RGB(1,193/255,193/255),new RGB(238/255,180/255,180/255),new RGB(205/255,155/255,155/255),new RGB(139/255,105/255,105/255),new RGB(65/255,105/255,225/255),new RGB(72/255,118/255,1),new RGB(67/255,110/255,238/255),new RGB(58/255,95/255,205/255),new RGB(39/255,64/255,139/255),new RGB(139/255,69/255,19/255),new RGB(250/255,128/255,114/255),new RGB(1,140/255,105/255),new RGB(238/255,130/255,98/255),new RGB(205/255,112/255,84/255),new RGB(139/255,76/255,57/255),new RGB(244/255,164/255,96/255),new RGB(46/255,139/255,87/255),new RGB(84/255,1,159/255),new RGB(78/255,238/255,148/255),new RGB(67/255,205/255,128/255),new RGB(46/255,139/255,87/255),new RGB(1,245/255,238/255),new RGB(1,245/255,238/255),new RGB(238/255,229/255,222/255),new RGB(205/255,197/255,191/255),new RGB(139/255,134/255,130/255),new RGB(160/255,82/255,45/255),new RGB(1,130/255,71/255),new RGB(238/255,121/255,66/255),new RGB(205/255,104/255,57/255),new RGB(139/255,71/255,38/255),new RGB(135/255,206/255,235/255),new RGB(135/255,206/255,1),new RGB(126/255,192/255,238/255),new RGB(108/255,166/255,205/255),new RGB(74/255,112/255,139/255),new RGB(106/255,90/255,205/255),new RGB(131/255,111/255,1),new RGB(122/255,103/255,238/255),new RGB(105/255,89/255,205/255),new RGB(71/255,60/255,139/255),new RGB(112/255,128/255,144/255),new RGB(198/255,226/255,1),new RGB(185/255,211/255,238/255),new RGB(159/255,182/255,205/255),new RGB(108/255,123/255,139/255),new RGB(1,250/255,250/255),new RGB(1,250/255,250/255),new RGB(238/255,233/255,233/255),new RGB(205/255,201/255,201/255),new RGB(139/255,137/255,137/255),new RGB(0,1,127/255),new RGB(0,1,127/255),new RGB(0,238/255,118/255),new RGB(0,205/255,.4),new RGB(0,139/255,69/255),new RGB(70/255,130/255,180/255),new RGB(99/255,184/255,1),new RGB(92/255,172/255,238/255),new RGB(79/255,148/255,205/255),new RGB(54/255,100/255,139/255),new RGB(210/255,180/255,140/255),new RGB(1,165/255,79/255),new RGB(238/255,154/255,73/255),new RGB(205/255,133/255,63/255),new RGB(139/255,90/255,43/255),new RGB(216/255,191/255,216/255),new RGB(1,225/255,1),new RGB(238/255,210/255,238/255),new RGB(205/255,181/255,205/255),new RGB(139/255,123/255,139/255),new RGB(1,99/255,71/255),new RGB(1,99/255,71/255),new RGB(238/255,92/255,66/255),new RGB(205/255,79/255,57/255),new RGB(139/255,54/255,38/255),new RGB(64/255,224/255,208/255),new RGB(0,245/255,1),new RGB(0,229/255,238/255),new RGB(0,197/255,205/255),new RGB(0,134/255,139/255),new RGB(238/255,130/255,238/255),new RGB(208/255,32/255,144/255),new RGB(1,62/255,150/255),new RGB(238/255,58/255,140/255),new RGB(205/255,50/255,120/255),new RGB(139/255,34/255,82/255),new RGB(245/255,222/255,179/255),new RGB(1,231/255,186/255),new RGB(238/255,216/255,174/255),new RGB(205/255,186/255,150/255),new RGB(139/255,126/255,.4),new RGB(1,1,1)),Yellow$1=(new RGB(245/255,245/255,245/255),new RGB(1,1,0)),Gradient=(new RGB(1,1,0),new RGB(238/255,238/255,0),new RGB(205/255,205/255,0),new RGB(139/255,139/255,0),new RGB(154/255,205/255,50/255),function(){function Gradient(){_classCallCheck(this,Gradient);var nodes=1===arguments.length?arguments[0]:arguments;this.segments=[];for(var i=1;i<nodes.length;i++){var n1=nodes[i-1],n2=nodes[i],_blend=void 0!==n1[2]?n1[2]:Blend.linear,mid=void 0!==n1[3]?n1[3]:.5;this.segments.push(new Segment(n1[0],n1[1],n2[0],n2[1],_blend,mid))}}return _createClass(Gradient,[{key:"toString",value:function(){return"{Gradient}"}},{key:"segment",value:function(p){for(var i=0;i<this.segments.length;i++)if(p<=this.segments[i].p2)return this.segments[i];return null}},{key:"colour",value:function(p){return this.segment(p).colour(p)}}]),Gradient}()),Segment=function(){function Segment(p1,col1,p2,col2,blend,midpoint){_classCallCheck(this,Segment),this.p1=p1,this.col1=col1,this.p2=p2,this.col2=col2,this.blend=blend,this.midpoint=midpoint,this.plen=p2-p1}return _createClass(Segment,[{key:"toString",value:function(){return"{Gradient.Segment "+this.p1.toPrecision(3)+" "+this.col1+" → "+this.p2.toPrecision(3)+" "+this.col2+" - "+this.blend+", "+this.midpoint.toPrecision(3)+"}"}},{key:"colour",value:function(p){var sp=zero(this.plen)?.5:(p-this.p1)/this.plen;return blend(this.col1,this.col2,this.blend(sp,this.midpoint))}}]),Segment}(),Blend={linear:Object.assign(function(p,midpoint){return p<=midpoint?zero(midpoint)?0:.5*p/midpoint:(p-=midpoint,midpoint=1-midpoint,zero(midpoint)?1:.5+.5*p/midpoint)},{toString:fconst("linear")}),curved:Object.assign(function(p,midpoint){return midpoint=Math.max(midpoint,EPSILON),Math.pow(p,Math.log(.5)/Math.log(midpoint))},{toString:fconst("curved")}),sine:Object.assign(function(p,midpoint){return p=Blend.linear(p,midpoint),(Math.sin(Math.PI*(p-.5))+1)/2},{toString:fconst("sine")}),sphereIncreasing:Object.assign(function(p,midpoint){return p=Blend.linear(p,midpoint)-1,Math.sqrt(1-p*p)},{toString:fconst("sphereIncreasing")}),sphereDecreasing:Object.assign(function(p,midpoint){return p=Blend.linear(p,midpoint),1-Math.sqrt(1-p*p)},{toString:fconst("sphereDecreasing")})},BlueSkyBackground=function(_ElevationGradientBac){function BlueSkyBackground(){return _classCallCheck(this,BlueSkyBackground),_possibleConstructorReturn(this,Object.getPrototypeOf(BlueSkyBackground).call(this,regular([MidnightBlue,DeepSkyBlue,MidnightBlue],Blend.sine)))}return _inherits(BlueSkyBackground,_ElevationGradientBac),BlueSkyBackground}(ElevationGradientBackground),rainbowGradient=regular([Red$1,Yellow$1,Green$1,Cyan$1,Blue$1,Magenta$1,Red$1],Blend.linear),GroundPlane=function(_LevelPlane){function GroundPlane(){_classCallCheck(this,GroundPlane);var _this2=_possibleConstructorReturn(this,Object.getPrototypeOf(GroundPlane).call(this));return _this2.setMaterial(new Checks2D(new SolidMattMaterial(Grey20),new SolidMattMaterial(Grey80))),_this2}return _inherits(GroundPlane,_LevelPlane),GroundPlane}(LevelPlane),ObjectExhibit=function(_SingleCameraParametr){function ObjectExhibit(){return _classCallCheck(this,ObjectExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(ObjectExhibit).apply(this,arguments))}return _inherits(ObjectExhibit,_SingleCameraParametr),_createClass(ObjectExhibit,[{key:"makeObject",value:function(){throw new AbstractMethodError}},{key:"defaultMaterial",value:function(){return new Checks2D(new SolidShinyMaterial(White$1),new SolidShinyMaterial(Red$1)).t2dScale(1/6)}},{key:"build",value:function(){this.world.background=new BlueSkyBackground,this.world.ambient_light_strength=.15,this.world.add(new DirectionalLight(new Vector3(1,1,(-1)))),this.object=this.makeObject(),this.object.transform(this.params.object_transform),this.world.add(this.object)}},{key:"initCamera",value:function(camera){_get(Object.getPrototypeOf(ObjectExhibit.prototype),"initCamera",this).call(this,camera),camera.translate(0,-4,0)}}],[{key:"params",value:function(){return[new Transform3D({id:"object_transform",label:"Object transformation"})].concat(_toConsumableArray(_get(Object.getPrototypeOf(ObjectExhibit),"params",this).call(this)))}}]),ObjectExhibit}(SingleCameraParametricScene),SphereExhibit=function(_ObjectExhibit){function SphereExhibit(){return _classCallCheck(this,SphereExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(SphereExhibit).apply(this,arguments))}return _inherits(SphereExhibit,_ObjectExhibit),_createClass(SphereExhibit,[{key:"makeObject",value:function(){return(new Sphere).setMaterial(this.defaultMaterial())}}],[{key:"label",value:function(){return"Sphere"}}]),SphereExhibit}(ObjectExhibit),PlaneExhibit=function(_ObjectExhibit2){function PlaneExhibit(){return _classCallCheck(this,PlaneExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(PlaneExhibit).apply(this,arguments))}return _inherits(PlaneExhibit,_ObjectExhibit2),_createClass(PlaneExhibit,[{key:"makeObject",value:function(){return new Plane(this.params.point,this.params.normal,this.params.autoT2D?null:this.params.t2dRef).setMaterial(this.defaultMaterial())}}],[{key:"label",value:function(){return"Plane"}},{key:"params",value:function(){return[new Vector({id:"point",label:"Point on plane (determines location and texture origin)",length:3,defaultValue:new Vector3(0,0,0),uiStep:.1,uiElementLabels:["x","y","z"]}),new Vector({id:"normal",label:"Normal to plane",length:3,defaultValue:new Vector3(0,1,0),uiStep:.1,uiElementLabels:["x","y","z"]}),new Boolean({id:"autoT2D",label:"Orient 2D texture automatically",defaultValue:!0}),new Vector({id:"t2dRef",label:"Reference vector for 2D texture (if not automatic)",length:3,defaultValue:new Vector3(1,0,0),uiStep:.1,uiElementLabels:["x","y","z"]})].concat(_toConsumableArray(_get(Object.getPrototypeOf(PlaneExhibit),"params",this).call(this)))}}]),PlaneExhibit}(ObjectExhibit),LevelPlaneExhibit=function(_ObjectExhibit3){function LevelPlaneExhibit(){return _classCallCheck(this,LevelPlaneExhibit),
_possibleConstructorReturn(this,Object.getPrototypeOf(LevelPlaneExhibit).apply(this,arguments))}return _inherits(LevelPlaneExhibit,_ObjectExhibit3),_createClass(LevelPlaneExhibit,[{key:"makeObject",value:function(){return(new LevelPlane).translate(new Vector3(0,0,(-2))).setMaterial(this.defaultMaterial())}}],[{key:"label",value:function(){return"Level plane"}}]),LevelPlaneExhibit}(ObjectExhibit),InfiniteCylinderExhibit=function(_ObjectExhibit4){function InfiniteCylinderExhibit(){return _classCallCheck(this,InfiniteCylinderExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(InfiniteCylinderExhibit).apply(this,arguments))}return _inherits(InfiniteCylinderExhibit,_ObjectExhibit4),_createClass(InfiniteCylinderExhibit,[{key:"makeObject",value:function(){return(new InfiniteCylinder).setMaterial(this.defaultMaterial())}}],[{key:"label",value:function(){return"Infinite cylinder"}}]),InfiniteCylinderExhibit}(ObjectExhibit),CylinderExhibit=function(_ObjectExhibit5){function CylinderExhibit(){return _classCallCheck(this,CylinderExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(CylinderExhibit).apply(this,arguments))}return _inherits(CylinderExhibit,_ObjectExhibit5),_createClass(CylinderExhibit,[{key:"makeObject",value:function(){return(new Cylinder).setMaterial(this.defaultMaterial())}}],[{key:"label",value:function(){return"Clipped cylinder"}}]),CylinderExhibit}(ObjectExhibit),InfiniteConeExhibit=function(_ObjectExhibit6){function InfiniteConeExhibit(){return _classCallCheck(this,InfiniteConeExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(InfiniteConeExhibit).apply(this,arguments))}return _inherits(InfiniteConeExhibit,_ObjectExhibit6),_createClass(InfiniteConeExhibit,[{key:"makeObject",value:function(){return(new Cone).setMaterial(this.defaultMaterial())}}],[{key:"label",value:function(){return"Infinite cone"}}]),InfiniteConeExhibit}(ObjectExhibit),ConeExhibit=function(_ObjectExhibit7){function ConeExhibit(){return _classCallCheck(this,ConeExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(ConeExhibit).apply(this,arguments))}return _inherits(ConeExhibit,_ObjectExhibit7),_createClass(ConeExhibit,[{key:"makeObject",value:function(){return new Cone((-1.5),0).translate(0,0,.75).setMaterial(this.defaultMaterial())}}],[{key:"label",value:function(){return"Cone"}}]),ConeExhibit}(ObjectExhibit),Complex=function(){function Complex(re,im){_classCallCheck(this,Complex),this.re=re||0,this.im=im||0}return _createClass(Complex,[{key:"toString",value:function(){return this.im>=0?"("+this.re.toPrecision(3)+"+"+this.im.toPrecision(3)+"i)":"("+this.re.toPrecision(3)+this.im.toPrecision(3)+"i)"}},{key:"magnitude",value:function(){return Math.sqrt(this.re*this.re+this.im*this.im)}},{key:"argument",value:function(){return Math.atan2(this.im,this.re)}},{key:"conjugate",value:function(){return new Complex(this.re,(-this.im))}},{key:"add",value:function(z){return new Complex(this.re+z.re,this.im+z.im)}},{key:"sub",value:function(z){return new Complex(this.re-z.re,this.im-z.im)}},{key:"mul",value:function(z){return new Complex(this.re*z.re-this.im*z.im,this.re*z.im+this.im*z.re)}},{key:"div",value:function(z){var d=z.re*z.re+z.im*z.im;return new Complex((this.re*z.re+this.im*z.im)/d,(this.im*z.re-this.re*z.im)/d)}},{key:"sqrt",value:function(){if(this.isReal())return new Complex.sqrtre(this.re);var rx=this.magnitude()+this.re;return new Complex(Math.sqrt(rx/2),this.im/Math.sqrt(2*rx))}},{key:"isZero",value:function(){return Math.abs(this.re)<EPSILON&&Math.abs(this.im)<EPSILON}},{key:"isReal",value:function(){return Math.abs(this.im)<EPSILON}},{key:"isImaginary",value:function(){return Math.abs(this.re)<EPSILON}},{key:"serialise",value:function(){return{re:this.re,im:this.im}}}],[{key:"sqrtre",value:function(x){return x>=0?new Complex(Math.sqrt(x),0):new Complex(0,Math.sqrt(-x))}},{key:"minReal",value:function(list){for(var min=arguments.length<=1||void 0===arguments[1]?-(1/0):arguments[1],res=1/0,i=0;i<list.length;i++){var z=list[i];z.isReal()&&z.re>=min&&z.re<res&&(res=z.re)}return res!==1/0?res:null}},{key:"unserialise",value:function(serialised){if(serialised&&"object"==typeof serialised&&"number"==typeof serialised.re&&"number"==typeof serialised.im)return new Complex(serialised.re,serialised.im);throw new TypeError("Complex.unserialise: serialised form must be an object { re, im }")}}]),Complex}(),ConditionalLevelPlane=(new Complex(0,0),new Complex(1,0),new Complex((-1),0),new Complex(0,1),new Complex(0,(-1)),function(_VisibleObject){function ConditionalUV(object,pred){_classCallCheck(this,ConditionalUV);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(ConditionalUV).call(this));return _this.setObject(object),_this.pred=pred,_this}return _inherits(ConditionalUV,_VisibleObject),_createClass(ConditionalUV,[{key:"toString",value:function(){return"{"+this.constructor.name+": "+this.object+"}"}},{key:"setObject",value:function(object){return this.object=object,object&&object.setParent(this),this}},{key:"updateWorldTransform",value:function(){return _get(Object.getPrototypeOf(ConditionalUV.prototype),"updateWorldTransform",this).call(),this.object&&this.object.updateWorldTransform(),this}},{key:"intersections",value:function(ray_world){for(var ints=this.object.intersections(ray_world),res=[],i=0;i<ints.length;i++){var mat=ints[i].getMaterial(),uvo=ints[i].getUVObject(),uvt=mat.t2dObjectToTexture(uvo);this.pred(uvt[0],uvt[1])&&res.push(ints[i])}return res}},{key:"getMaterial",value:function(){return this.object.getMaterial()}},{key:"uvAtPoint",value:function(point){var point_object=point.transformPos(this.object.parent_to_object);return this.object.uvAtPoint(point_object)}},{key:"normalAtPoint",value:function(point){var point_object=point.transformPos(this.object.parent_to_object);return this.object.normalAtPoint(point_object)}}]),ConditionalUV}(VisibleObject),function(_LevelPlane){function ConditionalLevelPlane(pred){_classCallCheck(this,ConditionalLevelPlane);var _this2=_possibleConstructorReturn(this,Object.getPrototypeOf(ConditionalLevelPlane).call(this));return _this2.pred=pred,_this2}return _inherits(ConditionalLevelPlane,_LevelPlane),_createClass(ConditionalLevelPlane,[{key:"closestIntersection",value:function(ray){var oray=ray.transform(this.world_to_object).normalise(),t=-oray.origin[2]/oray.dir[2];if(t>Ray.NEAR){var u=oray.origin[0]+t*oray.dir[0],v=oray.origin[1]+t*oray.dir[1];return this.pred(u,v)?new Intersection(oray,this,t,null,this.material,null,LevelPlane.NORMAL):null}return null}},{key:"containsObject",value:function(pos_object){return pos_object[2]<=0&&this.pred(pos_object[0],pos_object[1])}}]),ConditionalLevelPlane}(LevelPlane)),StaticLamina=function(_ConditionalLevelPlan){function StaticLamina(){_classCallCheck(this,StaticLamina);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(StaticLamina).call(this));return _this.pred=_this.constructor.predicate,_this}return _inherits(StaticLamina,_ConditionalLevelPlan),_createClass(StaticLamina,null,[{key:"predicate",value:function(u,v){throw new AbstractMethodError}}]),StaticLamina}(ConditionalLevelPlane),InstanceLamina=function(_ConditionalLevelPlan2){function InstanceLamina(){_classCallCheck(this,InstanceLamina);var _this2=_possibleConstructorReturn(this,Object.getPrototypeOf(InstanceLamina).call(this));return _this2.pred=_this2.predicate.bind(_this2),_this2}return _inherits(InstanceLamina,_ConditionalLevelPlan2),_createClass(InstanceLamina,[{key:"predicate",value:function(u,v){throw new AbstractMethodError}}]),InstanceLamina}(ConditionalLevelPlane),Square=function(_StaticLamina){function Square(){return _classCallCheck(this,Square),_possibleConstructorReturn(this,Object.getPrototypeOf(Square).apply(this,arguments))}return _inherits(Square,_StaticLamina),_createClass(Square,null,[{key:"predicate",value:function(u,v){return u>=-1&&u<=1&&v>=-1&&v<=1}}]),Square}(StaticLamina),Disc=function(_StaticLamina2){function Disc(){return _classCallCheck(this,Disc),_possibleConstructorReturn(this,Object.getPrototypeOf(Disc).apply(this,arguments))}return _inherits(Disc,_StaticLamina2),_createClass(Disc,null,[{key:"predicate",value:function(u,v){return u*u+v*v<1}}]),Disc}(StaticLamina),Triangle=function(_InstanceLamina){function Triangle(v1,v2,v3){_classCallCheck(this,Triangle);var _this5=_possibleConstructorReturn(this,Object.getPrototypeOf(Triangle).call(this));return _this5.setVertices(v1,v2,v3),_this5}return _inherits(Triangle,_InstanceLamina),_createClass(Triangle,[{key:"setVertices",value:function(v1,v2,v3){this.v1=v1,this.v2=v2,this.v3=v3,this.a0=v2.subtract(v1),this.a1=v3.subtract(v1),this.a0a0=this.a0.dot(this.a0),this.a1a1=this.a1.dot(this.a1),this.a0a1=this.a0.dot(this.a1)}},{key:"predicate",value:function(u,v){var a2=new Vector2(u-this.v1[0],v-this.v1[1]),a0a2=this.a0.dot(a2),a1a2=this.a1.dot(a2),den=this.a0a0*this.a1a1-this.a0a1*this.a0a1,x=(this.a1a1*a0a2-this.a0a1*a1a2)/den,y=(this.a0a0*a1a2-this.a0a1*a0a2)/den;return x>0&&y>0&&x+y<1}}]),Triangle}(InstanceLamina),RegularPolygon=function(_InstanceLamina2){function RegularPolygon(sides){_classCallCheck(this,RegularPolygon);var _this6=_possibleConstructorReturn(this,Object.getPrototypeOf(RegularPolygon).call(this));return _this6.setSides(sides),_this6}return _inherits(RegularPolygon,_InstanceLamina2),_createClass(RegularPolygon,[{key:"setSides",value:function(sides){this.sides=sides,this.phi=2*Math.PI/sides,this.hia=(1-2/sides)*Math.PI/2,this.sin_hia=Math.sin(this.hia)}},{key:"predicate",value:function(u,v){var p=Polar.fromCartesianXY(u,v),theta=(p.theta+2*Math.PI)%this.phi;return p.r<=this.sin_hia/Math.sin(Math.PI-this.hia-theta)}}]),RegularPolygon}(InstanceLamina),Mandelbrot=function(_StaticLamina3){function Mandelbrot(){return _classCallCheck(this,Mandelbrot),_possibleConstructorReturn(this,Object.getPrototypeOf(Mandelbrot).apply(this,arguments))}return _inherits(Mandelbrot,_StaticLamina3),_createClass(Mandelbrot,null,[{key:"predicate",value:function(u,v){for(var c=new Complex(u,v),z=new Complex(0,0),i=0;i<100;i++)if(z=z.mul(z).add(c),z.re*z.re+z.im*z.im>4)return!1;return!0}}]),Mandelbrot}(StaticLamina),SquareExhibit=function(_ObjectExhibit){function SquareExhibit(){return _classCallCheck(this,SquareExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(SquareExhibit).apply(this,arguments))}return _inherits(SquareExhibit,_ObjectExhibit),_createClass(SquareExhibit,[{key:"makeObject",value:function(){return(new Square).rotateXDeg(-90).setMaterial(this.defaultMaterial())}}],[{key:"label",value:function(){return"Square"}}]),SquareExhibit}(ObjectExhibit),DiscExhibit=function(_ObjectExhibit2){function DiscExhibit(){return _classCallCheck(this,DiscExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(DiscExhibit).apply(this,arguments))}return _inherits(DiscExhibit,_ObjectExhibit2),_createClass(DiscExhibit,[{key:"makeObject",value:function(){return(new Disc).rotateXDeg(-90).setMaterial(this.defaultMaterial())}}],[{key:"label",value:function(){return"Disc"}}]),DiscExhibit}(ObjectExhibit),TriangleExhibit=function(_ObjectExhibit3){function TriangleExhibit(){return _classCallCheck(this,TriangleExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(TriangleExhibit).apply(this,arguments))}return _inherits(TriangleExhibit,_ObjectExhibit3),_createClass(TriangleExhibit,[{key:"makeObject",value:function(){var vertices=this.params.vertices;return new Triangle(vertices.v1,vertices.v2,vertices.v3).rotateXDeg(-90).setMaterial(this.defaultMaterial())}}],[{key:"label",value:function(){return"Arbitrary triangle"}},{key:"params",value:function(){return[new ParamGroup({id:"vertices",label:"Triangle vertex coordinates",params:[new Vector({id:"v1",label:"Vertex 1",length:2,defaultValue:new Vector2((-1),(-1)),uiStep:.1,uiElementLabels:["u","v"]}),new Vector({id:"v2",label:"Vertex 2",length:2,defaultValue:new Vector2(1,(-1)),uiStep:.1,uiElementLabels:["u","v"]}),new Vector({id:"v3",label:"Vertex 3",length:2,defaultValue:new Vector2((-1),1),uiStep:.1,uiElementLabels:["u","v"]})]})].concat(_toConsumableArray(_get(Object.getPrototypeOf(TriangleExhibit),"params",this).call(this)))}}]),TriangleExhibit}(ObjectExhibit),RegularPolygonExhibit=function(_ObjectExhibit4){function RegularPolygonExhibit(){return _classCallCheck(this,RegularPolygonExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(RegularPolygonExhibit).apply(this,arguments))}return _inherits(RegularPolygonExhibit,_ObjectExhibit4),_createClass(RegularPolygonExhibit,[{key:"makeObject",value:function(){return new RegularPolygon(this.params.sides).rotateXDeg(-90).setMaterial(this.defaultMaterial())}}],[{key:"label",value:function(){return"Regular polygon"}},{key:"params",value:function(){return[new Integer({id:"sides",label:"Number of sides",defaultValue:5,min:3})].concat(_toConsumableArray(_get(Object.getPrototypeOf(RegularPolygonExhibit),"params",this).call(this)))}}]),RegularPolygonExhibit}(ObjectExhibit),MandelbrotExhibit=function(_ObjectExhibit5){function MandelbrotExhibit(){return _classCallCheck(this,MandelbrotExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(MandelbrotExhibit).apply(this,arguments))}return _inherits(MandelbrotExhibit,_ObjectExhibit5),_createClass(MandelbrotExhibit,[{key:"makeObject",value:function(){return(new Mandelbrot).rotateXDeg(-90).setMaterial(this.defaultMaterial())}}],[{key:"label",value:function(){return"Mandelbrot set lamina"}}]),MandelbrotExhibit}(ObjectExhibit),CSGRayIntersection=function(_Intersection){function CSGRayIntersection(ray_node,node,csg_child_intersection){_classCallCheck(this,CSGRayIntersection);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(CSGRayIntersection).call(this,ray_node,node,csg_child_intersection.t));return _this.csg_child_intersection=csg_child_intersection,_this.csg_child=csg_child_intersection.object,_this}return _inherits(CSGRayIntersection,_Intersection),_createClass(CSGRayIntersection,[{key:"getDistanceWorld",value:function(){return this.csg_child_intersection.getDistanceWorld()}},{key:"getPosWorld",value:function(){return this.csg_child_intersection.getPosWorld()}},{key:"getMaterial",value:function(){return this.csg_child_intersection.getMaterial()}},{key:"getUVObject",value:function(){return this.csg_child_intersection.getUVObject()}},{key:"getT3DAnchor",value:function(){return this.csg_child_intersection.getT3DAnchor()}},{key:"getNormalObject",value:function(){return this.csg_child_intersection.getNormalObject().transformDir(this.csg_child.normal_object_to_parent)}},{key:"getNormalWorld",value:function(){return this.csg_child_intersection.getNormalWorld()}}]),CSGRayIntersection}(Intersection),CSGNode=function(_VisibleObjectMixin){function CSGNode(){_classCallCheck(this,CSGNode);for(var _this2=_possibleConstructorReturn(this,Object.getPrototypeOf(CSGNode).call(this)),_len=arguments.length,children=Array(_len),_key=0;_key<_len;_key++)children[_key]=arguments[_key];return children.forEach(function(child){_this2.add(child)}),_this2}return _inherits(CSGNode,_VisibleObjectMixin),_createClass(CSGNode,[{key:"find",value:function(predicate){return predicate(this)?[this]:[]}},{key:"intersections",value:function(ray_world){throw new AbstractMethodError}},{key:"childContainsObject",value:function(index,pos_object){var child=this.children[index],pos_child=pos_object.transformPos(child.parent_to_object);return child.containsObject(pos_child)}}]),CSGNode}(VisibleObjectMixin(Group)),CSGIntersection=(function(_CSGNode){function CSGUnion(){return _classCallCheck(this,CSGUnion),_possibleConstructorReturn(this,Object.getPrototypeOf(CSGUnion).apply(this,arguments))}return _inherits(CSGUnion,_CSGNode),_createClass(CSGUnion,[{key:"containsObject",value:function(pos_object){for(var i=0;i<this.children.length;i++)if(this.childContainsObject(i,pos_object))return!0;return!1}},{key:"intersections",value:function(ray_world){for(var _this4=this,ray_node=ray_world.transform(this.world_to_object),csg_node=this,res=[],_loop=function(i){var child=_this4.children[i],child_ints=child.intersections(ray_world);if(child_ints.length>0){var csg_ints=child_ints.filter(function(intersection){for(var pos_node=intersection.getPosObject().transformPos(child.object_to_parent),j=0;j<csg_node.children.length;j++)if(i!==j&&csg_node.childContainsObject(j,pos_node))return!1;return!0}).map(function(intersection){return new CSGRayIntersection(ray_node,csg_node,intersection)});csg_ints.length>0&&(res=Intersection.listMerge(res,csg_ints))}},i=0;i<this.children.length;i++)_loop(i);return res}}]),CSGUnion}(CSGNode),function(_CSGNode2){function CSGIntersection(){return _classCallCheck(this,CSGIntersection),_possibleConstructorReturn(this,Object.getPrototypeOf(CSGIntersection).apply(this,arguments))}return _inherits(CSGIntersection,_CSGNode2),_createClass(CSGIntersection,[{key:"containsObject",value:function(pos_object){for(var i=0;i<this.children.length;i++)if(!this.childContainsObject(i,pos_object))return!1;return!0}},{key:"intersections",value:function(ray_world){for(var _this6=this,ray_node=ray_world.transform(this.world_to_object),csg_node=this,res=[],_loop2=function(i){var child=_this6.children[i],child_ints=child.intersections(ray_world);if(child_ints.length>0){var csg_ints=child_ints.filter(function(intersection){for(var pos_node=intersection.getPosObject().transformPos(child.object_to_parent),j=0;j<csg_node.children.length;j++)if(i!==j&&!csg_node.childContainsObject(j,pos_node))return!1;return!0}).map(function(intersection){return new CSGRayIntersection(ray_node,csg_node,intersection)});csg_ints.length>0&&(res=Intersection.listMerge(res,csg_ints))}},i=0;i<this.children.length;i++)_loop2(i);return res}}]),CSGIntersection}(CSGNode)),CSGClip=(function(_CSGNode3){function CSGDifference(){return _classCallCheck(this,CSGDifference),_possibleConstructorReturn(this,Object.getPrototypeOf(CSGDifference).apply(this,arguments))}return _inherits(CSGDifference,_CSGNode3),_createClass(CSGDifference,[{key:"containsObject",value:function(pos_object){if(this.childContainsObject(0,pos_object)){for(var i=1;i<this.children.length;i++)if(this.childContainsObject(i,pos_object))return!1;return!0}return!1}},{key:"intersections",value:function(ray_world){for(var _this8=this,ray_node=ray_world.transform(this.world_to_object),csg_node=this,res=[],_loop3=function(i){var child=_this8.children[i],child_ints=child.intersections(ray_world);if(child_ints.length>0){var csg_ints=child_ints.filter(function(intersection){var pos_node=intersection.getPosObject().transformPos(child.object_to_parent);if(intersection.object!==csg_node.children[0]&&!csg_node.childContainsObject(0,pos_node))return!1;for(var j=1;j<csg_node.children.length;j++)if(i!==j&&csg_node.childContainsObject(j,pos_node))return!1;return!0}).map(function(intersection){return new CSGRayIntersection(ray_node,csg_node,intersection)});csg_ints.length>0&&(res=Intersection.listMerge(res,csg_ints))}},i=0;i<this.children.length;i++)_loop3(i);return res}}]),CSGDifference}(CSGNode),function(_CSGNode4){function CSGClip(){return _classCallCheck(this,CSGClip),_possibleConstructorReturn(this,Object.getPrototypeOf(CSGClip).apply(this,arguments))}return _inherits(CSGClip,_CSGNode4),_createClass(CSGClip,[{key:"containsObject",value:function(pos_object){for(var i=0;i<this.children.length;i++)if(!this.childContainsObject(i,pos_object))return!1;return!0}},{key:"intersections",value:function(ray_world){for(var ray_node=ray_world.transform(this.world_to_object),ints=this.children[0].intersections(ray_world),res=[],i=0;i<ints.length;i++){for(var clipped=!1,pos_world=ints[i].getPosWorld(),j=1;j<this.children.length;j++)if(!this.children[j].containsWorld(pos_world)){clipped=!0;break}clipped||res.push(new CSGRayIntersection(ray_node,this,ints[i]))}return res}}]),CSGClip}(CSGNode)),Polyhedron=(function(_CSGNode5){function CSGNAryIntersection(n){var _Object$getPrototypeO;_classCallCheck(this,CSGNAryIntersection);for(var _len2=arguments.length,children=Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++)children[_key2-1]=arguments[_key2];var _this10=_possibleConstructorReturn(this,(_Object$getPrototypeO=Object.getPrototypeOf(CSGNAryIntersection)).call.apply(_Object$getPrototypeO,[this].concat(children)));return _this10.n=n,_this10}return _inherits(CSGNAryIntersection,_CSGNode5),_createClass(CSGNAryIntersection,[{key:"containsObject",value:function(pos_object){for(var count=0,i=0;i<this.children.length;i++)if(this.childContainsObject(i,pos_object)&&++count>=this.n)return!0;return!1}},{key:"intersections",value:function(ray_world){for(var _this11=this,ray_node=ray_world.transform(this.world_to_object),csg_node=this,res=[],_loop4=function(i){var child=_this11.children[i],child_ints=child.intersections(ray_world);if(child_ints.length>0){var csg_ints=child_ints.filter(function(intersection){if(1===csg_node.n)return!0;for(var pos_node=intersection.getPosObject().transformPos(child.object_to_parent),count=1,j=0;j<csg_node.children.length;j++)i!==j&&csg_node.childContainsObject(j,pos_node)&&count++;return count===csg_node.n}).map(function(intersection){return new CSGRayIntersection(ray_node,csg_node,intersection)});csg_ints.length>0&&(res=Intersection.listMerge(res,csg_ints))}},i=0;i<this.children.length;i++)_loop4(i);return res}}]),CSGNAryIntersection}(CSGNode),function(_CSGIntersection){function Polyhedron(centres){var _Object$getPrototypeO;return _classCallCheck(this,Polyhedron),_possibleConstructorReturn(this,(_Object$getPrototypeO=Object.getPrototypeOf(Polyhedron)).call.apply(_Object$getPrototypeO,[this].concat(_toConsumableArray(centres.map(function(centre){return new Plane(centre,centre)})))))}return _inherits(Polyhedron,_CSGIntersection),Polyhedron}(CSGIntersection)),Tetrahedron=function(_Polyhedron){function Tetrahedron(){_classCallCheck(this,Tetrahedron);var a=Math.sqrt(.5);return _possibleConstructorReturn(this,Object.getPrototypeOf(Tetrahedron).call(this,[new Vector3(1,0,(-a)),new Vector3((-1),0,(-a)),new Vector3(0,1,a),new Vector3(0,(-1),a)].map(function(v){return v.unit()})))}return _inherits(Tetrahedron,_Polyhedron),Tetrahedron}(Polyhedron),Cube=function(_Polyhedron2){function Cube(){return _classCallCheck(this,Cube),_possibleConstructorReturn(this,Object.getPrototypeOf(Cube).call(this,[new Vector3(1,0,0),new Vector3((-1),0,0),new Vector3(0,1,0),new Vector3(0,(-1),0),new Vector3(0,0,1),new Vector3(0,0,(-1))]))}return _inherits(Cube,_Polyhedron2),Cube}(Polyhedron),Octahedron=function(_Polyhedron3){function Octahedron(){return _classCallCheck(this,Octahedron),_possibleConstructorReturn(this,Object.getPrototypeOf(Octahedron).call(this,[new Vector3(1,1,1),new Vector3(1,1,(-1)),new Vector3(1,(-1),1),new Vector3(1,(-1),(-1)),new Vector3((-1),1,1),new Vector3((-1),1,(-1)),new Vector3((-1),(-1),1),new Vector3((-1),(-1),(-1))].map(function(v){return v.unit()})))}return _inherits(Octahedron,_Polyhedron3),Octahedron}(Polyhedron),Dodecahedron=function(_Polyhedron4){function Dodecahedron(){_classCallCheck(this,Dodecahedron);var phi=(1+Math.sqrt(5))/2;return _possibleConstructorReturn(this,Object.getPrototypeOf(Dodecahedron).call(this,[new Vector3(0,1,(+phi)),new Vector3(0,1,(-phi)),new Vector3(0,(-1),(+phi)),new Vector3(0,(-1),(-phi)),new Vector3(1,(+phi),0),new Vector3(1,(-phi),0),new Vector3((-1),(+phi),0),new Vector3((-1),(-phi),0),new Vector3((+phi),0,1),new Vector3((-phi),0,1),new Vector3((+phi),0,(-1)),new Vector3((-phi),0,(-1))].map(function(v){return v.unit()})))}return _inherits(Dodecahedron,_Polyhedron4),Dodecahedron}(Polyhedron),Icosahedron=function(_Polyhedron5){function Icosahedron(){_classCallCheck(this,Icosahedron);var phi=(1+Math.sqrt(5))/2,rphi=1/phi;return _possibleConstructorReturn(this,Object.getPrototypeOf(Icosahedron).call(this,[new Vector3(1,1,1),new Vector3(1,1,(-1)),new Vector3(1,(-1),1),new Vector3(1,(-1),(-1)),new Vector3((-1),1,1),new Vector3((-1),1,(-1)),new Vector3((-1),(-1),1),new Vector3((-1),(-1),(-1)),new Vector3(0,(+rphi),(+phi)),new Vector3(0,(+rphi),(-phi)),new Vector3(0,(-rphi),(+phi)),new Vector3(0,(-rphi),(-phi)),new Vector3((+rphi),(+phi),0),new Vector3((+rphi),(-phi),0),new Vector3((-rphi),(+phi),0),new Vector3((-rphi),(-phi),0),new Vector3((+phi),0,(+rphi)),new Vector3((+phi),0,(-rphi)),new Vector3((-phi),0,(+rphi)),new Vector3((-phi),0,(-rphi))].map(function(v){return v.unit()})))}return _inherits(Icosahedron,_Polyhedron5),Icosahedron}(Polyhedron),TetrahedronExhibit=function(_ObjectExhibit){function TetrahedronExhibit(){return _classCallCheck(this,TetrahedronExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(TetrahedronExhibit).apply(this,arguments))}return _inherits(TetrahedronExhibit,_ObjectExhibit),_createClass(TetrahedronExhibit,[{key:"makeObject",value:function(){return(new Tetrahedron).scale(.5).setMaterial(this.defaultMaterial())}}],[{key:"label",value:function(){return"Tetrahedron"}}]),TetrahedronExhibit}(ObjectExhibit),CubeExhibit=function(_ObjectExhibit2){function CubeExhibit(){return _classCallCheck(this,CubeExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(CubeExhibit).apply(this,arguments))}return _inherits(CubeExhibit,_ObjectExhibit2),_createClass(CubeExhibit,[{key:"makeObject",value:function(){return(new Cube).setMaterial(this.defaultMaterial())}}],[{key:"label",value:function(){return"Cube"}}]),CubeExhibit}(ObjectExhibit),OctahedronExhibit=function(_ObjectExhibit3){function OctahedronExhibit(){return _classCallCheck(this,OctahedronExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(OctahedronExhibit).apply(this,arguments))}return _inherits(OctahedronExhibit,_ObjectExhibit3),_createClass(OctahedronExhibit,[{key:"makeObject",value:function(){return(new Octahedron).scale(.8).setMaterial(this.defaultMaterial())}}],[{key:"label",value:function(){return"Octahedron"}}]),OctahedronExhibit}(ObjectExhibit),DodecahedronExhibit=function(_ObjectExhibit4){function DodecahedronExhibit(){return _classCallCheck(this,DodecahedronExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(DodecahedronExhibit).apply(this,arguments))}return _inherits(DodecahedronExhibit,_ObjectExhibit4),_createClass(DodecahedronExhibit,[{key:"makeObject",value:function(){return(new Dodecahedron).setMaterial(this.defaultMaterial())}}],[{key:"label",value:function(){return"Dodecahedron"}}]),DodecahedronExhibit}(ObjectExhibit),IcosahedronExhibit=function(_ObjectExhibit5){function IcosahedronExhibit(){return _classCallCheck(this,IcosahedronExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(IcosahedronExhibit).apply(this,arguments))}return _inherits(IcosahedronExhibit,_ObjectExhibit5),_createClass(IcosahedronExhibit,[{key:"makeObject",value:function(){return(new Icosahedron).setMaterial(this.defaultMaterial())}}],[{key:"label",value:function(){return"Icosahedron"}}]),IcosahedronExhibit}(ObjectExhibit),GeneralParaboloid=function(_VisibleObject){function GeneralParaboloid(d,a,b){_classCallCheck(this,GeneralParaboloid);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(GeneralParaboloid).call(this));return _this.d=d,_this.a=a,_this.b=b,_this.a2=a*a,_this.b2=b*b,_this}return _inherits(GeneralParaboloid,_VisibleObject),_createClass(GeneralParaboloid,[{key:"intersections",value:function(ray){var oray=ray.transform(this.world_to_object).normalise(),o=oray.origin,d=oray.dir,a=d[0]*d[0]/this.a2+this.d*d[1]*d[1]/this.b2,b=2*(o[0]*d[0]/this.a2+this.d*o[1]*d[1]/this.b2)-d[2],c=o[0]*o[0]/this.a2+this.d*o[1]*o[1]/this.b2-o[2],det=b*b-4*a*c,res=[];if(det>=0){var sdet=Math.sqrt(det),a2=2*a,t1=(-b-sdet)/a2,t2=(-b+sdet)/a2;t1>Ray.NEAR&&res.push(new Intersection(oray,this,t1,null,this.material)),t2>Ray.NEAR&&res.push(new Intersection(oray,this,t2,null,this.material))}return res}},{key:"containsObject",value:function(p){return p[2]>=p[0]*p[0]/this.a2+this.d*(p[1]*p[1]/this.b2)}},{key:"uvAtPoint",value:function(point){var us=Math.sqrt(this.a2*this.a2+4*point[0]*point[0]),u=this.a2*Math.log(2*point[0]+us)/4+point[0]*us/(2*this.a2)-Math.log(this.a2)/4;if(0!==this.d){var vs=Math.sqrt(this.b2*this.b2+4*point[1]*point[1]),v=this.b2*Math.log(2*point[1]+vs)/4+point[1]*vs/(2*this.b2)-Math.log(this.b2)/4;return new Vector2(u,v)}return new Vector2(u,point[1])}},{key:"normalAtPoint",value:function(point){return new Vector3(2*point[0]/this.a2,2*this.d*point[1]/this.b2,(-1)).unit()}}]),GeneralParaboloid}(VisibleObject),EllipticalParaboloid=function(_GeneralParaboloid){function EllipticalParaboloid(){var a=arguments.length<=0||void 0===arguments[0]?1:arguments[0],b=arguments.length<=1||void 0===arguments[1]?1:arguments[1];return _classCallCheck(this,EllipticalParaboloid),_possibleConstructorReturn(this,Object.getPrototypeOf(EllipticalParaboloid).call(this,1,a,b))}return _inherits(EllipticalParaboloid,_GeneralParaboloid),EllipticalParaboloid}(GeneralParaboloid),HyperbolicParaboloid=function(_GeneralParaboloid2){function HyperbolicParaboloid(){var a=arguments.length<=0||void 0===arguments[0]?1:arguments[0],b=arguments.length<=1||void 0===arguments[1]?1:arguments[1];return _classCallCheck(this,HyperbolicParaboloid),_possibleConstructorReturn(this,Object.getPrototypeOf(HyperbolicParaboloid).call(this,-1,a,b))}return _inherits(HyperbolicParaboloid,_GeneralParaboloid2),HyperbolicParaboloid}(GeneralParaboloid),ExtrudedParabola=function(_GeneralParaboloid3){function ExtrudedParabola(){var a=arguments.length<=0||void 0===arguments[0]?1:arguments[0];return _classCallCheck(this,ExtrudedParabola),_possibleConstructorReturn(this,Object.getPrototypeOf(ExtrudedParabola).call(this,0,a,1))}return _inherits(ExtrudedParabola,_GeneralParaboloid3),ExtrudedParabola}(GeneralParaboloid),GeneralHyperboloid=function(_VisibleObject){function GeneralHyperboloid(d,a,b,c){_classCallCheck(this,GeneralHyperboloid);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(GeneralHyperboloid).call(this));return _this.d=d,_this.a=a,_this.b=b,_this.c=c,_this.a2=a*a,_this.b2=b*b,_this.c2=c*c,_this}return _inherits(GeneralHyperboloid,_VisibleObject),_createClass(GeneralHyperboloid,[{key:"intersections",value:function(ray){var oray=ray.transform(this.world_to_object).normalise(),o=oray.origin,d=oray.dir,a=d[0]*d[0]/this.a2+d[1]*d[1]/this.b2-d[2]*d[2]/this.c2,b=2*(o[0]*d[0]/this.a2+o[1]*d[1]/this.b2-o[2]*d[2]/this.c2),c=o[0]*o[0]/this.a2+o[1]*o[1]/this.b2-o[2]*o[2]/this.c2-this.d,det=b*b-4*a*c,res=[];if(det>=0){var sdet=Math.sqrt(det),a2=2*a,t1=(-b-sdet)/a2,t2=(-b+sdet)/a2;t1>Ray.NEAR&&res.push(new Intersection(oray,this,t1,null,this.material)),t2>Ray.NEAR&&res.push(new Intersection(oray,this,t2,null,this.material))}return res}},{key:"containsObject",value:function(p){return p[0]*p[0]/this.a2+p[1]*p[1]/this.b2-p[2]*p[2]/this.c2<=this.d}},{key:"uvAtPoint",value:function(point){var v=Math.asinh(point[2]/this.c),cosh_v=Math.cosh(v),u=Math.atan2(point[1]/(this.b*cosh_v),point[0]/(this.a*cosh_v));return new Vector2(u,v)}},{key:"normalAtPoint",value:function(point){return new Vector3(2*point[0]/this.a2,2*point[1]/this.b2,-2*point[2]/this.c2).unit()}}]),GeneralHyperboloid}(VisibleObject),OneSurfaceHyperboloid=function(_GeneralHyperboloid){function OneSurfaceHyperboloid(){var a=arguments.length<=0||void 0===arguments[0]?1:arguments[0],b=arguments.length<=1||void 0===arguments[1]?1:arguments[1],c=arguments.length<=2||void 0===arguments[2]?1:arguments[2];return _classCallCheck(this,OneSurfaceHyperboloid),_possibleConstructorReturn(this,Object.getPrototypeOf(OneSurfaceHyperboloid).call(this,1,a,b,c))}return _inherits(OneSurfaceHyperboloid,_GeneralHyperboloid),OneSurfaceHyperboloid}(GeneralHyperboloid),TwoSurfaceHyperboloid=function(_GeneralHyperboloid2){function TwoSurfaceHyperboloid(){var a=arguments.length<=0||void 0===arguments[0]?1:arguments[0],b=arguments.length<=1||void 0===arguments[1]?1:arguments[1],c=arguments.length<=2||void 0===arguments[2]?1:arguments[2];return _classCallCheck(this,TwoSurfaceHyperboloid),_possibleConstructorReturn(this,Object.getPrototypeOf(TwoSurfaceHyperboloid).call(this,-1,a,b,c))}return _inherits(TwoSurfaceHyperboloid,_GeneralHyperboloid2),
_createClass(TwoSurfaceHyperboloid,[{key:"uvAtPoint",value:function(point){var v=Math.acosh(Math.abs(point[2]/this.c)),sinh_v=Math.sinh(v),u=Math.atan2(point[1]/(this.b*sinh_v),point[0]/(this.a*sinh_v));return new Vector2(u,v)}}]),TwoSurfaceHyperboloid}(GeneralHyperboloid),PARABOLOID_CLASSES={elliptical:EllipticalParaboloid,hyperbolic:HyperbolicParaboloid,extruded:ExtrudedParabola},ParaboloidExhibit=function(_ObjectExhibit){function ParaboloidExhibit(){return _classCallCheck(this,ParaboloidExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(ParaboloidExhibit).apply(this,arguments))}return _inherits(ParaboloidExhibit,_ObjectExhibit),_createClass(ParaboloidExhibit,[{key:"makeObject",value:function(){var ParaboloidClass=PARABOLOID_CLASSES[this.params.type],paraboloid=new ParaboloidClass(this.params.a,this.params.b).setMaterial(this.defaultMaterial());if(this.params.clip.clip){var clippingSphere=(new Sphere).scale(this.params.clip.radius);return new CSGClip(paraboloid,clippingSphere)}return paraboloid}}],[{key:"label",value:function(){return"Paraboloids"}},{key:"params",value:function(){return[new Choice({id:"type",label:"Paraboloid type",defaultValue:"elliptical",options:[{value:"elliptical",label:"Elliptical paraboloid"},{value:"hyperbolic",label:"Hyperbolic paraboloid"},{value:"extruded",label:"Extruded parabola"}]}),new Number({id:"a",label:"a (divisor of x)",defaultValue:1,uiStep:.1}),new Number({id:"b",label:"b (divisor of y)",defaultValue:1,uiStep:.1}),new ParamGroup({id:"clip",label:"Clipping",params:[new Boolean({id:"clip",label:"Clip to sphere",defaultValue:!1}),new Number({id:"radius",label:"Clipping sphere radius",defaultValue:1,min:0,uiStep:.1})]})].concat(_toConsumableArray(_get(Object.getPrototypeOf(ParaboloidExhibit),"params",this).call(this)))}}]),ParaboloidExhibit}(ObjectExhibit),HYPERBOLOID_CLASSES={"one-surface":OneSurfaceHyperboloid,"two-surfaces":TwoSurfaceHyperboloid},HyperboloidExhibit=function(_ObjectExhibit2){function HyperboloidExhibit(){return _classCallCheck(this,HyperboloidExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(HyperboloidExhibit).apply(this,arguments))}return _inherits(HyperboloidExhibit,_ObjectExhibit2),_createClass(HyperboloidExhibit,[{key:"makeObject",value:function(){var HyperboloidClass=HYPERBOLOID_CLASSES[this.params.type],hyperboloid=new HyperboloidClass(this.params.a,this.params.b,this.params.c).setMaterial(this.defaultMaterial());if(this.params.clip.clip){var clippingSphere=(new Sphere).scale(this.params.clip.radius);return new CSGClip(hyperboloid,clippingSphere)}return hyperboloid}}],[{key:"label",value:function(){return"Hyperboloids"}},{key:"params",value:function(){return[new Choice({id:"type",label:"Hyperboloid type",defaultValue:"one-surface",options:[{value:"one-surface",label:"Hyperboloid of one surface"},{value:"two-surfaces",label:"Hyperboloid of two surfaces"}]}),new Number({id:"a",label:"a (divisor of x)",defaultValue:1,uiStep:.1}),new Number({id:"b",label:"b (divisor of y)",defaultValue:1,uiStep:.1}),new Number({id:"c",label:"c (divisor of z)",defaultValue:1,uiStep:.1}),new ParamGroup({id:"clip",label:"Clipping",params:[new Boolean({id:"clip",label:"Clip to sphere",defaultValue:!1}),new Number({id:"radius",label:"Clipping sphere radius",defaultValue:1.5,min:0,uiStep:.1})]})].concat(_toConsumableArray(_get(Object.getPrototypeOf(HyperboloidExhibit),"params",this).call(this)))}}]),HyperboloidExhibit}(ObjectExhibit),PhongParamsExhibit=function(_SingleCameraParametr){function PhongParamsExhibit(){return _classCallCheck(this,PhongParamsExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(PhongParamsExhibit).apply(this,arguments))}return _inherits(PhongParamsExhibit,_SingleCameraParametr),_createClass(PhongParamsExhibit,[{key:"build",value:function(){this.world.background=new BlueSkyBackground,this.world.ambient_light_strength=this.params.lighting.ambient,this.world.add(new DirectionalLight(new Vector3(1,1,(-1)),1,this.params.lighting.colour)),this.world.add((new Sphere).setMaterial(this.material()))}},{key:"material",value:function(){var pp=new PhongParams(this.params.phong.ambientAmount,this.params.phong.ambientColour,this.params.phong.diffuseAmount,this.params.phong.diffuseColour,this.params.phong.specularAmount,this.params.phong.specularColour,this.params.phong.shininess);return new SolidPhongMaterial(pp)}},{key:"initCamera",value:function(camera){_get(Object.getPrototypeOf(PhongParamsExhibit.prototype),"initCamera",this).call(this,camera),camera.translate(0,-4,0)}}],[{key:"label",value:function(){return"Phong illumination parameters"}},{key:"params",value:function(){return[new ParamGroup({id:"phong",label:"Phong illumination parameters for material",params:[new Number({id:"ambientAmount",label:"Ambient reflection strength",defaultValue:1,min:0,max:1,uiStep:.05}),new RGB$1({id:"ambientColour",label:"Ambient reflection colour",defaultValue:White$1}),new Number({id:"diffuseAmount",label:"Diffuse reflection strength",defaultValue:1,min:0,max:1,uiStep:.05}),new RGB$1({id:"diffuseColour",label:"Diffuse reflection colour",defaultValue:White$1}),new Number({id:"specularAmount",label:"Specular reflection strength",defaultValue:1,min:0,max:1,uiStep:.05}),new RGB$1({id:"specularColour",label:"Specular reflection colour",defaultValue:White$1}),new Number({id:"shininess",label:"Shininess (for specular reflection)",defaultValue:10,min:0,max:100,uiStep:.25})]}),new ParamGroup({id:"lighting",label:"Lighting",params:[new RGB$1({id:"colour",label:"Light colour",defaultValue:White$1}),new Number({id:"ambient",label:"Ambient light level",defaultValue:.15,min:0,max:1,uiStep:.05})]})].concat(_toConsumableArray(_get(Object.getPrototypeOf(PhongParamsExhibit),"params",this).call(this)))}}]),PhongParamsExhibit}(SingleCameraParametricScene),SolidColouredMaterialExhibit=function(_SingleCameraParametr2){function SolidColouredMaterialExhibit(){return _classCallCheck(this,SolidColouredMaterialExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(SolidColouredMaterialExhibit).apply(this,arguments))}return _inherits(SolidColouredMaterialExhibit,_SingleCameraParametr2),_createClass(SolidColouredMaterialExhibit,[{key:"build",value:function(){this.world.background=new BlueSkyBackground,this.world.ambient_light_strength=this.params.ambient,this.world.add(new DirectionalLight(new Vector3(1,1,(-1)),1,this.params.lightColour)),this.world.add((new GroundPlane).translate(0,0,-1.5)),this.world.add((new Sphere).setMaterial(this.material()).scale(1.2).translate(0,0,.2))}},{key:"material",value:function(){var Material=SolidColouredMaterialExhibit.MATERIALS[this.params.material];return new Material(this.params.materialColour)}},{key:"initCamera",value:function(camera){_get(Object.getPrototypeOf(SolidColouredMaterialExhibit.prototype),"initCamera",this).call(this,camera),camera.translate(0,-4,0)}}],[{key:"label",value:function(){return"Solid coloured materials"}},{key:"params",value:function(){return[new Choice({id:"material",label:"Material type",defaultValue:"shiny",options:[{value:"solid",label:"Solid shaded (no lighting)"},{value:"matt",label:"Matt (ambient, diffuse)"},{value:"shiny",label:"Shiny (ambient, diffuse, specular)"},{value:"metallic",label:"Metallic (ambient, diffuse, specular, reflection)"},{value:"mirror",label:"Mirror (reflection only)"}]}),new RGB$1({id:"materialColour",label:"Material base colour",defaultValue:Yellow$1}),new RGB$1({id:"lightColour",label:"Light colour",defaultValue:White$1}),new Number({id:"ambient",label:"Ambient light level",defaultValue:.15,min:0,max:1,uiStep:.05})].concat(_toConsumableArray(_get(Object.getPrototypeOf(SolidColouredMaterialExhibit),"params",this).call(this)))}}]),SolidColouredMaterialExhibit}(SingleCameraParametricScene);SolidColouredMaterialExhibit.MATERIALS={solid:SolidShadedMaterial,matt:SolidMattMaterial,shiny:SolidShinyMaterial,metallic:SolidMetallicMaterial,mirror:Mirror};var TextureExhibit=function(_SingleCameraParametr){function TextureExhibit(){return _classCallCheck(this,TextureExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(TextureExhibit).apply(this,arguments))}return _inherits(TextureExhibit,_SingleCameraParametr),_createClass(TextureExhibit,[{key:"material",value:function(){throw new AbstractMethodError}},{key:"object",value:function(){return(new Cube).rotateZDeg(45).rotateXDeg(-30)}},{key:"build",value:function(){this.world.background=new BlueSkyBackground,this.world.ambient_light_strength=.15,this.world.add(new DirectionalLight(new Vector3(1,1,(-1)))),this.world.add(this.object().setMaterial(this.material()))}},{key:"initCamera",value:function(camera){_get(Object.getPrototypeOf(TextureExhibit.prototype),"initCamera",this).call(this,camera),camera.translate(0,-5,0)}}]),TextureExhibit}(SingleCameraParametricScene),Textured3DPhongMaterial=function(_PhongMaterial){function Textured3DPhongMaterial(texture){_classCallCheck(this,Textured3DPhongMaterial);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(Textured3DPhongMaterial).call(this));return _this.texture=texture,_this}return _inherits(Textured3DPhongMaterial,_PhongMaterial),_createClass(Textured3DPhongMaterial,[{key:"toString",value:function(){return"{"+this.constructor.name+": "+this.texture+"}"}},{key:"phongParamsAtPoint",value:function(t3d,t2d){return this.texture.get(t3d)}}]),Textured3DPhongMaterial}(PhongMaterial),Textured2DPhongMaterial=function(_PhongMaterial2){function Textured2DPhongMaterial(texture){_classCallCheck(this,Textured2DPhongMaterial);var _this2=_possibleConstructorReturn(this,Object.getPrototypeOf(Textured2DPhongMaterial).call(this));return _this2.texture=texture,_this2}return _inherits(Textured2DPhongMaterial,_PhongMaterial2),_createClass(Textured2DPhongMaterial,[{key:"toString",value:function(){return"{"+this.constructor.name+": "+this.texture+"}"}},{key:"phongParamsAtPoint",value:function(t3d,t2d){return this.texture.get(t2d)}}]),Textured2DPhongMaterial}(PhongMaterial),Textured3DShinyMaterial=(function(_Textured3DPhongMater){function Textured3DMattMaterial(texture){_classCallCheck(this,Textured3DMattMaterial);var _this3=_possibleConstructorReturn(this,Object.getPrototypeOf(Textured3DMattMaterial).call(this));return _this3.texture=texture,_this3}return _inherits(Textured3DMattMaterial,_Textured3DPhongMater),_createClass(Textured3DMattMaterial,[{key:"phongParamsAtPoint",value:function(t3d,t2d){var colour=this.texture.get(t3d);return new PhongParams(1,colour,1,colour,0,White,1)}}]),Textured3DMattMaterial}(Textured3DPhongMaterial),function(_Textured2DPhongMater){function Textured2DMattMaterial(texture){_classCallCheck(this,Textured2DMattMaterial);var _this4=_possibleConstructorReturn(this,Object.getPrototypeOf(Textured2DMattMaterial).call(this));return _this4.texture=texture,_this4}return _inherits(Textured2DMattMaterial,_Textured2DPhongMater),_createClass(Textured2DMattMaterial,[{key:"phongParamsAtPoint",value:function(t3d,t2d){var colour=this.texture.get(t2d);return new PhongParams(1,colour,1,colour,0,White,1)}}]),Textured2DMattMaterial}(Textured2DPhongMaterial),function(_Textured3DPhongMater2){function Textured3DShinyMaterial(texture){var shininess=arguments.length<=1||void 0===arguments[1]?10:arguments[1];_classCallCheck(this,Textured3DShinyMaterial);var _this5=_possibleConstructorReturn(this,Object.getPrototypeOf(Textured3DShinyMaterial).call(this));return _this5.texture=texture,_this5.shininess=shininess,_this5}return _inherits(Textured3DShinyMaterial,_Textured3DPhongMater2),_createClass(Textured3DShinyMaterial,[{key:"phongParamsAtPoint",value:function(t3d,t2d){var colour=this.texture.get(t3d);return new PhongParams(1,colour,1,colour,1,White,this.shininess)}}]),Textured3DShinyMaterial}(Textured3DPhongMaterial)),Textured2DShinyMaterial=function(_Textured2DPhongMater2){function Textured2DShinyMaterial(texture){var shininess=arguments.length<=1||void 0===arguments[1]?10:arguments[1];_classCallCheck(this,Textured2DShinyMaterial);var _this6=_possibleConstructorReturn(this,Object.getPrototypeOf(Textured2DShinyMaterial).call(this));return _this6.texture=texture,_this6.shininess=shininess,_this6}return _inherits(Textured2DShinyMaterial,_Textured2DPhongMater2),_createClass(Textured2DShinyMaterial,[{key:"phongParamsAtPoint",value:function(t3d,t2d){var colour=this.texture.get(t2d);return new PhongParams(1,colour,1,colour,1,White,this.shininess)}}]),Textured2DShinyMaterial}(Textured2DPhongMaterial),Texture=function(){function Texture(){_classCallCheck(this,Texture)}return _createClass(Texture,[{key:"toString",value:function(){return"{"+this.constructor.name+"}"}},{key:"get",value:function(point){throw new AbstractMethodError}}]),Texture}(),Texture2D=function(_Texture){function Texture2D(){return _classCallCheck(this,Texture2D),_possibleConstructorReturn(this,Object.getPrototypeOf(Texture2D).apply(this,arguments))}return _inherits(Texture2D,_Texture),Texture2D}(Texture),Texture3D=function(_Texture2){function Texture3D(){return _classCallCheck(this,Texture3D),_possibleConstructorReturn(this,Object.getPrototypeOf(Texture3D).apply(this,arguments))}return _inherits(Texture3D,_Texture2),Texture3D}(Texture),CompositeTexture=function(_Texture3){function CompositeTexture(){_classCallCheck(this,CompositeTexture);for(var _this3=_possibleConstructorReturn(this,Object.getPrototypeOf(CompositeTexture).call(this)),_len=arguments.length,textures=Array(_len),_key=0;_key<_len;_key++)textures[_key]=arguments[_key];return _this3.components=textures,_this3}return _inherits(CompositeTexture,_Texture3),_createClass(CompositeTexture,[{key:"add",value:function(texture){return this.components.push(texture),this}}]),CompositeTexture}(Texture),GradientTexture=(function(_Texture4){function SolidTexture(value){_classCallCheck(this,SolidTexture);var _this4=_possibleConstructorReturn(this,Object.getPrototypeOf(SolidTexture).call(this));return _this4.value=value,_this4}return _inherits(SolidTexture,_Texture4),_createClass(SolidTexture,[{key:"toString",value:function(){return"{"+this.constructor.name+": "+this.value+"}"}},{key:"get",value:function(point){return this.value}}]),SolidTexture}(Texture),function(_Texture5){function FunctionTexture(get){_classCallCheck(this,FunctionTexture);var _this5=_possibleConstructorReturn(this,Object.getPrototypeOf(FunctionTexture).call(this));return _this5.get=get,_this5}return _inherits(FunctionTexture,_Texture5),FunctionTexture}(Texture),function(_Texture6){function MapTexture(func,texture){_classCallCheck(this,MapTexture);var _this6=_possibleConstructorReturn(this,Object.getPrototypeOf(MapTexture).call(this));return _this6.func=func,_this6.texture=texture,_this6}return _inherits(MapTexture,_Texture6),_createClass(MapTexture,[{key:"get",value:function(point){return this.func(this.texture.get(point))}}]),MapTexture}(Texture),function(_Texture2D){function Transformable2DTexture(texture){var transform=arguments.length<=1||void 0===arguments[1]?Identity3:arguments[1];_classCallCheck(this,Transformable2DTexture);var _this7=_possibleConstructorReturn(this,Object.getPrototypeOf(Transformable2DTexture).call(this));return _this7.texture=texture,_this7.setTransform(transform),_this7}return _inherits(Transformable2DTexture,_Texture2D),_createClass(Transformable2DTexture,[{key:"toString",value:function(){return"{"+this.constructor.name+": "+this.texture+", "+this.transform+"}"}},{key:"get",value:function(point){return this.texture.get(point.transformPos(this.texture_to_parent))}},{key:"resetTransform",value:function(){this.parent_to_texture=Identity3,this.texture_to_parent=Identity3}},{key:"setTransform",value:function(parent_to_texture){this.parent_to_texture=parent_to_texture,this.texture_to_parent=parent_to_texture.inverse()}},{key:"transform",value:function(_transform){this.setTransform(_transform.multiply(this.parent_to_texture))}},{key:"translate",value:function(){return this.transform(translate2D.apply(void 0,arguments))}},{key:"scale",value:function(){return this.transform(scale2D.apply(void 0,arguments))}},{key:"rotate",value:function(){return this.transform(rotate2D.apply(void 0,arguments))}},{key:"rotateDeg",value:function(angle){return this.rotate(deg2rad(angle))}}]),Transformable2DTexture}(Texture2D),function(_Texture3D){function Transformable3DTexture(texture){var transform=arguments.length<=1||void 0===arguments[1]?Identity4:arguments[1];_classCallCheck(this,Transformable3DTexture);var _this8=_possibleConstructorReturn(this,Object.getPrototypeOf(Transformable3DTexture).call(this));return _this8.texture=texture,_this8.setTransform(transform),_this8}return _inherits(Transformable3DTexture,_Texture3D),_createClass(Transformable3DTexture,[{key:"toString",value:function(){return"{"+this.constructor.name+": "+this.texture+", "+this.transform+"}"}},{key:"get",value:function(point){return this.texture.get(point.transformPos(this.texture_to_parent))}},{key:"resetTransform",value:function(){return this.parent_to_texture=Identity4,this.texture_to_parent=Identity4,this}},{key:"setTransform",value:function(parent_to_texture){return this.parent_to_texture=parent_to_texture,this.texture_to_parent=parent_to_texture.inverse(),this}},{key:"transform",value:function(_transform2){return this.setTransform(_transform2.multiply(this.parent_to_texture))}},{key:"translate",value:function(){return this.transform(translate3D.apply(void 0,arguments))}},{key:"scale",value:function(){return this.transform(scale3D.apply(void 0,arguments))}},{key:"rotateX",value:function(){return this.transform(rotate3DX.apply(void 0,arguments))}},{key:"rotateY",value:function(){return this.transform(rotate3DY.apply(void 0,arguments))}},{key:"rotateZ",value:function(){return this.transform(rotate3DZ.apply(void 0,arguments))}},{key:"rotateAxis",value:function(){return this.transform(rotate3DAxis.apply(void 0,arguments))}},{key:"rotateXDeg",value:function(angle){return this.rotateX(deg2rad(angle))}},{key:"rotateYDeg",value:function(angle){return this.rotateY(deg2rad(angle))}},{key:"rotateZDeg",value:function(angle){return this.rotateZ(deg2rad(angle))}},{key:"rotateAxisDeg",value:function(axis,angle){return this.rotateAxis(axis,deg2rad(angle))}}]),Transformable3DTexture}(Texture3D),function(_CompositeTexture){function ScalarPointwiseAddTexture(){return _classCallCheck(this,ScalarPointwiseAddTexture),_possibleConstructorReturn(this,Object.getPrototypeOf(ScalarPointwiseAddTexture).apply(this,arguments))}return _inherits(ScalarPointwiseAddTexture,_CompositeTexture),_createClass(ScalarPointwiseAddTexture,[{key:"get",value:function(point){for(var res=0,i=0;i<this.components.length;i++)res+=this.components[i].get(point);return res}}]),ScalarPointwiseAddTexture}(CompositeTexture),function(_CompositeTexture2){function ScalarPointwiseMultiplyTexture(){return _classCallCheck(this,ScalarPointwiseMultiplyTexture),_possibleConstructorReturn(this,Object.getPrototypeOf(ScalarPointwiseMultiplyTexture).apply(this,arguments))}return _inherits(ScalarPointwiseMultiplyTexture,_CompositeTexture2),_createClass(ScalarPointwiseMultiplyTexture,[{key:"get",value:function(point){for(var res=1,i=0;i<this.components.length;i++)res*=this.components[i].get(point);return res}}]),ScalarPointwiseMultiplyTexture}(CompositeTexture),function(_Texture7){function ScalarMultiplyTexture(scalar,texture){_classCallCheck(this,ScalarMultiplyTexture);var _this11=_possibleConstructorReturn(this,Object.getPrototypeOf(ScalarMultiplyTexture).call(this));return _this11.scalar=scalar,_this11.texture=texture,_this11}return _inherits(ScalarMultiplyTexture,_Texture7),_createClass(ScalarMultiplyTexture,[{key:"get",value:function(point){return this.scalar*this.texture.get(point)}}]),ScalarMultiplyTexture}(Texture),function(_Texture){function GradientTexture(scalar_field,gradient){var wave=arguments.length<=2||void 0===arguments[2]?sawtooth:arguments[2];_classCallCheck(this,GradientTexture);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(GradientTexture).call(this));return _this.scalar_field=scalar_field,_this.gradient=gradient,_this.wave=wave,_this}return _inherits(GradientTexture,_Texture),_createClass(GradientTexture,[{key:"toString",value:function(){return"{GradientTexture: "+this.scalar_field+", "+this.gradient+", "+this.wave+"}"}},{key:"get",value:function(point){return this.gradient.colour(this.wave(this.scalar_field.get(point)))}}]),GradientTexture}(Texture)),Linear=function(_Texture2D){function Linear(){return _classCallCheck(this,Linear),_possibleConstructorReturn(this,Object.getPrototypeOf(Linear).apply(this,arguments))}return _inherits(Linear,_Texture2D),_createClass(Linear,[{key:"get",value:function(point){return point[0]}}]),Linear}(Texture2D),Radial=function(_Texture2D2){function Radial(){return _classCallCheck(this,Radial),_possibleConstructorReturn(this,Object.getPrototypeOf(Radial).apply(this,arguments))}return _inherits(Radial,_Texture2D2),_createClass(Radial,[{key:"get",value:function(point){return point.norm()}}]),Radial}(Texture2D),Random=function(){function Random(){var seed=arguments.length<=0||void 0===arguments[0]?null:arguments[0];_classCallCheck(this,Random),null!==seed?this.x=4294967295&seed:this.x=Math.round(4294967295*Math.random())}return _createClass(Random,[{key:"get32",value:function(){return this.x=1664525*this.x+1013904223&4294967295,this.x}},{key:"get8",value:function(){return 255&this.get32()}},{key:"getFloat",value:function(){return this.get32()/2147483648}},{key:"getFloat01",value:function(){return(this.getFloat()+1)/2}}]),Random}(),Perlin3D=function(){function Perlin3D(){var seed=arguments.length<=0||void 0===arguments[0]?null:arguments[0],roughness=arguments.length<=1||void 0===arguments[1]?.5:arguments[1],num_octaves=arguments.length<=2||void 0===arguments[2]?5:arguments[2];_classCallCheck(this,Perlin3D),this.roughness=roughness,this.num_octaves=num_octaves,this.octaves=[];for(var random=new Random(seed),amplitude=1,frequency=1,i=0;i<this.num_octaves;i++){var octave=new Octave(random);this.octaves.push([amplitude,frequency,octave]),amplitude*=this.roughness,frequency*=2}}return _createClass(Perlin3D,[{key:"get",value:function(x,y,z){for(var res=0,i=0;i<this.num_octaves;i++){var _octaves$i=_slicedToArray(this.octaves[i],3),amp=_octaves$i[0],freq=_octaves$i[1],octave=_octaves$i[2];res+=amp*octave.get(x*freq,y*freq,z*freq)}return res}}]),Perlin3D}(),Octave=function(){function Octave(){var random=arguments.length<=0||void 0===arguments[0]?new Random:arguments[0];_classCallCheck(this,Octave),this.p=new Array(512);for(var i=0;i<256;i++)this.p[i]=random.get8(),this.p[i+256]=this.p[i]}return _createClass(Octave,[{key:"get",value:function(x,y,z){var cx=255&Math.floor(x),cy=255&Math.floor(y),cz=255&Math.floor(z),rx=x-Math.floor(x),ry=y-Math.floor(y),rz=z-Math.floor(z),u=fade(rx),v=fade(ry),w=fade(rz),a=this.p[cx]+cy,aa=this.p[a]+cz,ab=this.p[a+1]+cz,b=this.p[cx+1]+cy,ba=this.p[b]+cz,bb=this.p[b+1]+cz,c1=grad(this.p[aa],rx,ry,rz),c2=grad(this.p[ba],rx-1,ry,rz),c3=grad(this.p[ab],rx,ry-1,rz),c4=grad(this.p[bb],rx-1,ry-1,rz),c5=grad(this.p[aa+1],rx,ry,rz-1),c6=grad(this.p[ba+1],rx-1,ry,rz-1),c7=grad(this.p[ab+1],rx,ry-1,rz-1),c8=grad(this.p[bb+1],rx-1,ry-1,rz-1);return lerp(lerp(lerp(c1,c2,u),lerp(c3,c4,u),v),lerp(lerp(c5,c6,u),lerp(c7,c8,u),v),w)}}]),Octave}(),Linear$1=function(_Texture3D){function Linear(){return _classCallCheck(this,Linear),_possibleConstructorReturn(this,Object.getPrototypeOf(Linear).apply(this,arguments))}return _inherits(Linear,_Texture3D),_createClass(Linear,[{key:"get",value:function(point){return point[2]}}]),Linear}(Texture3D),Spherical$1=function(_Texture3D2){function Spherical(){return _classCallCheck(this,Spherical),_possibleConstructorReturn(this,Object.getPrototypeOf(Spherical).apply(this,arguments))}return _inherits(Spherical,_Texture3D2),_createClass(Spherical,[{key:"get",value:function(point){return point.norm()}}]),Spherical}(Texture3D),Cylindrical$1=function(_Texture3D3){function Cylindrical(){return _classCallCheck(this,Cylindrical),_possibleConstructorReturn(this,Object.getPrototypeOf(Cylindrical).apply(this,arguments))}return _inherits(Cylindrical,_Texture3D3),_createClass(Cylindrical,[{key:"get",value:function(point){return Math.sqrt(point[0]*point[0]+point[1]*point[1])}}]),Cylindrical}(Texture3D),Perlin=function(_Texture3D4){function Perlin(seed,roughness,num_octaves){var sx=arguments.length<=3||void 0===arguments[3]?1:arguments[3],sy=arguments.length<=4||void 0===arguments[4]?sx:arguments[4],sz=arguments.length<=5||void 0===arguments[5]?sx:arguments[5];_classCallCheck(this,Perlin);var _this4=_possibleConstructorReturn(this,Object.getPrototypeOf(Perlin).call(this));return _this4.perlin=new Perlin3D(seed,roughness,num_octaves),_this4.sx=sx,_this4.sy=sy,_this4.sz=sz,_this4}return _inherits(Perlin,_Texture3D4),_createClass(Perlin,[{key:"get",value:function(point){return this.perlin.get(point[0]/this.sx,point[1]/this.sy,point[2]/this.sz)}}]),Perlin}(Texture3D),PerlinPerturb=function(_Texture3D5){function PerlinPerturb(texture){var strength=arguments.length<=1||void 0===arguments[1]?1:arguments[1],seed=arguments[2],roughness=arguments[3],num_octaves=arguments[4],sx=arguments[5],sy=arguments[6],sz=arguments[7];_classCallCheck(this,PerlinPerturb);var _this5=_possibleConstructorReturn(this,Object.getPrototypeOf(PerlinPerturb).call(this));return _this5.texture=texture,_this5.strength=strength,_this5.perlin=new Perlin(seed,roughness,num_octaves,sx,sy,sz),_this5}return _inherits(PerlinPerturb,_Texture3D5),_createClass(PerlinPerturb,[{key:"get",value:function(point){return this.texture.get(point)+this.strength*this.perlin.get(point)}}]),PerlinPerturb}(Texture3D),GradientTexture2DExhibit=function(_TextureExhibit){function GradientTexture2DExhibit(){return _classCallCheck(this,GradientTexture2DExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(GradientTexture2DExhibit).apply(this,arguments))}return _inherits(GradientTexture2DExhibit,_TextureExhibit),_createClass(GradientTexture2DExhibit,[{key:"material",value:function(){var Field=GradientTexture2DExhibit.FIELDS[this.params.fieldType];return new Textured2DShinyMaterial(new GradientTexture(new Field,rainbowGradient)).t2dTransform(this.params.t2dTransform)}}],[{key:"label",value:function(){return"2D gradient textures"}},{key:"params",value:function(){return[new Choice({id:"fieldType",label:"Gradient field type",defaultValue:"linear",options:[{value:"linear",label:"Linear"},{value:"radial",label:"Radial"}]}),new Transform2D({id:"t2dTransform",label:"2D texture transformation"})].concat(_toConsumableArray(_get(Object.getPrototypeOf(GradientTexture2DExhibit),"params",this).call(this)))}}]),GradientTexture2DExhibit}(TextureExhibit);GradientTexture2DExhibit.FIELDS={linear:Linear,radial:Radial};var GradientTexture3DExhibit=function(_TextureExhibit2){function GradientTexture3DExhibit(){return _classCallCheck(this,GradientTexture3DExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(GradientTexture3DExhibit).apply(this,arguments))}return _inherits(GradientTexture3DExhibit,_TextureExhibit2),_createClass(GradientTexture3DExhibit,[{key:"material",value:function(){var Field=GradientTexture3DExhibit.FIELDS[this.params.fieldType];return new Textured3DShinyMaterial(new GradientTexture(new Field,rainbowGradient)).t3dTransform(this.params.t3dTransform)}}],[{key:"label",value:function(){return"3D gradient textures"}},{key:"params",value:function(){return[new Choice({id:"fieldType",label:"Gradient field type",defaultValue:"linear",options:[{value:"linear",label:"Linear"},{value:"spherical",label:"Spherical"},{value:"cylindrical",label:"Cylindrical"}]}),new Transform3D({id:"t3dTransform",label:"3D texture transformation"})].concat(_toConsumableArray(_get(Object.getPrototypeOf(GradientTexture3DExhibit),"params",this).call(this)))}}]),GradientTexture3DExhibit}(TextureExhibit);GradientTexture3DExhibit.FIELDS={linear:Linear$1,spherical:Spherical$1,cylindrical:Cylindrical$1};var PerlinTextureExhibit=function(_TextureExhibit){function PerlinTextureExhibit(){return _classCallCheck(this,PerlinTextureExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(PerlinTextureExhibit).apply(this,arguments))}return _inherits(PerlinTextureExhibit,_TextureExhibit),_createClass(PerlinTextureExhibit,[{key:"material",value:function(){return new Textured3DShinyMaterial(new GradientTexture(new Perlin(this.params.perlin.seed,this.params.perlin.roughness,this.params.perlin.octaves),rainbowGradient)).t3dTransform(this.params.t3dTransform)}}],[{key:"label",value:function(){return"Perlin noise textures"}},{key:"params",value:function(){return[new ParamGroup({id:"perlin",label:"Perlin noise parameters",params:[new RandomSeed({id:"seed",label:"Random seed",defaultValue:1}),new Number({id:"roughness",label:"Roughness",defaultValue:.5,min:0,max:1,uiStep:.05}),new Integer({id:"octaves",label:"Number of octaves",defaultValue:5,min:1,max:12})]}),new Transform3D({id:"t3dTransform",label:"3D texture transformation"})].concat(_toConsumableArray(_get(Object.getPrototypeOf(PerlinTextureExhibit),"params",this).call(this)))}}]),PerlinTextureExhibit}(TextureExhibit),PerlinPerturbTextureExhibit=function(_TextureExhibit2){function PerlinPerturbTextureExhibit(){return _classCallCheck(this,PerlinPerturbTextureExhibit),_possibleConstructorReturn(this,Object.getPrototypeOf(PerlinPerturbTextureExhibit).apply(this,arguments))}return _inherits(PerlinPerturbTextureExhibit,_TextureExhibit2),_createClass(PerlinPerturbTextureExhibit,[{key:"material",value:function(){var BaseField=PerlinPerturbTextureExhibit.BASE_FIELDS[this.params.baseFieldType];return new Textured3DShinyMaterial(new GradientTexture(new PerlinPerturb(new BaseField,this.params.perlinStrength,this.params.perlin.seed,this.params.perlin.roughness,this.params.perlin.octaves),rainbowGradient)).t3dTransform(this.params.t3dTransform)}}],[{key:"label",value:function(){return"Perlin noise perturbation textures"}},{key:"params",value:function(){return[new Choice({id:"baseFieldType",label:"Base field",defaultValue:"linear",options:[{value:"linear",label:"Linear gradient"},{value:"spherical",label:"Spherical gradient"},{value:"cylindrical",label:"Cylindrical gradient"}]}),new Number({id:"perlinStrength",label:"Perlin noise strength",defaultValue:.5,min:0,max:1,uiStep:.05}),new ParamGroup({id:"perlin",label:"Perlin noise parameters",params:[new RandomSeed({id:"seed",label:"Random seed",defaultValue:1}),new Number({id:"roughness",label:"Roughness",defaultValue:.5,min:0,max:1,uiStep:.05}),new Integer({id:"octaves",label:"Number of octaves",defaultValue:5,min:1,max:12})]}),new Transform3D({id:"t3dTransform",label:"3D texture transformation"})].concat(_toConsumableArray(_get(Object.getPrototypeOf(PerlinPerturbTextureExhibit),"params",this).call(this)))}}]),PerlinPerturbTextureExhibit}(TextureExhibit);PerlinPerturbTextureExhibit.BASE_FIELDS={linear:Linear$1,spherical:Spherical$1,cylindrical:Cylindrical$1};var groups=[{label:"Objects",scenes:[{id:"sphere",constructor:SphereExhibit},{id:"plane",constructor:PlaneExhibit},{id:"level-plane",constructor:LevelPlaneExhibit},{id:"infinite-cylinder",constructor:InfiniteCylinderExhibit},{id:"cylinder",constructor:CylinderExhibit},{id:"infinite-cone",constructor:InfiniteConeExhibit},{id:"cone",constructor:ConeExhibit},{id:"square",constructor:SquareExhibit},{id:"disc",constructor:DiscExhibit},{id:"triangle",constructor:TriangleExhibit},{id:"regular-polygon",constructor:RegularPolygonExhibit},{id:"mandelbrot",constructor:MandelbrotExhibit},{id:"tetrahedron",constructor:TetrahedronExhibit},{id:"cube",constructor:CubeExhibit},{id:"octahedron",constructor:OctahedronExhibit},{id:"dodecahedron",constructor:DodecahedronExhibit},{id:"icosahedron",constructor:IcosahedronExhibit},{id:"paraboloids",constructor:ParaboloidExhibit},{id:"hyperboloids",constructor:HyperboloidExhibit}]},{label:"Materials and textures",scenes:[{id:"phong-params",constructor:PhongParamsExhibit},{id:"solid-coloured-materials",constructor:SolidColouredMaterialExhibit
},{id:"gradient-textures-2d",constructor:GradientTexture2DExhibit},{id:"gradient-textures-3d",constructor:GradientTexture3DExhibit},{id:"perlin-texture",constructor:PerlinTextureExhibit},{id:"perlin-perturb-texture",constructor:PerlinPerturbTextureExhibit}]}],scenesById=groups.reduce(function(scenes,group){return group.scenes.reduce(function(scenes,scene){return scenes[scene.id]=scene.constructor,scenes},scenes)},{}),_isBigEndian=void 0,Drawable=function(){function Drawable(width,height){_classCallCheck(this,Drawable),this.setDimensions(width,height)}return _createClass(Drawable,[{key:"setDimensions",value:function(width,height){this.width=width,this.height=height,width<height?(this.cs_x_tl=-1,this.cs_y_tl=height/width,this.cs_scale=2/width):(this.cs_x_tl=-width/height,this.cs_y_tl=1,this.cs_scale=2/height)}},{key:"cameraScreenCoords",value:function(x,y){return[this.cs_x_tl+x*this.cs_scale,this.cs_y_tl-y*this.cs_scale]}},{key:"fill",value:function(func){throw new AbstractMethodError}}]),Drawable}(),ImageDataDrawable=function(_Drawable){function ImageDataDrawable(){return _classCallCheck(this,ImageDataDrawable),_possibleConstructorReturn(this,Object.getPrototypeOf(ImageDataDrawable).apply(this,arguments))}return _inherits(ImageDataDrawable,_Drawable),_createClass(ImageDataDrawable,[{key:"setDimensions",value:function(width,height){_get(Object.getPrototypeOf(ImageDataDrawable.prototype),"setDimensions",this).call(this,width,height),this.image_data=new ImageData(width,height),this.image_data_array32=new Uint32Array(this.image_data.data.buffer)}},{key:"fill",value:function(func){for(var array32=this.image_data_array32,index=0,y=0;y<this.height;y++)for(var x=0;x<this.width;x++){var colour=func(x,y),r=Math.round(255*clamp(colour.r,0,1)),g=Math.round(255*clamp(colour.g,0,1)),b=Math.round(255*clamp(colour.b,0,1));array32[index++]=pixel32(r,g,b,255)}}}]),ImageDataDrawable}(Drawable),pixel32=isBigEndian()?pixel32BE:pixel32LE;onmessage=function(event){if(event.data&&event.data.render){var render=event.data.render;try{var scene=new(getSceneById(render.scene))(render.params),drawable=new ImageDataDrawable(render.dimensions.width,render.dimensions.height);scene.render(drawable,render.camera),postMessage({rendered:drawable.image_data},[drawable.image_data.data.buffer])}catch(e){console.error("Error in rendering worker:",e),postMessage({error:e.name,message:e.message})}finally{close()}}},postMessage("ready"),Object.defineProperty(exports,"__esModule",{value:!0})});